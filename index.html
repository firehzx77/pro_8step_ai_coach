<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>é—®é¢˜åˆ†æä¸è§£å†³ Â· 8æ­¥æ³•ï¼ˆAIé©±åŠ¨è‡ªåŠ©å·¥å…· Â· ä¼˜åŒ–ç‰ˆï¼‰</title>
  <style>
    :root{
      --blue-900:#0b1b4a;
      --blue-800:#102a7a;
      --blue-700:#1437a6;
      --blue-600:#1d4ed8;
      --blue-500:#2563eb;
      --blue-100:#eff6ff;
      --blue-200:#dbeafe;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#475569;
      --bg:#f3f4f6;
      --card:#ffffff;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 10px 25px rgba(15, 23, 42, 0.08);
      --radius-lg:14px;
      --radius-md:10px;
      --radius-sm:8px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg, var(--blue-900), var(--blue-700));
      color:#fff;
      padding:14px 18px;
      box-shadow:var(--shadow);
    }
    header .row{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    header h1{
      margin:0;
      font-size:18px;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:2px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.22);
    }
    .badge-dot{width:8px;height:8px;border-radius:999px;background:var(--ok);}
    .badge-dot.warn{background:var(--warn);}
    .badge-dot.bad{background:var(--bad);}

    .actions{display:flex; gap:8px; flex-wrap:wrap;}
    button,.btn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.35);
      background:rgba(255,255,255,0.08);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease, box-shadow .12s ease;
      display:inline-flex; align-items:center; gap:6px;
      user-select:none;
    }
    button:hover{transform:translateY(-1px); background:rgba(255,255,255,0.14);}
    button.primary{
      background:#fff;
      color:var(--blue-800);
      border-color:#fff;
    }
    button.primary:hover{box-shadow:0 10px 22px rgba(0,0,0,0.18);}
    button.ghost{
      background:transparent;
      border-color:rgba(255,255,255,0.35);
    }
    button:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    .container{
      max-width:1280px;
      margin:16px auto 40px;
      padding:0 16px;
    }

    .tabs{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .tabbar{
      display:flex;
      gap:0;
      background:var(--blue-100);
      border-bottom:1px solid var(--blue-200);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .tabbar::-webkit-scrollbar{height:10px;}
    .tabbar::-webkit-scrollbar-thumb{background:rgba(16,42,122,0.2); border-radius:999px;}
    .tab{
      flex:0 0 auto;
      min-width:170px;
      border:none;
      background:transparent;
      color:var(--blue-900);
      font-weight:600;
      padding:12px 14px;
      cursor:pointer;
      border-right:1px solid var(--blue-200);
      white-space:nowrap;
      text-align:left;
    }
    .tab:last-child{border-right:none;}
    .tab.active{
      background:var(--card);
      box-shadow:0 -2px 0 var(--card) inset;
      border-bottom:3px solid var(--blue-600);
    }

    .panel{display:none; padding:18px;}
    .panel.active{display:block;}

    /* worksheet-like "sheet" */
    .sheet{
      border:2px solid #9ca3af;
      border-radius:10px;
      overflow:hidden;
      background:#fff;
    }
    .sheet-header{
      background:#e5e7eb;
      padding:12px 14px;
      border-bottom:2px solid #9ca3af;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .sheet-header .title{
      font-size:22px;
      font-weight:800;
      color:#111827;
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    .sheet-header .title small{
      font-size:14px;
      font-weight:700;
      color:#374151;
    }
    .sheet-body{padding:14px;}
    .sheet-note{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.4;
    }

    .grid{display:grid; gap:12px;}
    .grid-1{grid-template-columns:1fr;}
    .grid-2{grid-template-columns:1fr;}
    .grid-3{grid-template-columns:1fr;}
    @media (min-width:980px){
      .grid-2{grid-template-columns:3fr 2fr;}
      .grid-3{grid-template-columns:repeat(3, minmax(0,1fr));}
    }

    .box{
      border:2px solid #9ca3af;
      border-radius:10px;
      overflow:hidden;
      background:#fff;
    }
    .box .box-head{
      background:#f3f4f6;
      padding:8px 10px;
      font-weight:800;
      font-size:13px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid #d1d5db;
    }
    .box .box-body{padding:10px;}
    .subtle{font-size:12px; color:var(--muted); font-weight:600;}
    label{
      display:block;
      font-size:12px;
      font-weight:800;
      margin:10px 0 6px;
      color:#111827;
    }
    textarea, input, select{
      width:100%;
      border:1px solid #d1d5db;
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      font-family:inherit;
      background:#fff;
      outline:none;
    }
    textarea{min-height:80px; resize:vertical; line-height:1.45;}
    input[type="number"]{max-width:110px;}
    input[type="date"]{max-width:180px;}
    textarea:focus, input:focus, select:focus{border-color:var(--blue-500); box-shadow:0 0 0 2px rgba(37,99,235,0.15);}

    .hint{font-size:12px;color:var(--muted); line-height:1.4;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--blue-100);
      border:1px solid var(--blue-200);
      color:var(--blue-900);
      font-size:12px;
      font-weight:700;
    }

    .ai{
      border:1px dashed var(--blue-500);
      background:var(--blue-100);
      border-radius:12px;
      padding:10px;
    }
    .ai .ai-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .ai .ai-head .left{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      font-weight:900;
      color:var(--blue-900);
    }
    .ai .ai-out{
      background:#fff;
      border:1px solid var(--blue-200);
      border-radius:10px;
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.5;
      max-height:260px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .ai .ai-status{margin-top:6px;font-size:12px;color:var(--muted);}

    .btn2{
      border:1px solid var(--blue-200);
      background:#fff;
      color:var(--blue-800);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:6px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn2:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(37,99,235,0.18);}
    .btn2.primary{
      background:var(--blue-600);
      color:#fff;
      border-color:var(--blue-600);
    }
    .btn2.primary:hover{background:var(--blue-700); border-color:var(--blue-700);}

    table{width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;}
    th,td{border:1px solid #e5e7eb; padding:8px; vertical-align:top;}
    th{background:#f3f4f6; font-weight:900; color:#111827;}
    td textarea{min-height:60px;}
    .nowrap{white-space:nowrap;}
    .right{text-align:right;}
    .center{text-align:center;}
    .small{font-size:11px;color:var(--muted);}

    .prio{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:44px;
      padding:4px 8px;
      border-radius:10px;
      font-weight:900;
      background:#fef3c7;
      border:1px solid #fde68a;
      color:#92400e;
    }
    .prio.high{background:#fee2e2; border-color:#fecaca; color:#991b1b;}
    .prio.mid{background:#ffedd5; border-color:#fed7aa; color:#9a3412;}
    .prio.low{background:#dcfce7; border-color:#bbf7d0; color:#166534;}

    .evi-ok{background:#dcfce7; border-color:#bbf7d0; color:#166534;}
    .evi-miss{background:#fee2e2; border-color:#fecaca; color:#991b1b;}

    /* Tree */
    .tree-wrap{
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      background:#fff;
      overflow:auto;
    }
    .tree{
      min-width:900px; /* allow scroll for readability */
    }
    .tree ul{
      padding-top:20px;
      position:relative;
      transition:all .2s ease;
    }
    .tree li{
      float:left;
      text-align:center;
      list-style-type:none;
      position:relative;
      padding:20px 10px 0 10px;
    }
    .tree li::before, .tree li::after{
      content:'';
      position:absolute;
      top:0;
      right:50%;
      border-top:2px solid #cbd5e1;
      width:50%;
      height:20px;
    }
    .tree li::after{
      right:auto;
      left:50%;
      border-left:2px solid #cbd5e1;
    }
    .tree li:only-child::after, .tree li:only-child::before{display:none;}
    .tree li:only-child{padding-top:0;}
    .tree li:first-child::before{border:none;}
    .tree li:last-child::after{border:none;}
    .tree ul ul::before{
      content:'';
      position:absolute;
      top:0;
      left:50%;
      border-left:2px solid #cbd5e1;
      width:0;
      height:20px;
    }
    .node{
      display:inline-block;
      max-width:260px;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid #9ca3af;
      background:#fff;
      text-align:left;
      box-shadow:0 8px 18px rgba(15,23,42,0.06);
      cursor:pointer;
      user-select:none;
    }
    .node:hover{border-color:var(--blue-600);}
    .node .node-top{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-bottom:6px;
    }
    .node .node-tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--blue-100);
      border:1px solid var(--blue-200);
      color:var(--blue-900);
      font-weight:900;
      white-space:nowrap;
    }
    .node .node-text{
      font-size:13px;
      font-weight:900;
      color:#111827;
      line-height:1.35;
      word-break:break-word;
    }
    .node .node-sub{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
      word-break:break-word;
    }
    .tree:after{content:""; display:block; clear:both;}

    .footer-note{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    /* report */
    .report{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:14px;
    }
    .report h3{
      margin:0 0 8px;
      color:var(--blue-900);
      font-size:16px;
    }
    .report .sec{
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      background:#f9fafb;
      margin-bottom:10px;
    }
    .report p{margin:6px 0; font-size:13px; line-height:1.55;}
    .report .k{
      display:inline-block; min-width:108px; color:#111827; font-weight:900;
    }

    /* tiny helpers */
    .mt8{margin-top:8px;}
    .mt12{margin-top:12px;}
    .mt16{margin-top:16px;}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .spacer{flex:1;}
  </style>
</head>
<body>

<header>
  <div class="row">
    <h1>
      é—®é¢˜åˆ†æä¸è§£å†³ Â· 8æ­¥æ³•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      <span class="badge"><span class="badge-dot"></span>DeepSeek via Vercel Proxy</span>
      <span class="badge"><span class="badge-dot warn"></span>æ•°æ®ä¿å­˜åœ¨æœ¬æœº localStorage</span>
    </h1>
    <div class="actions">
      <button class="ghost" id="btn-export-json">å¯¼å‡ºé¡¹ç›®JSON</button>
      <button class="ghost" id="btn-clear">æ¸…ç©ºæ•°æ®</button>
      <button class="primary" id="btn-report">ç”ŸæˆæŠ¥å‘Š</button>
      <button class="primary" id="btn-download-report">å¯¼å‡ºæŠ¥å‘ŠHTML</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tabbar" role="tablist" aria-label="8æ­¥æ³•">
      <button class="tab active" data-tab="step1" role="tab" aria-selected="true">Step1 æ˜ç¡®é—®é¢˜ç›®æ ‡</button>
      <button class="tab" data-tab="step2" role="tab">Step2 å‡è®¾é—®é¢˜&è¯æ®</button>
      <button class="tab" data-tab="step3" role="tab">Step3 å…³é”®é—®é¢˜ç›®æ ‡</button>
      <button class="tab" data-tab="step4" role="tab">Step4 åŸå› é€»è¾‘æ ‘</button>
      <button class="tab" data-tab="step5" role="tab">Step5 å¯¹ç­–ï¼ˆå¯¹æœ«ç«¯åŸå› ï¼‰</button>
      <button class="tab" data-tab="step6" role="tab">Step6 è¡ŒåŠ¨è®¡åˆ’çœ‹æ¿</button>
      <button class="tab" data-tab="step7" role="tab">Step7 è¿‡ç¨‹&ç»“æœè¯„ä¼°</button>
      <button class="tab" data-tab="step8" role="tab">Step8 æ ‡å‡†åŒ–&å¤ç›˜</button>
      <button class="tab" data-tab="report" role="tab">æœ€ç»ˆæŠ¥å‘Š</button>
    </div>

    <!-- Step1 -->
    <section class="panel active" id="step1" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step1 <small>æ˜ç¡®é—®é¢˜ç›®æ ‡</small></div>
          <div class="flex">
            <span class="pill" title="æœ¬æ­¥äº§å‡ºï¼šAIç”Ÿæˆå‡è®¾é—®é¢˜åˆ—è¡¨å¹¶æ¨é€Step2">äº§å‡ºï¼šå‡è®¾é—®é¢˜ â†’ Step2</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="box">
            <div class="box-head">
              <div>æ›´é«˜çš„ç†æƒ³çŠ¶æ€ï¼ˆé•¿æœŸç›®æ ‡ï¼‰</div>
              <div class="subtle">1~3å¹´åå¸Œæœ›è¾¾åˆ°çš„çŠ¶æ€</div>
            </div>
            <div class="box-body">
              <textarea id="s1-ideal" placeholder="ç”¨ä¸šåŠ¡è¯­è¨€æè¿°ä½ å¸Œæœ›è¾¾åˆ°çš„é•¿æœŸçŠ¶æ€ï¼ˆå¯åŒ…å«é‡åŒ–ä¸ä½“éªŒå±‚é¢çš„æè¿°ï¼‰ã€‚"></textarea>
            </div>
          </div>

          <div class="grid grid-2 mt12">
            <div class="grid">
              <div class="box">
                <div class="box-head">
                  <div>ç†æƒ³çŠ¶æ€ Â· KPIsï¼ˆå¯é€‰ï¼‰</div>
                  <div class="subtle">ç”¨äºè¾…åŠ©æ¾„æ¸…å·®è·</div>
                </div>
                <div class="box-body">
                  <textarea id="s1-ideal-kpi" placeholder="ç¤ºä¾‹ï¼šäººå‡é”€å”®é¢â‰¥xxï¼›ä¸€æ¬¡è§£å†³ç‡â‰¥xxï¼›äº¤ä»˜å‡†æ—¶ç‡â‰¥xx"></textarea>
                </div>
              </div>

              <div class="box">
                <div class="box-head">
                  <div>ç°çŠ¶ Â· KPIsï¼ˆå¯é€‰ï¼‰</div>
                  <div class="subtle">å†™æ¸…æ—¶é—´èŒƒå›´ä¸å£å¾„</div>
                </div>
                <div class="box-body">
                  <textarea id="s1-current-kpi" placeholder="ç¤ºä¾‹ï¼šè¿‡å»4å‘¨äººå‡é”€å”®é¢=xxï¼›ä¸€æ¬¡è§£å†³ç‡=xxï¼›å‡†æ—¶ç‡=xx"></textarea>
                </div>
              </div>

              <div class="box">
                <div class="box-head">
                  <div>KPIå·®è·ï¼ˆå¯é€‰ï¼‰</div>
                  <div class="subtle">ç”¨ä¸€å¥è¯å†™å·®è·</div>
                </div>
                <div class="box-body">
                  <textarea id="s1-gap" placeholder="ç¤ºä¾‹ï¼šäººå‡é”€å”®é¢æ¯”ç›®æ ‡ä½15%ï¼Œä¸”è¿ç»­3å‘¨ä¸‹æ»‘ã€‚"></textarea>
                </div>
              </div>
            </div>

            <div class="grid">
              <div class="box">
                <div class="box-head">
                  <div>æˆ‘ä»¬è¦è§£å†³çš„é‚£ä¸ªâ€œå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜â€ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰</div>
                  <div class="subtle">ä¸€å¥è¯å³å¯</div>
                </div>
                <div class="box-body">
                  <textarea id="s1-big" placeholder="ç¤ºä¾‹ï¼šå¦‚ä½•æŠŠé—¨åº—äººå‡é”€å”®é¢æå‡åˆ°xxï¼Ÿ / å¦‚ä½•é™ä½è®¢å•æ“ä½œé”™è¯¯ç‡ï¼Ÿ"></textarea>
                </div>
              </div>

              <div class="box">
                <div class="box-head">
                  <div>çœŸå®åœºæ™¯æè¿°ï¼ˆéå¸¸å…³é”®ï¼‰</div>
                  <div class="subtle">æŠŠä½ çœ‹åˆ°çš„åœºæ™¯å†™å‡ºæ¥ï¼ˆè¶ŠçœŸå®è¶Šå¥½ï¼‰</div>
                </div>
                <div class="box-body">
                  <textarea id="s1-scn" placeholder="å»ºè®®åŒ…å«ï¼šå‘ç”Ÿåœ¨å“ªé‡Œ/ä»€ä¹ˆæ—¶å€™/æ¶‰åŠè§’è‰²/å‡ºç°äº†ä»€ä¹ˆç°è±¡/ä½ å·²æŒæ¡çš„äº‹å®æˆ–æ•°æ®/ä½ è®¤ä¸ºçš„å½±å“ã€‚è¿™é‡Œä¸éœ€è¦5W2Hè¡¨æ ¼ï¼Œåªè¦çœŸå®æè¿°å³å¯ã€‚"></textarea>
                  <div class="sheet-note">æç¤ºï¼šä½ å†™çš„è¶Šè´´è¿‘çœŸå®ä¸šåŠ¡åœºæ™¯ï¼ŒAIç”Ÿæˆçš„â€œæ˜¯å¦å­˜åœ¨â€¦é—®é¢˜ï¼Ÿâ€å‡è®¾å°±è¶Šå¯é ã€‚</div>
                </div>
              </div>

              <div class="ai">
                <div class="ai-head">
                  <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep1ï¼‰Â· ç”Ÿæˆå‡è®¾é—®é¢˜å¹¶æ¨é€åˆ°Step2</div>
                  <div class="flex">
                    <button class="btn2 primary" id="btn-ai-s1">AIæ•™ç»ƒè¯„ä»·å¹¶ç”Ÿæˆå‡è®¾</button>
                    <button class="btn2" id="btn-s1-to-step2">æ‰“å¼€Step2</button>
                  </div>
                </div>
                <div class="ai-out" id="ai-s1-out">ä½ å®Œæˆâ€œå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ + çœŸå®åœºæ™¯æè¿°â€åç‚¹å‡»æŒ‰é’®ï¼Œæˆ‘ä¼šï¼š\n1) å°†ä½ çš„é—®é¢˜æ”¹å†™ä¸ºã€Œä¸ºä»€ä¹ˆâ€¦â€¦ï¼Ÿã€\n2) åŸºäºçœŸå®åœºæ™¯ç”Ÿæˆä¸€ç»„â€œæ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜ï¼Ÿâ€å‡è®¾ï¼Œå¹¶è‡ªåŠ¨æ¨é€åˆ° Step2 çš„å‡è®¾é—®é¢˜åˆ—è¡¨ã€‚</div>
                <div class="ai-status" id="ai-s1-status"></div>
              </div>
            </div>
          </div>

          <div class="footer-note">
            æœ¬æ­¥ä¸å†ä½¿ç”¨ 5W2H æ£€æ ¸è¡¨ã€‚è¯·ç”¨â€œçœŸå®åœºæ™¯æè¿°â€æ›¿ä»£ï¼Œç¡®ä¿AIèƒ½ç†è§£ä½ çœŸå®å‘ç”Ÿçš„ä¸šåŠ¡æƒ…å¢ƒã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Step2 -->
    <section class="panel" id="step2" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step2 <small>é—®é¢˜é€»è¾‘æ ‘åˆ†è§£ï¼šå‡è®¾é—®é¢˜ + è¯æ®éªŒè¯ + ä¼˜å…ˆçº§</small></div>
          <div class="flex">
            <span class="pill" title="æœ¬æ­¥äº§å‡ºï¼šTop3ï¼ˆæœ‰è¯æ®+æœ€é«˜ä¼˜å…ˆçº§ï¼‰å…³é”®é—®é¢˜ â†’ Step3">äº§å‡ºï¼šTop3å…³é”®é—®é¢˜ â†’ Step3</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="box">
            <div class="box-head">
              <div>Step1 å¤§é—®é¢˜ï¼ˆåªè¯»ï¼‰</div>
              <div class="subtle">æ¥è‡ª Step1 ç”¨æˆ·è¾“å…¥</div>
            </div>
            <div class="box-body">
              <textarea id="s2-big" readonly style="background:#f3f4f6; min-height:64px;"></textarea>
              <div class="mt8 flex">
                <span class="pill">ä¼˜å…ˆçº§ = é‡è¦åº¦ Ã— ç´§æ€¥åº¦</span>
                <span class="pill">æ¨é€è§„åˆ™ï¼šTop3ï¼ˆä¼˜å…ˆçº§æœ€é«˜ä¸”å·²æä¾›è¯æ®ï¼‰</span>
                <span class="spacer"></span>
                <button class="btn2" id="btn-s2-sort">æŒ‰ä¼˜å…ˆçº§æ’åº</button>
              </div>
            </div>
          </div>

          <div class="box mt12">
            <div class="box-head">
              <div>å‡è®¾é—®é¢˜åˆ—è¡¨ï¼ˆç”± Step1 AI è‡ªåŠ¨ç”Ÿæˆï¼‰</div>
              <div class="subtle">ä½ éœ€è¦ï¼šè¡¥è¯æ® + æ‰“åˆ†ï¼ˆé‡è¦/ç´§æ€¥ï¼‰</div>
            </div>
            <div class="box-body" style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th class="nowrap" style="width:56px;">#</th>
                    <th style="width:320px;">å‡è®¾é—®é¢˜ï¼ˆæ˜¯å¦å­˜åœ¨â€¦é—®é¢˜ï¼Ÿï¼‰</th>
                    <th style="width:140px;">åˆ†è§£ç»´åº¦</th>
                    <th style="width:360px;">ä¾æ®/è¯æ®è¯´æ˜ï¼ˆå«é™„ä»¶/é“¾æ¥/æ•°æ®å£å¾„ï¼‰</th>
                    <th class="center" style="width:90px;">é‡è¦åº¦</th>
                    <th class="center" style="width:90px;">ç´§æ€¥åº¦</th>
                    <th class="center" style="width:90px;">ä¼˜å…ˆçº§</th>
                    <th class="center" style="width:120px;">è¯æ®çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody id="s2-tbody"></tbody>
              </table>
            </div>

            <div class="ai mt12">
              <div class="ai-head">
                <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep2ï¼‰Â· åªåšè¯æ®æ£€æ ¸ + æ¨é€Top3åˆ°Step3</div>
                <div class="flex">
                  <button class="btn2 primary" id="btn-s2-check-push">AIæ•™ç»ƒè¯„ä»·å¹¶æ¨é€Top3</button>
                  <button class="btn2" id="btn-s2-to-step3">æ‰“å¼€Step3</button>
                </div>
              </div>
              <div class="ai-out" id="ai-s2-out">æœ¬æ­¥AIåªåšä¸€ä»¶äº‹ï¼šæ£€æŸ¥æ¯æ¡å‡è®¾æ˜¯å¦å·²ç»æä¾›è¯æ®ï¼ˆéç©ºå³å¯ï¼‰ã€‚\nç„¶åæŠŠâ€œä¼˜å…ˆçº§æœ€é«˜ä¸”æœ‰è¯æ®â€çš„å‰ä¸‰æ¡å…³é”®é—®é¢˜æ¨é€åˆ° Step3ã€‚</div>
              <div class="ai-status" id="ai-s2-status"></div>
            </div>

            <div class="footer-note">
              è¯´æ˜ï¼šæœ¬æ­¥ä¸å†â€œæ–°å¢å‡è®¾é—®é¢˜â€ã€‚å¦‚æœä½ è§‰å¾—å‡è®¾ä¸å¤Ÿè´´è¿‘å®é™…ï¼Œè¯·å›åˆ° Step1 è¡¥å……åœºæ™¯å†é‡æ–°ç”Ÿæˆï¼Œæˆ–ç›´æ¥åœ¨æœ¬è¡¨ä¸­ä¿®æ”¹é—®é¢˜è¡¨è¿°ã€‚
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step3 -->
    <section class="panel" id="step3" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step3 <small>å…³é”®æ€§é—®é¢˜çš„ç›®æ ‡è®¾å®šï¼ˆä»…ä¿ç•™ç›®æ ‡æè¿°ï¼‰</small></div>
          <div class="flex">
            <span class="pill" title="æœ¬æ­¥äº§å‡ºï¼šå…³é”®é—®é¢˜ç›®æ ‡æè¿° â†’ Step4 åŸå› é€»è¾‘æ ‘">äº§å‡ºï¼šå…³é”®é—®é¢˜ç›®æ ‡ â†’ Step4</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="box">
            <div class="box-head">
              <div>Step2 æ¨é€çš„ Top3 å…³é”®é—®é¢˜ï¼ˆåªè¯»ï¼‰</div>
              <div class="subtle">è¯·ä¸ºæ¯æ¡å…³é”®é—®é¢˜è®¾å®šä¸€ä¸ªâ€œå¯æ§ã€æ¸…æ™°ã€å¯æ£€éªŒâ€çš„ç›®æ ‡æè¿°</div>
            </div>
            <div class="box-body" style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:56px;">#</th>
                    <th style="width:360px;">å…³é”®é—®é¢˜ï¼ˆæ¥è‡ªStep2ï¼‰</th>
                    <th style="width:360px;">è¯æ®æ‘˜è¦ï¼ˆæ¥è‡ªStep2ï¼‰</th>
                    <th>ç›®æ ‡æè¿°ï¼ˆä½ å¡«å†™ï¼‰</th>
                  </tr>
                </thead>
                <tbody id="s3-tbody"></tbody>
              </table>
              <div class="sheet-note">ç›®æ ‡æè¿°å»ºè®®å†™æ³•ï¼šåœ¨<span class="pill">xxå‘¨æœŸå†…</span>ï¼ŒæŠŠ<span class="pill">xxè¿‡ç¨‹/èƒ½åŠ›/æŒ‡æ ‡</span>æå‡åˆ°<span class="pill">xxæ ‡å‡†</span>ï¼Œä»¥æ”¯æ’‘å¤§é—®é¢˜æ”¹å–„ã€‚</div>
            </div>
          </div>

          <div class="ai mt12">
            <div class="ai-head">
              <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep3ï¼‰Â· è¯„ä»·ç›®æ ‡æ˜¯å¦æ°å½“ï¼Œå¹¶ç»™å‡ºä¼˜åŒ–åçš„ç›®æ ‡æè¿°</div>
              <div class="flex">
                <button class="btn2 primary" id="btn-ai-s3">AIæ•™ç»ƒè¯„ä»·ç›®æ ‡</button>
                <button class="btn2" id="btn-ai-s3-apply">åº”ç”¨AIä¼˜åŒ–ç›®æ ‡</button>
                <button class="btn2" id="btn-s3-sync-step4">åŒæ­¥åˆ°Step4åŸå› æ ‘</button>
                <button class="btn2" id="btn-s3-to-step4">æ‰“å¼€Step4</button>
              </div>
            </div>
            <div class="ai-out" id="ai-s3-out">æˆ‘ä¼šç»“åˆä½ çš„çœŸå®åœºæ™¯ä¸å…³é”®é—®é¢˜ï¼Œåˆ¤æ–­ç›®æ ‡æè¿°æ˜¯å¦ï¼š\n- å¯æ§ï¼ˆä¸æ˜¯å¤–éƒ¨ä¸å¯æ§ï¼‰\n- æ¸…æ™°ï¼ˆä¸ç©ºæ³›ï¼‰\n- å¯æ£€éªŒï¼ˆèƒ½é€šè¿‡äº‹å®/æ•°æ®æˆ–å¯è§‚å¯Ÿè¡Œä¸ºéªŒè¯ï¼‰\nç„¶åç»™å‡ºâ€œä¼˜åŒ–åçš„ç›®æ ‡æè¿°â€å»ºè®®ã€‚</div>
            <div class="ai-status" id="ai-s3-status"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step4 -->
    <section class="panel" id="step4" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step4 <small>åŸå› é€»è¾‘æ ‘ï¼ˆWhy Treeï¼‰</small></div>
          <div class="flex">
            <span class="pill" title="æœ¬æ­¥äº§å‡ºï¼šæœ«ç«¯åŸå› ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰â†’ Step5">äº§å‡ºï¼šæœ«ç«¯åŸå› åˆ—è¡¨ â†’ Step5</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid grid-2">
            <div class="box">
              <div class="box-head">
                <div>åŸå› é€»è¾‘æ ‘ï¼ˆå¯è§†åŒ–ï¼‰</div>
                <div class="subtle">æ ¹ï¼šä¸ºä»€ä¹ˆâ€¦ï¼Ÿ â†’ å…³é”®é—®é¢˜ï¼ˆä¸åˆ°ä½/ä¸åŠæ—¶â€¦ï¼‰ â†’ å¤šå±‚WHY</div>
              </div>
              <div class="box-body">
                <div class="tree-wrap">
                  <div class="tree" id="s4-tree"></div>
                </div>
                <div class="sheet-note">ç‚¹å‡»ä»»æ„èŠ‚ç‚¹å³å¯åœ¨å³ä¾§ç¼–è¾‘ã€‚å»ºè®®åŸå› å°½é‡è½åˆ°â€œå¯æ§ã€å¯è¡ŒåŠ¨ã€å¯éªŒè¯â€çš„å±‚é¢ã€‚</div>
              </div>
            </div>

            <div class="grid">
              <div class="box">
                <div class="box-head">
                  <div>èŠ‚ç‚¹ç¼–è¾‘ / æ–°å¢ä¸‹ä¸€å±‚ WHY</div>
                  <div class="subtle">æ¯ä¸ªé—®é¢˜éƒ½å¯ç»§ç»­è¿½é—®WHY</div>
                </div>
                <div class="box-body">
                  <label>é€‰æ‹©çˆ¶èŠ‚ç‚¹</label>
                  <select id="s4-parent"></select>

                  <label>æ–°ä¸€å±‚WHYæè¿°ï¼ˆå­èŠ‚ç‚¹ï¼‰</label>
                  <textarea id="s4-new" placeholder="ç¤ºä¾‹ï¼šå› ä¸ºä¸€çº¿äººå‘˜ç¼ºå°‘xxæ ‡å‡†åŒ–åŸ¹è®­ï¼Œå¯¼è‡´â€¦"></textarea>

                  <label>éªŒè¯æ–¹å¼/è¯æ®ï¼ˆå¯é€‰ï¼‰</label>
                  <textarea id="s4-evi" placeholder="å¯ä»¥å†™ï¼šè¦çœ‹å“ªäº›æ•°æ®/è®°å½•/ç°åœºè¯æ®æ¥éªŒè¯è¿™ä¸ªåŸå› ã€‚"></textarea>

                  <div class="flex mt8">
                    <button class="btn2 primary" id="btn-s4-add">æ·»åŠ ä¸‹ä¸€å±‚WHY</button>
                    <span class="spacer"></span>
                    <button class="btn2" id="btn-s4-delete">åˆ é™¤é€‰ä¸­èŠ‚ç‚¹</button>
                  </div>

                  <div class="mt12 box" style="border-width:1px;">
                    <div class="box-head">
                      <div>å½“å‰é€‰ä¸­èŠ‚ç‚¹</div>
                      <div class="subtle">å¯ç›´æ¥ç¼–è¾‘æ–‡æœ¬</div>
                    </div>
                    <div class="box-body">
                      <div class="small">èŠ‚ç‚¹IDï¼š<span id="s4-sel-id">-</span></div>
                      <label class="mt8">èŠ‚ç‚¹æ–‡æœ¬</label>
                      <textarea id="s4-sel-text"></textarea>
                      <label>éªŒè¯æ–¹å¼/è¯æ®</label>
                      <textarea id="s4-sel-evi"></textarea>
                      <div class="flex mt8">
                        <button class="btn2 primary" id="btn-s4-save">ä¿å­˜ä¿®æ”¹</button>
                        <button class="btn2" id="btn-s4-push-step5">æ¨é€æœ«ç«¯åŸå› åˆ°Step5</button>
                      </div>
                    </div>
                  </div>

                  <div class="ai mt12">
                    <div class="ai-head">
                      <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep4ï¼‰Â· æ£€æŸ¥å› æœå…³ç³»æ˜¯å¦ç›´æ¥ + å»é™¤ä¸å¯æ§åŸå›  + æ¨é€æœ«ç«¯åŸå› </div>
                      <div class="flex">
                        <button class="btn2 primary" id="btn-ai-s4">AIæ•™ç»ƒè¯„ä»·åŸå› æ ‘</button>
                        <button class="btn2" id="btn-ai-s4-apply-push">åº”ç”¨AIä¼˜åŒ–å¹¶æ¨é€Step5</button>
                        <button class="btn2" id="btn-s4-to-step5">æ‰“å¼€Step5</button>
                      </div>
                    </div>
                    <div class="ai-out" id="ai-s4-out">æˆ‘ä¼šè¯„ä»·ï¼š\n1) ä¸Šä¸‹å±‚æ˜¯å¦â€œç›´æ¥å› æœâ€ï¼ˆä¸æ˜¯è·³çº§/å¹¶åˆ—/ç›¸å…³ä½†éå› æœï¼‰\n2) åŸå› æ˜¯å¦é€æ¸è½åˆ°â€œå¯æ§å› ç´ â€ï¼Œè‹¥å‡ºç°ç¯å¢ƒ/æ”¿ç­–ç­‰ä¸å¯æ§ï¼Œä¼šå»ºè®®è½¬å†™ä¸ºå¯æ§åŸå› \n3) ç»™å‡ºå¯æ‰§è¡Œçš„æ”¹å†™å»ºè®®ã€‚\néšåå¯ä¸€é”®æ¨é€â€œæœ«ç«¯åŸå› åˆ—è¡¨â€åˆ° Step5ã€‚</div>
                    <div class="ai-status" id="ai-s4-status"></div>
                  </div>
                </div>
              </div>

              <div class="box">
                <div class="box-head">
                  <div>èŠ‚ç‚¹åˆ—è¡¨ï¼ˆä¾¿äºæ£€æŸ¥ï¼‰</div>
                  <div class="subtle">å¶å­èŠ‚ç‚¹ä¼šè¢«æ¨é€åˆ°Step5</div>
                </div>
                <div class="box-body" style="overflow:auto; max-height:420px;">
                  <table>
                    <thead>
                      <tr>
                        <th style="width:56px;">å±‚çº§</th>
                        <th style="width:260px;">èŠ‚ç‚¹</th>
                        <th style="width:260px;">çˆ¶èŠ‚ç‚¹</th>
                        <th>éªŒè¯/è¯æ®</th>
                      </tr>
                    </thead>
                    <tbody id="s4-list"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="footer-note">
            æé†’ï¼šæœ¬æ­¥ä¸å†æŒ‰â€œæ¯ä¸ªå…³é”®é—®é¢˜ä¸€ä¸ªå•ç‹¬åŸå› æ ‘â€åˆ‡æ¢ï¼Œè€Œæ˜¯ç»Ÿä¸€åœ¨ä¸€æ£µ Why Tree ä¸­å‘ˆç°ï¼šæ ¹é—®é¢˜ â†’ å…³é”®é—®é¢˜åˆ†æ”¯ â†’ å¤šå±‚WHYã€‚å¶å­èŠ‚ç‚¹ä¼šæ¨é€åˆ°Step5ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Step5 -->
    <section class="panel" id="step5" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step5 <small>å¯¹ç­–ï¼šé’ˆå¯¹æœ«ç«¯åŸå› é€æ¡åˆ¶å®š</small></div>
          <div class="flex">
            <span class="pill" title="æœ¬æ­¥äº§å‡ºï¼šä¼˜åŒ–åçš„å¯¹ç­– â†’ Step6">äº§å‡ºï¼šå¯¹ç­–åˆ—è¡¨ â†’ Step6</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="box">
            <div class="box-head">
              <div>æœ«ç«¯åŸå› åˆ—è¡¨ï¼ˆæ¥è‡ªStep4ï¼‰</div>
              <div class="subtle">ç¬¬ä¸€åˆ—å›ºå®šï¼Œç”¨æˆ·å¡«å†™å¯¹ç­–</div>
            </div>
            <div class="box-body" style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:56px;">#</th>
                    <th style="width:360px;">æœ«ç«¯åŸå› ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰</th>
                    <th>å¯¹ç­–ï¼ˆä½ å¡«å†™ï¼‰</th>
                    <th style="width:240px;">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</th>
                  </tr>
                </thead>
                <tbody id="s5-tbody"></tbody>
              </table>
              <div class="sheet-note">å»ºè®®ï¼šæ¯ä¸ªæœ«ç«¯åŸå› è‡³å°‘ç»™å‡ºä¸€ä¸ªå¯æ‰§è¡Œå¯¹ç­–ï¼›å¯¹ç­–è¦èƒ½ç›´æ¥ä½œç”¨äºè¯¥åŸå› ï¼ˆä¸æ˜¯å£å·ï¼‰ã€‚</div>
            </div>
          </div>

          <div class="ai mt12">
            <div class="ai-head">
              <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep5ï¼‰Â· åˆ¤æ–­å¯¹ç­–æ˜¯å¦çœŸæ­£ä½œç”¨äºæœ«ç«¯åŸå› ï¼Œå¹¶ç»™å‡ºæ›´ç²¾å‡†/åˆ›æ–°çš„ä¼˜åŒ–å¯¹ç­–</div>
              <div class="flex">
                <button class="btn2 primary" id="btn-ai-s5">AIæ•™ç»ƒè¯„ä»·å¯¹ç­–</button>
                <button class="btn2" id="btn-ai-s5-apply">åº”ç”¨AIä¼˜åŒ–å¯¹ç­–</button>
                <button class="btn2" id="btn-s5-push-step6">æ¨é€å¯¹ç­–åˆ°Step6</button>
                <button class="btn2" id="btn-s5-to-step6">æ‰“å¼€Step6</button>
              </div>
            </div>
            <div class="ai-out" id="ai-s5-out">æˆ‘ä¼šç»“åˆä½ çš„çœŸå®åœºæ™¯ï¼Œé€æ¡åˆ¤æ–­ï¼š\n- è¯¥å¯¹ç­–æ˜¯å¦èƒ½ç›´æ¥é™ä½/æ¶ˆé™¤è¿™ä¸ªæœ«ç«¯åŸå› ï¼Ÿ\n- æ˜¯å¦è¿‡äºæ³›åŒ–ï¼Ÿæ˜¯å¦éœ€è¦æ‹†æˆæ›´å…·ä½“çš„åŠ¨ä½œ/æœºåˆ¶ï¼Ÿ\n- ç»™å‡ºæ›´ç²¾å‡†ã€æ›´â€œé’ˆå¯¹ä¸åŒæœ«ç«¯åŸå› â€çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå«åˆ›æ–°æ›¿ä»£æ–¹æ¡ˆï¼‰ã€‚</div>
            <div class="ai-status" id="ai-s5-status"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step6 -->
    <section class="panel" id="step6" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step6 <small>è¡ŒåŠ¨è®¡åˆ’çœ‹æ¿ï¼ˆç¬¬ä¸€åˆ—ä¸ºå¯¹ç­–ï¼‰</small></div>
          <div class="flex">
            <span class="pill" title="æœ¬æ­¥äº§å‡ºï¼šå¯æ‰§è¡Œä»»åŠ¡æ¸…å• â†’ ç»“æœè¯„ä¼°">äº§å‡ºï¼šä»»åŠ¡æ¸…å• â†’ Step7</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid grid-1">
            <div class="box">
              <div class="box-head">
                <div>æ–°å¢ä»»åŠ¡ï¼ˆå›´ç»•å¯¹ç­–æ‹†è§£ï¼‰</div>
                <div class="subtle">ä»»åŠ¡è¦èƒ½æ¨åŠ¨å¯¹ç­–è½åœ°</div>
              </div>
              <div class="box-body">
                <label>é€‰æ‹©å¯¹ç­–</label>
                <select id="s6-cm"></select>

                <label>å…·ä½“ä»»åŠ¡ï¼ˆåŠ¨è¯å¼€å¤´ï¼Œå°½é‡å¯éªŒæ”¶ï¼‰</label>
                <textarea id="s6-task" placeholder="ç¤ºä¾‹ï¼šåˆ¶å®šxxæ ‡å‡†ä½œä¸šæŒ‡å¯¼ä¹¦å¹¶å®Œæˆè¯•è¿è¡Œï¼›æ­å»ºxxçœ‹æ¿å¹¶è®­ç»ƒä¸€çº¿ä½¿ç”¨ï¼›ä¼˜åŒ–xxæµç¨‹èŠ‚ç‚¹å¹¶ä¸Šçº¿æ ¡éªŒè§„åˆ™ã€‚"></textarea>

                <div class="grid grid-3">
                  <div>
                    <label>è´£ä»»äºº</label>
                    <input id="s6-owner" placeholder="å§“å/è§’è‰²"/>
                  </div>
                  <div>
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input id="s6-start" type="date"/>
                  </div>
                  <div>
                    <label>æˆªæ­¢æ—¥æœŸ</label>
                    <input id="s6-end" type="date"/>
                  </div>
                </div>

                <label class="mt8">é‡Œç¨‹ç¢‘/éªŒæ”¶å£å¾„ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="s6-mile" placeholder="å†™æ¸…ï¼šåšåˆ°ä»€ä¹ˆç®—å®Œæˆï¼Ÿè°éªŒæ”¶ï¼ŸéªŒæ”¶ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿ"></textarea>

                <div class="flex mt8">
                  <button class="btn2 primary" id="btn-s6-add">æ·»åŠ ä»»åŠ¡</button>
                  <button class="btn2" id="btn-s6-sort">æŒ‰æˆªæ­¢æ—¥æœŸæ’åº</button>
                </div>
              </div>
            </div>

            <div class="box">
              <div class="box-head">
                <div>è¡ŒåŠ¨è®¡åˆ’çœ‹æ¿</div>
                <div class="subtle">ç¬¬ä¸€åˆ—å›ºå®šä¸ºå¯¹ç­–</div>
              </div>
              <div class="box-body" style="overflow:auto;">
                <table>
                  <thead>
                    <tr>
                      <th style="width:56px;">#</th>
                      <th style="width:320px;">å¯¹ç­–</th>
                      <th>ä»»åŠ¡</th>
                      <th style="width:120px;">è´£ä»»äºº</th>
                      <th style="width:120px;">å¼€å§‹</th>
                      <th style="width:120px;">æˆªæ­¢</th>
                      <th style="width:120px;">çŠ¶æ€</th>
                      <th style="width:70px;">åˆ </th>
                    </tr>
                  </thead>
                  <tbody id="s6-tbody"></tbody>
                </table>
              </div>

              <div class="ai mt12">
                <div class="ai-head">
                  <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep6ï¼‰Â· ä»»åŠ¡æ˜¯å¦æœ‰æ•ˆæ”¯æŒå¯¹ç­–ï¼Ÿä¸æ”¯æŒåˆ™è¡¥å…¨/æ”¹å†™</div>
                  <div class="flex">
                    <button class="btn2 primary" id="btn-ai-s6">AIæ•™ç»ƒè¯„ä»·ä»»åŠ¡</button>
                    <button class="btn2" id="btn-ai-s6-apply">åº”ç”¨AIä¼˜åŒ–ä»»åŠ¡</button>
                    <button class="btn2" id="btn-s6-to-step7">æ‰“å¼€Step7</button>
                  </div>
                </div>
                <div class="ai-out" id="ai-s6-out">æˆ‘ä¼šæ£€æŸ¥ï¼š\n- æ¯æ¡ä»»åŠ¡æ˜¯å¦èƒ½æ¨åŠ¨å¯¹åº”å¯¹ç­–è½åœ°\n- ä»»åŠ¡æ˜¯å¦å¯éªŒæ”¶/è´£ä»»æ˜¯å¦æ˜ç¡®/æ—¶é—´æ˜¯å¦åˆç†\n- å¦‚æœä»»åŠ¡â€œçœ‹èµ·æ¥å¾ˆå¿™ä½†ä¸è§£å†³å¯¹ç­–â€ï¼Œæˆ‘ä¼šç»™å‡ºæ›´æœ‰æ•ˆçš„ä»»åŠ¡æ”¹å†™/è¡¥å……ã€‚</div>
                <div class="ai-status" id="ai-s6-status"></div>
              </div>
            </div>
          </div>

          <div class="footer-note">
            è¯´æ˜ï¼šæœ¬æ­¥çš„æ ¸å¿ƒæ˜¯â€œä»å¯¹ç­–åˆ°ä»»åŠ¡â€ï¼Œä¸æ˜¯å †å¾ˆå¤šäº‹é¡¹ã€‚å»ºè®®ä¸€ä¸ªå¯¹ç­–æ‹† 2~5 ä¸ªå¯éªŒæ”¶ä»»åŠ¡å³å¯ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Step7 -->
    <section class="panel" id="step7" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step7 <small>è¿‡ç¨‹ & ç»“æœè¯„ä¼°</small></div>
          <div class="flex">
            <span class="pill">äº§å‡ºï¼šå¤ç›˜è¦ç‚¹ â†’ Step8</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="box">
            <div class="box-head">
              <div>ç»“æœè¯„ä¼°è¡¨ï¼ˆå¯è‡ªè¡Œæ·»åŠ ï¼‰</div>
              <div class="subtle">ç”¨äºæœ€ç»ˆæŠ¥å‘Šå‘ˆç°</div>
            </div>
            <div class="box-body" style="overflow:auto;">
              <div class="flex">
                <button class="btn2 primary" id="btn-s7-add">æ–°å¢ä¸€è¡Œ</button>
                <button class="btn2" id="btn-s7-calc">è‡ªåŠ¨è®¡ç®—æ”¹å–„%</button>
              </div>
              <div class="mt12">
                <table>
                  <thead>
                    <tr>
                      <th style="width:56px;">#</th>
                      <th style="width:360px;">æŒ‡æ ‡/è¯„ä»·é¡¹</th>
                      <th style="width:140px;">æ”¹å–„å‰</th>
                      <th style="width:140px;">ç›®æ ‡</th>
                      <th style="width:140px;">æ”¹å–„å</th>
                      <th style="width:140px;">æ”¹å–„%</th>
                      <th style="width:70px;">åˆ </th>
                    </tr>
                  </thead>
                  <tbody id="s7-tbody"></tbody>
                </table>
              </div>

              <label class="mt12">è¿‡ç¨‹è®°å½•ï¼ˆå…³é”®å‘ç°/è¸©å‘/ç»éªŒï¼‰</label>
              <textarea id="s7-notes" placeholder="å†™æ¸…ï¼šè¿‡ç¨‹å‘ç”Ÿäº†ä»€ä¹ˆã€å“ªäº›åšæ³•æœ‰æ•ˆã€å“ªäº›æ— æ•ˆã€ä¸‹ä¸€æ¬¡ä¼šæ€ä¹ˆåšã€‚"></textarea>
            </div>
          </div>

          <div class="ai mt12">
            <div class="ai-head">
              <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep7ï¼‰Â· æç‚¼äº®ç‚¹/ä¸è¶³/å¯å¤åˆ¶ç»éªŒï¼Œæ¨åŠ¨æ ‡å‡†åŒ–</div>
              <div class="flex">
                <button class="btn2 primary" id="btn-ai-s7">AIæ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                <button class="btn2" id="btn-ai-s7-apply">æŠŠå»ºè®®å†™å…¥Step8</button>
                <button class="btn2" id="btn-s7-to-step8">æ‰“å¼€Step8</button>
              </div>
            </div>
            <div class="ai-out" id="ai-s7-out">æˆ‘ä¼šå¸®åŠ©ä½ æŠŠæ•°æ®ä¸è¿‡ç¨‹è®°å½•å˜æˆå¯å¤ç”¨çš„ç»“è®ºï¼š\n- äº®ç‚¹ä¸ä¸è¶³\n- å¯èƒ½çš„åå·®é£é™©\n- 3~5æ¡å¯å¤åˆ¶è¦ç‚¹\n- æ¨èæ²‰æ·€ä¸ºæ ‡å‡†çš„å†…å®¹</div>
            <div class="ai-status" id="ai-s7-status"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Step8 -->
    <section class="panel" id="step8" role="tabpanel">
      <div class="sheet">
        <div class="sheet-header">
          <div class="title">Step8 <small>æ ‡å‡†åŒ– & å¤ç›˜</small></div>
          <div class="flex">
            <span class="pill">äº§å‡ºï¼šæ ‡å‡†åŒ–æ¸…å• + ä¸ªäººå¤ç›˜</span>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid grid-2">
            <div class="box">
              <div class="box-head">
                <div>æ ‡å‡†åŒ–æ”¯æŒè®¡åˆ’ï¼ˆæ¡ç›®åŒ–ï¼‰</div>
                <div class="subtle">è°/ä½•æ—¶/åšåˆ°ä»€ä¹ˆ</div>
              </div>
              <div class="box-body" style="overflow:auto;">
                <div class="flex">
                  <button class="btn2 primary" id="btn-s8-add">æ–°å¢æ ‡å‡†åŒ–æ¡ç›®</button>
                </div>
                <div class="mt12">
                  <table>
                    <thead>
                      <tr>
                        <th style="width:56px;">#</th>
                        <th>æ ‡å‡†åŒ–å†…å®¹</th>
                        <th style="width:140px;">è´£ä»»äºº</th>
                        <th style="width:140px;">å®Œæˆæ—¶é—´</th>
                        <th style="width:120px;">å®Œæˆåº¦%</th>
                        <th style="width:70px;">åˆ </th>
                      </tr>
                    </thead>
                    <tbody id="s8-tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="box">
              <div class="box-head">
                <div>ä¸ªäººå¤ç›˜</div>
                <div class="subtle">èƒ½åŠ›æå‡ä¸ä¸‹ä¸€è½®æ”¹è¿›</div>
              </div>
              <div class="box-body">
                <label>å¤ç›˜å†…å®¹</label>
                <textarea id="s8-retro" placeholder="å»ºè®®åŒ…å«ï¼šè¿™æ¬¡é¡¹ç›®ä½ åšå¯¹äº†ä»€ä¹ˆ/åšé”™äº†ä»€ä¹ˆ/ä¸‹ä¸€æ¬¡è¦æ€ä¹ˆåš/éœ€è¦æå‡ä»€ä¹ˆèƒ½åŠ›ã€‚"></textarea>

                <div class="ai mt12">
                  <div class="ai-head">
                    <div class="left">ğŸ¤– AIæ•™ç»ƒï¼ˆStep8ï¼‰Â· æ±‡æ€»ç»„ç»‡å¯å¤åˆ¶åšæ³• + ä¸ªäººæˆé•¿å»ºè®®</div>
                    <div class="flex">
                      <button class="btn2 primary" id="btn-ai-s8">AIæ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                    </div>
                  </div>
                  <div class="ai-out" id="ai-s8-out">æˆ‘ä¼šç»“åˆå‰é¢å…¨éƒ¨æ­¥éª¤å†…å®¹ï¼Œå¸®ä½ æ€»ç»“ï¼š\n- ç»„ç»‡å±‚é¢å¯å¤åˆ¶çš„åšæ³•\n- ä½ ä¸ªäººåœ¨é—®é¢˜åˆ†æä¸è§£å†³èƒ½åŠ›ä¸Šçš„ä¼˜åŠ¿/çŸ­æ¿\n- ä¸‹ä¸€è½®æœ€å€¼å¾—ä¼˜å…ˆå°è¯•çš„æ”¹è¿›æ–¹å‘</div>
                  <div class="ai-status" id="ai-s8-status"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="footer-note">
            Step8 å®Œæˆåå»ºè®®å¯¼å‡ºæœ€ç»ˆæŠ¥å‘Šï¼Œå¹¶åœ¨å›¢é˜Ÿå†…éƒ¨åšä¸€æ¬¡å¤ç›˜åˆ†äº«ï¼Œå½¢æˆç»„ç»‡å­¦ä¹ é—­ç¯ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Report -->
    <section class="panel" id="report" role="tabpanel">
      <div class="report">
        <div class="flex">
          <h3 style="margin:0;">æœ€ç»ˆæŠ¥å‘Šé¢„è§ˆ</h3>
          <span class="spacer"></span>
          <button class="btn2 primary" id="btn-report-refresh">åˆ·æ–°æŠ¥å‘Š</button>
        </div>
        <div class="sec mt12" id="report-content"></div>
        <div class="small">æç¤ºï¼šç‚¹å‡»é¡¶éƒ¨â€œå¯¼å‡ºæŠ¥å‘ŠHTMLâ€ï¼Œå¯ä¸‹è½½ä¸€ä»½å¯åˆ†äº«/å¯æ‰“å°çš„æŠ¥å‘Šæ–‡ä»¶ã€‚</div>
      </div>
    </section>

  </div>
</div>

<script>
/* ===========================
   æ•°æ®ç»“æ„ & å­˜å‚¨
=========================== */
const STORAGE_KEY = "pas8_ai_tool_v2_optimized";
const AI_ENDPOINT = "/api/deepseek-chat"; // Vercel Serverless Function
const AI_MODEL = "deepseek-chat";

const defaultState = {
  step1: {
    ideal: "",
    idealKpi: "",
    currentKpi: "",
    gap: "",
    bigProblem: "",
    scenario: "",
    rootWhy: "" // "ä¸ºä»€ä¹ˆ...ï¼Ÿ"
  },
  step2: {
    hypotheses: [] // {id, text, dimension, evidence, importance, urgency}
  },
  step3: {
    keyProblems: [] // {id, hypoId, text, evidence, importance, urgency, priority, goal, aiGoal}
  },
  step4: {
    nodes: [], // {id, parentId, text, evidence, type:"root|key|why", keyProblemId}
    selectedNodeId: ""
  },
  step5: {
    items: [] // {id, leafNodeId, leafText, keyProblemId, countermeasure, note, aiCountermeasure}
  },
  step6: {
    countermeasures: [], // {id, sourceItemId, text}
    tasks: [] // {id, countermeasureId, task, owner, start, end, status, milestone, aiTask}
  },
  step7: {
    rows: [], // {id,label,before,target,after,improve}
    notes: "",
    aiStdPoints: []
  },
  step8: {
    standards: [], // {id,title,owner,due,progress}
    retro: ""
  },
  ai: {
    s1: null, s3: null, s4: null, s5: null, s6: null, s7: null, s8: null
  }
};

let state = loadState();
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(defaultState);
    const obj = JSON.parse(raw);
    // shallow merge
    return Object.assign(structuredClone(defaultState), obj);
  }catch(e){
    console.warn("loadState failed", e);
    return structuredClone(defaultState);
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function uuid(){
  return Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8);
}
function escapeHtml(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ===========================
   Tab åˆ‡æ¢
=========================== */
function setActiveTab(id){
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab===id);
    btn.setAttribute("aria-selected", btn.dataset.tab===id ? "true" : "false");
  });
  document.querySelectorAll(".panel").forEach(p=>{
    p.classList.toggle("active", p.id===id);
  });
  if(id==="report") buildReport();
}
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
});

/* ===========================
   é€šç”¨ï¼šAI è°ƒç”¨
=========================== */
function parseJsonFromText(text){
  if(!text) return null;
  let t = text.trim();
  // allow ```json ... ```
  const m = t.match(/```json\\s*([\\s\\S]*?)\\s*```/i);
  if(m) t = m[1].trim();
  try{ return JSON.parse(t); }catch(e){ return null; }
}

async function callAI({systemPrompt, payload, outEl, statusEl}){
  statusEl.textContent = "AI æ­£åœ¨æ€è€ƒâ€¦";
  try{
    const body = {
      model: AI_MODEL,
      messages: [
        {role:"system", content: systemPrompt},
        {role:"user", content: "è¯·åŸºäºä»¥ä¸‹JSONæ•°æ®å®Œæˆä»»åŠ¡ï¼Œå¹¶ä¸¥æ ¼è¾“å‡ºJSONï¼š\\n" + JSON.stringify(payload, null, 2)}
      ],
      temperature: 0.2
    };
    const res = await fetch(AI_ENDPOINT, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    const text = data?.choices?.[0]?.message?.content || "";
    outEl.textContent = text || "AI è¿”å›ä¸ºç©ºï¼ˆè¯·é‡è¯•ï¼‰";
    statusEl.textContent = "AI å·²è¿”å›ã€‚";
    return {raw:text, json: parseJsonFromText(text)};
  }catch(err){
    console.error(err);
    statusEl.textContent = "è°ƒç”¨å¤±è´¥ï¼šè¯·æ£€æŸ¥ /api/deepseek-chat ä»£ç†æ˜¯å¦å¯ç”¨ã€‚";
    outEl.textContent = outEl.textContent || "ï¼ˆæ— è¾“å‡ºï¼‰";
    return {raw:null, json:null, error:String(err)};
  }
}

/* ===========================
   Step1 ç»‘å®š & AIç”Ÿæˆå‡è®¾
=========================== */
const elS1Ideal = document.getElementById("s1-ideal");
const elS1IdealKpi = document.getElementById("s1-ideal-kpi");
const elS1CurrentKpi = document.getElementById("s1-current-kpi");
const elS1Gap = document.getElementById("s1-gap");
const elS1Big = document.getElementById("s1-big");
const elS1Scn = document.getElementById("s1-scn");

function initStep1(){
  elS1Ideal.value = state.step1.ideal;
  elS1IdealKpi.value = state.step1.idealKpi;
  elS1CurrentKpi.value = state.step1.currentKpi;
  elS1Gap.value = state.step1.gap;
  elS1Big.value = state.step1.bigProblem;
  elS1Scn.value = state.step1.scenario;

  elS1Ideal.addEventListener("input", ()=>{state.step1.ideal = elS1Ideal.value; saveState();});
  elS1IdealKpi.addEventListener("input", ()=>{state.step1.idealKpi = elS1IdealKpi.value; saveState();});
  elS1CurrentKpi.addEventListener("input", ()=>{state.step1.currentKpi = elS1CurrentKpi.value; saveState();});
  elS1Gap.addEventListener("input", ()=>{state.step1.gap = elS1Gap.value; saveState();});
  elS1Big.addEventListener("input", ()=>{state.step1.bigProblem = elS1Big.value; saveState();});
  elS1Scn.addEventListener("input", ()=>{state.step1.scenario = elS1Scn.value; saveState();});
}
initStep1();

document.getElementById("btn-s1-to-step2").addEventListener("click", ()=> setActiveTab("step2"));

const S1_PROMPT = `
ä½ æ˜¯ä¸€åèµ„æ·±â€œé—®é¢˜åˆ†æä¸è§£å†³ï¼ˆ8æ­¥æ³•ï¼‰â€AIæ•™ç»ƒã€‚
ç›®æ ‡ï¼šåŸºäºç”¨æˆ·è¾“å…¥çš„ã€å¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ã€‘ä¸ã€çœŸå®åœºæ™¯æè¿°ã€‘ï¼Œç”Ÿæˆ Step2 éœ€è¦çš„â€œå‡è®¾é—®é¢˜æ¸…å•â€ã€‚

è¦æ±‚ï¼š
1) å…ˆæŠŠç”¨æˆ·çš„å¤§é—®é¢˜æ”¹å†™æˆä¸€ä¸ªâ€œä¸ºä»€ä¹ˆâ€¦â€¦ï¼Ÿâ€é—®é¢˜ï¼ˆroot_why_questionï¼‰ï¼Œç”¨äº Step4 æ ¹èŠ‚ç‚¹ã€‚
2) ç”Ÿæˆ 8~12 æ¡å‡è®¾é—®é¢˜ï¼Œå¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼Œå¹¶ä¸¥æ ¼é‡‡ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
   - ä»¥â€œæ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜ï¼Ÿâ€å¼€å¤´æˆ–åŒ…å«â€œæ˜¯å¦å­˜åœ¨â€¦é—®é¢˜ï¼Ÿâ€ç»“æ„
   - ä¸è¦å†™è§£å†³æ–¹æ¡ˆ/å¯¹ç­–ï¼Œä¸è¦ç»™å»ºè®®åŠ¨ä½œ
   - æ¯æ¡å‡è®¾å°½é‡å¯è¢«è¯æ®éªŒè¯ï¼ˆèƒ½ç”¨æ•°æ®/è®°å½•/äº‹å®è¯æ˜å­˜åœ¨æˆ–ä¸å­˜åœ¨ï¼‰
3) ä¸ºæ¯æ¡å‡è®¾ç»™å‡ºä¸€ä¸ªâ€œåˆ†è§£ç»´åº¦ dimensionâ€ï¼Œä»ä»¥ä¸‹é›†åˆé€‰æ‹©ï¼š["æµç¨‹/æ—¶é—´","ç»“æ„/è¦ç´ ","è§’è‰²/èƒ½åŠ›","ç³»ç»Ÿ/å·¥å…·","è§„åˆ™/æœºåˆ¶","æ•°æ®/ä¿¡æ¯","å…¶å®ƒ"]ã€‚
4) å…è®¸ä½ åŸºäºåœºæ™¯è¡¥é½â€œå¸¸è§é—æ¼å‡è®¾â€ï¼Œä½†å¿…é¡»è´´è¿‘ç”¨æˆ·åœºæ™¯ï¼Œé¿å…æ³›æ³›è€Œè°ˆã€‚

è¾“å‡ºå¿…é¡»æ˜¯ä¸¥æ ¼ JSONï¼ˆä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ï¼‰ï¼š
{
  "coach_comment": "ä¸€å¥è¯ç‚¹è¯„ï¼ˆå¯å«æé†’ï¼šä¸‹ä¸€æ­¥è¦è¡¥è¯æ®ä¸æ‰“åˆ†ï¼‰",
  "root_why_question": "ä¸ºä»€ä¹ˆâ€¦â€¦ï¼Ÿ",
  "hypotheses": [
    {"text":"æ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜ï¼Ÿ","dimension":"æµç¨‹/æ—¶é—´","reason":"ä¸åœºæ™¯å¯¹åº”çš„ä¸€å¥è¯ï¼ˆå¯é€‰ï¼‰"}
  ]
}
`;

document.getElementById("btn-ai-s1").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s1-out");
  const statusEl = document.getElementById("ai-s1-status");

  const big = (state.step1.bigProblem || "").trim();
  const scn = (state.step1.scenario || "").trim();
  if(!big || !scn){
    alert("è¯·å…ˆåœ¨ Step1 å¡«å†™ï¼šå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ + çœŸå®åœºæ™¯æè¿°ã€‚");
    return;
  }

  const payload = {
    step1: {
      bigProblem: state.step1.bigProblem,
      scenario: state.step1.scenario,
      kpiGap: state.step1.gap,
      ideal: state.step1.ideal,
      idealKpi: state.step1.idealKpi,
      currentKpi: state.step1.currentKpi
    }
  };

  const res = await callAI({systemPrompt:S1_PROMPT, payload, outEl, statusEl});
  state.ai.s1 = res.json;
  saveState();

  if(res.json && Array.isArray(res.json.hypotheses)){
    // push to Step2 (overwrite)
    state.step1.rootWhy = res.json.root_why_question || "";
    state.step2.hypotheses = res.json.hypotheses.map(h=>({
      id: uuid(),
      text: (h.text || "").trim(),
      dimension: (h.dimension || "").trim(),
      evidence: "",
      importance: 3,
      urgency: 3
    })).filter(x=>x.text);

    // clear Step3/4/5/6 dependent content to avoid mismatch (keep if you want; here we reset)
    state.step3.keyProblems = [];
    state.step4.nodes = [];
    state.step4.selectedNodeId = "";
    state.step5.items = [];
    state.step6.countermeasures = [];
    state.step6.tasks = [];

    saveState();
    renderStep2();
    setActiveTab("step2");
    document.getElementById("ai-s2-out").textContent = "âœ… Step1 å·²ç”Ÿæˆå¹¶æ¨é€å‡è®¾é—®é¢˜ã€‚è¯·åœ¨è¡¨æ ¼ä¸­è¡¥å……è¯æ®ã€æ‰“é‡è¦åº¦/ç´§æ€¥åº¦ï¼Œç„¶åç‚¹å‡»â€œAIæ•™ç»ƒè¯„ä»·å¹¶æ¨é€Top3â€ã€‚";
  }else{
    // keep raw output
  }
});

/* ===========================
   Step2 æ¸²æŸ“ & è¯æ®æ£€æ ¸æ¨é€
=========================== */
const elS2Big = document.getElementById("s2-big");
const elS2Tbody = document.getElementById("s2-tbody");

function computePriority(h){
  const imp = Number(h.importance||0);
  const urg = Number(h.urgency||0);
  return imp * urg;
}
function prioClass(p){
  if(p>=20) return "prio high";
  if(p>=12) return "prio mid";
  return "prio low";
}
function renderStep2(){
  elS2Big.value = state.step1.bigProblem || "";
  elS2Tbody.innerHTML = "";
  const list = state.step2.hypotheses || [];
  list.forEach((h, idx)=>{
    const p = computePriority(h);
    const hasEvi = !!(h.evidence || "").trim();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td>
        <textarea data-id="${h.id}" data-f="text" placeholder="æ˜¯å¦å­˜åœ¨â€¦é—®é¢˜ï¼Ÿ">${escapeHtml(h.text)}</textarea>
        <div class="small">å»ºè®®ä¿æŒâ€œæ˜¯å¦å­˜åœ¨â€¦é—®é¢˜ï¼Ÿâ€å¥å¼ã€‚</div>
      </td>
      <td>
        <select data-id="${h.id}" data-f="dimension">
          ${["æµç¨‹/æ—¶é—´","ç»“æ„/è¦ç´ ","è§’è‰²/èƒ½åŠ›","ç³»ç»Ÿ/å·¥å…·","è§„åˆ™/æœºåˆ¶","æ•°æ®/ä¿¡æ¯","å…¶å®ƒ"].map(opt=>`<option value="${opt}" ${opt===h.dimension?"selected":""}>${opt}</option>`).join("")}
        </select>
      </td>
      <td>
        <textarea data-id="${h.id}" data-f="evidence" placeholder="å†™æ˜è¯æ®/é™„ä»¶/é“¾æ¥/æ•°æ®å£å¾„ï¼ˆéç©ºå³å¯è§†ä¸ºå·²æä¾›è¯æ®ï¼‰">${escapeHtml(h.evidence||"")}</textarea>
      </td>
      <td class="center">
        <input data-id="${h.id}" data-f="importance" type="number" min="1" max="5" value="${Number(h.importance||3)}"/>
      </td>
      <td class="center">
        <input data-id="${h.id}" data-f="urgency" type="number" min="1" max="5" value="${Number(h.urgency||3)}"/>
      </td>
      <td class="center"><span id="s2-prio-${h.id}" class="${prioClass(p)}">${p}</span></td>
      <td class="center"><span id="s2-evi-${h.id}" class="pill ${hasEvi ? "evi-ok" : "evi-miss"}">${hasEvi ? "å·²æä¾›" : "ç¼ºè¯æ®"}</span></td>
    `;
    elS2Tbody.appendChild(tr);
  });
}
renderStep2();

elS2Tbody.addEventListener("input", (e)=>{
  const t = e.target;
  const id = t.dataset.id;
  const f = t.dataset.f;
  if(!id || !f) return;
  const item = state.step2.hypotheses.find(x=>x.id===id);
  if(!item) return;

  // å†™å…¥æ•°æ®
  if(f==="importance" || f==="urgency"){
    item[f] = Number(t.value||3);
  }else{
    item[f] = t.value;
  }

  // å…³é”®ï¼šä¸è¦æ¯æ¬¡è¾“å…¥éƒ½æ•´è¡¨é‡æ¸²æŸ“ï¼Œå¦åˆ™ textarea ä¼šå¤±å»å…‰æ ‡ï¼Œå¯¼è‡´â€œæ— æ³•è¾“å…¥â€çš„ä½“éªŒ
  const p = computePriority(item);
  const prioEl = document.getElementById(`s2-prio-${id}`);
  if(prioEl){
    prioEl.textContent = String(p);
    prioEl.className = prioClass(p);
  }
  const hasEvi = !!(item.evidence || "").trim();
  const eviEl = document.getElementById(`s2-evi-${id}`);
  if(eviEl){
    eviEl.className = `pill ${hasEvi ? "evi-ok" : "evi-miss"}`;
    eviEl.textContent = hasEvi ? "å·²æä¾›" : "ç¼ºè¯æ®";
  }

  saveState();
});


document.getElementById("btn-s2-sort").addEventListener("click", ()=>{
  state.step2.hypotheses.sort((a,b)=> computePriority(b)-computePriority(a));
  saveState();
  renderStep2();
});

document.getElementById("btn-s2-to-step3").addEventListener("click", ()=> setActiveTab("step3"));

document.getElementById("btn-s2-check-push").addEventListener("click", ()=>{
  const out = document.getElementById("ai-s2-out");
  const status = document.getElementById("ai-s2-status");

  // Evidence check only (no LLM)
  const withEvi = state.step2.hypotheses
    .map(h=>({h, p: computePriority(h)}))
    .filter(x=> (x.h.evidence||"").trim().length>0)
    .sort((a,b)=> b.p - a.p);

  const selected = withEvi.slice(0,3);

  const missing = state.step2.hypotheses
    .filter(h=> !(h.evidence||"").trim())
    .map(h=> h.text);

  status.textContent = "AIå·²å®Œæˆè¯æ®æ£€æ ¸ã€‚";
  out.textContent =
    `è¯æ®æ£€æ ¸ç»“æœï¼š\\n` +
    `- å·²æä¾›è¯æ®ï¼š${withEvi.length} æ¡\\n` +
    `- ç¼ºè¯æ®ï¼š${missing.length} æ¡\\n\\n` +
    (missing.length ? `ç¼ºè¯æ®çš„å‡è®¾ï¼ˆè¯·è¡¥å……ï¼‰ï¼š\\n- ${missing.slice(0,8).join("\\n- ")}\\n\\n` : "") +
    `æ¨é€è§„åˆ™ï¼šä¼˜å…ˆçº§æœ€é«˜ä¸”æœ‰è¯æ®çš„ Top3ã€‚\\n` +
    `æœ¬æ¬¡å°†æ¨é€ï¼š\\n` +
    (selected.length ? selected.map((x,i)=>`${i+1}. ${x.h.text}ï¼ˆä¼˜å…ˆçº§=${x.p}ï¼‰`).join("\\n") : "ï¼ˆæš‚æ— å¯æ¨é€ï¼šè¯·å…ˆä¸ºè‡³å°‘3æ¡å‡è®¾è¡¥å……è¯æ®ï¼‰");

  // Push to Step3
  if(selected.length){
    const newKeyProblems = selected.map(x=>{
      const existing = state.step3.keyProblems.find(k=>k.hypoId===x.h.id);
      return {
        id: existing?.id || uuid(),
        hypoId: x.h.id,
        text: x.h.text,
        evidence: x.h.evidence,
        importance: Number(x.h.importance||3),
        urgency: Number(x.h.urgency||3),
        priority: x.p,
        goal: existing?.goal || "",
        aiGoal: existing?.aiGoal || ""
      };
    });
    state.step3.keyProblems = newKeyProblems;
    saveState();
    renderStep3();
    setActiveTab("step3");
  }
});

/* ===========================
   Step3 æ¸²æŸ“ & AIç›®æ ‡ä¼˜åŒ–
=========================== */
const elS3Tbody = document.getElementById("s3-tbody");

function renderStep3(){
  elS3Tbody.innerHTML = "";
  const list = state.step3.keyProblems || [];
  list.forEach((k, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td><div style="font-weight:900;">${escapeHtml(k.text)}</div>
          <div class="small">ä¼˜å…ˆçº§ï¼š${k.priority}</div>
      </td>
      <td><textarea data-id="${k.id}" data-f="evidence" readonly style="background:#f3f4f6;">${escapeHtml(k.evidence||"")}</textarea></td>
      <td>
        <textarea data-id="${k.id}" data-f="goal" placeholder="å†™ä¸€ä¸ªå¯æ§ã€æ¸…æ™°ã€å¯æ£€éªŒçš„ç›®æ ‡æè¿°">${escapeHtml(k.goal||"")}</textarea>
        ${k.aiGoal ? `<div class="small"><span class="pill">AIå»ºè®®</span> ${escapeHtml(k.aiGoal)}</div>` : ``}
      </td>
    `;
    elS3Tbody.appendChild(tr);
  });
}
renderStep3();

elS3Tbody.addEventListener("input", (e)=>{
  const t=e.target;
  const id=t.dataset.id;
  const f=t.dataset.f;
  if(!id || !f) return;
  const item = state.step3.keyProblems.find(x=>x.id===id);
  if(!item) return;
  item[f]=t.value;
  saveState();
});

const S3_PROMPT = `
ä½ æ˜¯ä¸€åâ€œç›®æ ‡è®¾å®šâ€ä¸“å®¶ï¼ˆåŒæ—¶æ‡‚ä¼ä¸šé—®é¢˜åˆ†æä¸è§£å†³ï¼‰ã€‚
ä½ ä¼šå¾—åˆ°ï¼šå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ã€çœŸå®åœºæ™¯æè¿°ã€ä»¥åŠ Step2 æ¨é€çš„ Top3 å…³é”®é—®é¢˜ï¼ˆå¸¦è¯æ®ï¼‰å’Œç”¨æˆ·å†™çš„ç›®æ ‡æè¿°ã€‚

ä»»åŠ¡ï¼š
1) é€æ¡è¯„ä»·æ¯ä¸ªå…³é”®é—®é¢˜çš„ç›®æ ‡æè¿°æ˜¯å¦æ°å½“åˆç†ï¼ˆå¯æ§ã€æ¸…æ™°ã€å¯æ£€éªŒã€ä¸é—®é¢˜åŒ¹é…ï¼‰
2) å¦‚æœä¸æ°å½“ï¼Œç»™å‡ºâ€œä¼˜åŒ–åçš„ç›®æ ‡æè¿°â€ï¼ˆæ›´å…·ä½“ã€æ›´å¯æ“ä½œã€å¯éªŒè¯ï¼‰
3) ç›®æ ‡æè¿°è¯·å°½é‡é¿å…ç©ºè¯ï¼ˆå¦‚â€œåŠ å¼ºâ€â€œæå‡â€â€œä¼˜åŒ–â€ä½†æ²¡æœ‰æ ‡å‡†ï¼‰
4) è¾“å‡º JSONï¼ˆä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ï¼‰

è¾“å‡ºæ ¼å¼ï¼š
{
  "coach_comment":"æ€»ä½“è¯„ä»·ï¼ˆä¸€å¥è¯ï¼‰",
  "items":[
    {
      "key_problem_id":"...",
      "goal_quality":"ç®€çŸ­è¯„ä»·ï¼ˆä¾‹å¦‚ï¼šè¾ƒæ¸…æ™°/åç©ºæ³›/ä¸å¯æ§/ç¼ºå°‘éªŒæ”¶æ ‡å‡†â€¦ï¼‰",
      "optimized_goal":"ä¼˜åŒ–åçš„ç›®æ ‡æè¿°ï¼ˆå¯ç•™ç©ºè¡¨ç¤ºæ— éœ€ä¿®æ”¹ï¼‰"
    }
  ],
  "overall_suggestions":["å»ºè®®1","å»ºè®®2"]
}
`;

document.getElementById("btn-ai-s3").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s3-out");
  const statusEl = document.getElementById("ai-s3-status");
  if(!state.step3.keyProblems.length){
    alert("Step3 å½“å‰æ²¡æœ‰å…³é”®é—®é¢˜ã€‚è¯·å…ˆåœ¨ Step2 æ¨é€Top3ã€‚");
    return;
  }
  const payload = {
    step1:{
      bigProblem: state.step1.bigProblem,
      scenario: state.step1.scenario,
      kpiGap: state.step1.gap
    },
    step3:{
      keyProblems: state.step3.keyProblems.map(k=>({
        key_problem_id: k.id,
        text: k.text,
        evidence: k.evidence,
        goal: k.goal
      }))
    }
  };
  const res = await callAI({systemPrompt:S3_PROMPT, payload, outEl, statusEl});
  state.ai.s3 = res.json;
  saveState();
  // render aiGoal in table after apply
});

document.getElementById("btn-ai-s3-apply").addEventListener("click", ()=>{
  const j = state.ai.s3;
  if(!j || !Array.isArray(j.items)){
    alert("æ²¡æœ‰å¯ç”¨çš„AIç»“æœï¼Œè¯·å…ˆç‚¹å‡»â€œAIæ•™ç»ƒè¯„ä»·ç›®æ ‡â€ã€‚");
    return;
  }
  j.items.forEach(it=>{
    const kp = state.step3.keyProblems.find(k=>k.id===it.key_problem_id);
    if(!kp) return;
    if(it.optimized_goal){
      kp.aiGoal = it.optimized_goal;
      // å¯é€‰æ‹©ç›´æ¥è¦†ç›–ç”¨æˆ·ç›®æ ‡ï¼Œæˆ–ä¿ç•™ä¸ºå»ºè®®ã€‚è¿™é‡Œï¼šå¦‚æœç”¨æˆ·ç›®æ ‡ä¸ºç©ºåˆ™è¦†ç›–ï¼›å¦åˆ™ä¿ç•™ä¸ºAIå»ºè®®ã€‚
      if(!(kp.goal||"").trim()){
        kp.goal = it.optimized_goal;
      }
    }
  });
  saveState();
  renderStep3();
  alert("å·²å†™å…¥ AI ä¼˜åŒ–ç›®æ ‡ï¼ˆç©ºç›®æ ‡å°†è‡ªåŠ¨å¡«å…¥ï¼Œå…¶ä½™ä½œä¸ºAIå»ºè®®æ˜¾ç¤ºï¼‰ã€‚");
});

/* ===========================
   Step4 åŸå› æ ‘ï¼šæ„å»º/ç¼–è¾‘/AIè¯„ä»·
=========================== */
const elS4Tree = document.getElementById("s4-tree");
const elS4Parent = document.getElementById("s4-parent");
const elS4New = document.getElementById("s4-new");
const elS4Evi = document.getElementById("s4-evi");
const elS4SelId = document.getElementById("s4-sel-id");
const elS4SelText = document.getElementById("s4-sel-text");
const elS4SelEvi = document.getElementById("s4-sel-evi");
const elS4List = document.getElementById("s4-list");

document.getElementById("btn-s3-to-step4").addEventListener("click", ()=> setActiveTab("step4"));
document.getElementById("btn-s3-sync-step4").addEventListener("click", ()=>{
  syncStep4FromStep3();
  renderStep4();
  setActiveTab("step4");
});

function bigToWhy(big){
  const s = (big||"").trim();
  if(!s) return "";
  if(s.startsWith("ä¸ºä»€ä¹ˆ")) return s.endsWith("ï¼Ÿ")||s.endsWith("?") ? s : s + "ï¼Ÿ";
  // remove trailing punctuation
  const cleaned = s.replace(/[ï¼Ÿ?ã€‚.!ï¼]+$/g,"");
  return "ä¸ºä»€ä¹ˆ" + cleaned + "ï¼Ÿ";
}
function hypoToKeyStatement(hypoText){
  // turn "æ˜¯å¦å­˜åœ¨xxxé—®é¢˜ï¼Ÿ" -> "xxxä¸åˆ°ä½"
  let t = (hypoText||"").trim();
  if(!t) return "";
  t = t.replace(/^æ˜¯å¦å­˜åœ¨/g,"").replace(/[ï¼Ÿ?ã€‚.!ï¼]+$/g,"");
  t = t.replace(/çš„é—®é¢˜$/g,"").replace(/é—®é¢˜$/g,"").trim();
  // If contains "ä¸" already, keep.
  if(/ä¸/.test(t)) return t;
  return t + "ä¸åˆ°ä½";
}

function ensureNode(node){
  if(!state.step4.nodes.find(n=>n.id===node.id)) state.step4.nodes.push(node);
}

function syncStep4FromStep3(){
  // build root node
  const rootId = "root";
  const rootText = state.step1.rootWhy || bigToWhy(state.step1.bigProblem);
  state.step1.rootWhy = rootText;
  // reset if no nodes yet? We'll ensure root exists
  ensureNode({id:rootId, parentId:"", text: rootText || "ä¸ºä»€ä¹ˆï¼ˆè¯·å›åˆ°Step1å¡«å†™å¤§é—®é¢˜ï¼‰ï¼Ÿ", evidence:"", type:"root", keyProblemId:""});
  // ensure key problem nodes as children of root
  state.step3.keyProblems.forEach(kp=>{
    const keyNodeId = "key-" + kp.id;
    const existing = state.step4.nodes.find(n=>n.id===keyNodeId);
    const text = existing?.text || hypoToKeyStatement(kp.text);
    if(existing){
      existing.parentId = rootId;
      if(!existing.keyProblemId) existing.keyProblemId = kp.id;
      // keep user-edited text
    }else{
      state.step4.nodes.push({id:keyNodeId, parentId:rootId, text, evidence:"", type:"key", keyProblemId: kp.id});
    }
  });
  // remove key nodes that are no longer in step3
  const validKeyIds = new Set(state.step3.keyProblems.map(kp=>"key-"+kp.id));
  state.step4.nodes = state.step4.nodes.filter(n=>{
    if(n.type!=="key") return true;
    return validKeyIds.has(n.id);
  });
  // keep root always
  saveState();
}

function childrenOf(parentId){
  return state.step4.nodes.filter(n=>n.parentId===parentId);
}
function nodeById(id){ return state.step4.nodes.find(n=>n.id===id); }
function depthOf(id){
  let d=0; let cur=nodeById(id);
  while(cur && cur.parentId){ d++; cur=nodeById(cur.parentId); }
  return d;
}
function isLeaf(id){
  return childrenOf(id).length===0;
}

function buildTreeHtml(rootId){
  const root = nodeById(rootId);
  if(!root) return "<div class='small'>ï¼ˆæš‚æ— åŸå› æ ‘ï¼Œè¯·åœ¨Step3ç‚¹å‡»â€œåŒæ­¥åˆ°Step4åŸå› æ ‘â€ï¼‰</div>";

  function renderNode(n){
    const tag = n.type==="root" ? "æ ¹é—®é¢˜(WHY)" : (n.type==="key" ? "å…³é”®é—®é¢˜" : "WHY");
    const sub = n.evidence ? ("éªŒè¯/è¯æ®ï¼š" + n.evidence) : "";
    return `
      <div class="node" data-node="${n.id}">
        <div class="node-top">
          <span class="node-tag">${tag}</span>
          <span class="small">${isLeaf(n.id) && n.type!=="root" ? "å¶å­" : ""}</span>
        </div>
        <div class="node-text">${escapeHtml(n.text)}</div>
        ${sub ? `<div class="node-sub">${escapeHtml(sub)}</div>` : ``}
      </div>
    `;
  }

  function renderBranch(parentId){
    const kids = childrenOf(parentId);
    if(!kids.length) return "";
    return `
      <ul>
        ${kids.map(k=>`
          <li>
            ${renderNode(k)}
            ${renderBranch(k.id)}
          </li>
        `).join("")}
      </ul>
    `;
  }

  return `
    <div class="tree">
      <ul>
        <li>
          ${renderNode(root)}
          ${renderBranch(root.id)}
        </li>
      </ul>
    </div>
  `;
}

function renderStep4(){
  // ensure tree exists from step3
  if(!state.step4.nodes.length && state.step3.keyProblems.length){
    syncStep4FromStep3();
  }

  elS4Tree.innerHTML = buildTreeHtml("root");

  // parent select options
  elS4Parent.innerHTML = "";
  state.step4.nodes.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n.id;
    opt.textContent = `${"Â·".repeat(Math.min(6, depthOf(n.id)))} ${n.text.slice(0,40)}`;
    elS4Parent.appendChild(opt);
  });
  // default parent = selected or root
  elS4Parent.value = state.step4.selectedNodeId || "root";

  // selected node area
  const selId = state.step4.selectedNodeId || "root";
  selectNode(selId, false);

  // list view
  elS4List.innerHTML = "";
  const nodesSorted = [...state.step4.nodes].sort((a,b)=> depthOf(a.id) - depthOf(b.id));
  nodesSorted.forEach(n=>{
    const parent = n.parentId ? (nodeById(n.parentId)?.text || "") : "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${depthOf(n.id)}</td>
      <td><div style="font-weight:900;">${escapeHtml(n.text)}</div><div class="small">${escapeHtml(n.id)}</div></td>
      <td>${escapeHtml(parent)}</td>
      <td>${escapeHtml(n.evidence||"")}</td>
    `;
    elS4List.appendChild(tr);
  });
}
renderStep4();

function selectNode(id, scrollIntoView=true){
  const n = nodeById(id);
  if(!n) return;
  state.step4.selectedNodeId = id;
  saveState();
  elS4SelId.textContent = id;
  elS4SelText.value = n.text || "";
  elS4SelEvi.value = n.evidence || "";
  // set parent select to this node for adding next level
  elS4Parent.value = id;
  if(scrollIntoView){
    // highlight? (simple)
  }
}

elS4Tree.addEventListener("click", (e)=>{
  const nodeEl = e.target.closest(".node");
  if(!nodeEl) return;
  const id = nodeEl.dataset.node;
  selectNode(id);
});

document.getElementById("btn-s4-add").addEventListener("click", ()=>{
  const parentId = elS4Parent.value;
  const text = (elS4New.value||"").trim();
  if(!parentId) { alert("è¯·é€‰æ‹©çˆ¶èŠ‚ç‚¹"); return; }
  if(!text) { alert("è¯·å¡«å†™ä¸‹ä¸€å±‚WHYæè¿°"); return; }
  const parent = nodeById(parentId);
  const keyProblemId = parent?.keyProblemId || (parent?.type==="key" ? parent.keyProblemId : "");
  const newNode = {
    id: uuid(),
    parentId,
    text,
    evidence: (elS4Evi.value||"").trim(),
    type: "why",
    keyProblemId
  };
  state.step4.nodes.push(newNode);
  elS4New.value = "";
  elS4Evi.value = "";
  saveState();
  renderStep4();
  selectNode(newNode.id);
});

document.getElementById("btn-s4-save").addEventListener("click", ()=>{
  const id = state.step4.selectedNodeId;
  const n = nodeById(id);
  if(!n) return;
  n.text = elS4SelText.value;
  n.evidence = elS4SelEvi.value;
  saveState();
  renderStep4();
  alert("å·²ä¿å­˜èŠ‚ç‚¹ä¿®æ”¹ã€‚");
});

function deleteNodeAndChildren(id){
  if(id==="root"){ alert("æ ¹èŠ‚ç‚¹ä¸èƒ½åˆ é™¤"); return; }
  const toDelete = new Set();
  function dfs(x){
    toDelete.add(x);
    childrenOf(x).forEach(c=> dfs(c.id));
  }
  dfs(id);
  state.step4.nodes = state.step4.nodes.filter(n=> !toDelete.has(n.id));
}

document.getElementById("btn-s4-delete").addEventListener("click", ()=>{
  const id = state.step4.selectedNodeId;
  if(!id || id==="root"){ alert("è¯·é€‰æ‹©éæ ¹èŠ‚ç‚¹åˆ é™¤"); return; }
  if(!confirm("ç¡®å®šåˆ é™¤è¯¥èŠ‚ç‚¹åŠå…¶æ‰€æœ‰ä¸‹çº§èŠ‚ç‚¹å—ï¼Ÿ")) return;
  deleteNodeAndChildren(id);
  state.step4.selectedNodeId = "root";
  saveState();
  renderStep4();
});

function pushLeavesToStep5(){
  // leaves exclude root
  const leaves = state.step4.nodes.filter(n=> n.id!=="root" && isLeaf(n.id));
  // build items, keep existing countermeasures if same leafNodeId
  const newItems = leaves.map(l=>{
    const existing = state.step5.items.find(it=>it.leafNodeId===l.id);
    return {
      id: existing?.id || uuid(),
      leafNodeId: l.id,
      leafText: l.text,
      keyProblemId: l.keyProblemId || "",
      countermeasure: existing?.countermeasure || "",
      note: existing?.note || "",
      aiCountermeasure: existing?.aiCountermeasure || ""
    };
  });
  state.step5.items = newItems;
  saveState();
  renderStep5();
}

document.getElementById("btn-s4-push-step5").addEventListener("click", ()=>{
  pushLeavesToStep5();
  alert("å·²æ¨é€æœ«ç«¯åŸå› åˆ° Step5ã€‚");
});
document.getElementById("btn-s4-to-step5").addEventListener("click", ()=> setActiveTab("step5"));

const S4_PROMPT = `
ä½ æ˜¯ä¸€åèµ„æ·±â€œæ ¹å› åˆ†æ/WHYæ ‘â€æ•™ç»ƒï¼ˆå…·å¤‡ä¼ä¸šç®¡ç†ä¸æµç¨‹æ”¹å–„ç»éªŒï¼‰ã€‚
ä½ ä¼šæ”¶åˆ°ï¼šæ ¹é—®é¢˜ï¼ˆä¸ºä»€ä¹ˆâ€¦ï¼Ÿï¼‰ã€å…³é”®é—®é¢˜åˆ†æ”¯ï¼ˆä¸åˆ°ä½/ä¸åŠæ—¶â€¦ï¼‰ï¼Œä»¥åŠç”¨æˆ·è¡¥å……çš„å¤šå±‚WHYèŠ‚ç‚¹ï¼ˆå¸¦çˆ¶å­å…³ç³»ä¸è¯æ®å­—æ®µï¼‰ã€‚

ä½ çš„ä»»åŠ¡ï¼ˆä¸¥æ ¼æŒ‰è¦æ±‚ï¼‰ï¼š
1) é€æ¡æ£€æŸ¥çˆ¶å­å…³ç³»æ˜¯å¦ä¸ºâ€œç›´æ¥å› æœâ€ã€‚å¦‚æœä¸æ˜¯ï¼ŒæŒ‡å‡ºé—®é¢˜å¹¶ç»™å‡ºå»ºè®®æ”¹å†™ï¼ˆè®©å®ƒå˜æˆç›´æ¥å› æœï¼‰ã€‚
2) æ£€æŸ¥åŸå› æ˜¯å¦é€æ¸èµ°å‘â€œä¸å¯æ§å› ç´ â€ï¼ˆå¦‚ç¯å¢ƒã€æ”¿ç­–ã€å®è§‚å¸‚åœºï¼‰ã€‚è‹¥å‡ºç°ä¸å¯æ§ï¼Œè¯·æŠŠå®ƒæ”¹å†™ä¸ºå¯æ§åŸå› ï¼ˆç”¨æˆ·å¯è¡ŒåŠ¨ã€å¯éªŒè¯ï¼‰ã€‚
3) è¾“å‡ºä¸€ç»„â€œæ¨èæ”¹å†™ rewritesâ€ï¼Œåªæ”¹å†™æ–‡æœ¬ï¼Œä¸è¦åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œä¸è¦åˆ é™¤èŠ‚ç‚¹ã€‚
4) è¾“å‡º JSONï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—ã€‚

è¾“å‡ºæ ¼å¼ï¼š
{
  "coach_comment":"æ€»ä½“è¯„ä»·ï¼ˆä¸€å¥è¯ï¼‰",
  "relation_issues":[
    {"child_id":"...","parent_id":"...","issue":"é—®é¢˜ç‚¹","suggest_rewrite_child":"æ”¹å†™åçš„childæ–‡æœ¬"}
  ],
  "uncontrollable_issues":[
    {"node_id":"...","issue":"ä¸ºä»€ä¹ˆä¸å¯æ§","suggest_rewrite":"æ›´å¯æ§çš„æ”¹å†™æ–‡æœ¬"}
  ],
  "rewrites":[
    {"node_id":"...","rewritten_text":"æ”¹å†™åçš„æ–‡æœ¬"}
  ],
  "notes":["å»ºè®®1","å»ºè®®2"]
}
`;

document.getElementById("btn-ai-s4").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s4-out");
  const statusEl = document.getElementById("ai-s4-status");
  if(!state.step4.nodes.length){
    alert("åŸå› æ ‘ä¸ºç©ºã€‚è¯·å…ˆåœ¨ Step3 ç‚¹å‡»â€œåŒæ­¥åˆ°Step4åŸå› æ ‘â€ã€‚");
    return;
  }
  const payload = {
    step1:{
      rootWhy: state.step1.rootWhy || bigToWhy(state.step1.bigProblem),
      bigProblem: state.step1.bigProblem,
      scenario: state.step1.scenario
    },
    keyProblems: state.step3.keyProblems.map(k=>({id:k.id, text:k.text, goal:k.goal})),
    treeNodes: state.step4.nodes.map(n=>({
      id:n.id, parentId:n.parentId, type:n.type, text:n.text, evidence:n.evidence
    }))
  };
  const res = await callAI({systemPrompt:S4_PROMPT, payload, outEl, statusEl});
  state.ai.s4 = res.json;
  saveState();
});

document.getElementById("btn-ai-s4-apply-push").addEventListener("click", ()=>{
  const j = state.ai.s4;
  if(!j || !Array.isArray(j.rewrites)){
    alert("æ²¡æœ‰å¯ç”¨çš„AIæ”¹å†™ç»“æœã€‚è¯·å…ˆç‚¹å‡»â€œAIæ•™ç»ƒè¯„ä»·åŸå› æ ‘â€ã€‚");
    return;
  }
  j.rewrites.forEach(r=>{
    const n = nodeById(r.node_id);
    if(n && r.rewritten_text){
      n.text = r.rewritten_text;
    }
  });
  saveState();
  renderStep4();
  pushLeavesToStep5();
  setActiveTab("step5");
  document.getElementById("ai-s5-out").textContent = "âœ… Step4 å·²åº”ç”¨AIæ”¹å†™ï¼Œå¹¶æ¨é€æœ«ç«¯åŸå› åˆ° Step5ã€‚è¯·é€æ¡å¡«å†™å¯¹ç­–åå†ç‚¹å‡»AIä¼˜åŒ–ã€‚";
});

/* ===========================
   Step5 æ¸²æŸ“ & AIå¯¹ç­–ä¼˜åŒ–
=========================== */
const elS5Tbody = document.getElementById("s5-tbody");

function renderStep5(){
  elS5Tbody.innerHTML = "";
  const list = state.step5.items || [];
  list.forEach((it, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td><div style="font-weight:900;">${escapeHtml(it.leafText)}</div><div class="small">leaf=${escapeHtml(it.leafNodeId)}</div></td>
      <td>
        <textarea data-id="${it.id}" data-f="countermeasure" placeholder="å¡«å†™èƒ½ç›´æ¥ä½œç”¨äºè¯¥åŸå› çš„å¯¹ç­–ï¼ˆå°½é‡å…·ä½“å¯æ‰§è¡Œï¼‰">${escapeHtml(it.countermeasure||"")}</textarea>
        ${it.aiCountermeasure ? `<div class="small"><span class="pill">AIä¼˜åŒ–</span> ${escapeHtml(it.aiCountermeasure)}</div>` : ``}
      </td>
      <td><textarea data-id="${it.id}" data-f="note" placeholder="å¯é€‰ï¼šé£é™©/èµ„æº/å‰ç½®æ¡ä»¶">${escapeHtml(it.note||"")}</textarea></td>
    `;
    elS5Tbody.appendChild(tr);
  });
}
renderStep5();

elS5Tbody.addEventListener("input", (e)=>{
  const t=e.target;
  const id=t.dataset.id; const f=t.dataset.f;
  if(!id||!f) return;
  const it = state.step5.items.find(x=>x.id===id);
  if(!it) return;
  it[f]=t.value;
  saveState();
});

document.getElementById("btn-s5-to-step6").addEventListener("click", ()=> setActiveTab("step6"));

const S5_PROMPT = `
ä½ æ˜¯ä¸€åè·¨é¢†åŸŸçš„â€œå¯¹ç­–è®¾è®¡â€ä¸“å®¶ï¼ˆåŒæ—¶æ‡‚æµç¨‹ã€ç»„ç»‡ã€æ•°æ®ã€äº§å“ã€è¿è¥ã€åŸ¹è®­ï¼‰ã€‚
ä½ ä¼šå¾—åˆ°ï¼šçœŸå®åœºæ™¯ã€æœ«ç«¯åŸå› åˆ—è¡¨ã€ä»¥åŠç”¨æˆ·ä¸ºæ¯ä¸ªæœ«ç«¯åŸå› å†™çš„å¯¹ç­–ã€‚

è¦æ±‚ï¼š
1) é€æ¡åˆ¤æ–­å¯¹ç­–æ˜¯å¦çœŸæ­£èƒ½ä½œç”¨äºè¯¥æœ«ç«¯åŸå› ï¼ˆæœ‰æ•ˆ/ä¸å¤Ÿç²¾å‡†/æ— æ•ˆï¼‰ï¼Œå¹¶ç®€è¿°åŸå› ï¼ˆéå¸¸çŸ­å³å¯ï¼‰
2) ç»™å‡ºâ€œæ›´ç²¾å‡†çš„ä¼˜åŒ–å¯¹ç­– optimized_countermeasureâ€ï¼Œå¿…é¡»èƒ½å¤Ÿæ›´ç›´æ¥åœ°æ”¹å˜è¯¥åŸå› ï¼ˆå¯åŒ…å«åˆ›æ–°åšæ³•ï¼Œä½†è¦å¯è½åœ°ï¼‰
3) å¦‚æœç”¨æˆ·å¯¹ç­–ä¸ºç©ºï¼Œä¹Ÿè¦ç»™å‡ºä¸€ä¸ªå»ºè®®å¯¹ç­–
4) è¾“å‡ºä¸¥æ ¼JSONï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—

è¾“å‡ºæ ¼å¼ï¼š
{
  "coach_comment":"æ€»ä½“è¯„ä»·ï¼ˆä¸€å¥è¯ï¼‰",
  "items":[
    {
      "item_id":"Step5è¡Œid",
      "leaf_cause":"æœ«ç«¯åŸå› æ–‡æœ¬ï¼ˆå¤è¿°ï¼‰",
      "judgement":"æœ‰æ•ˆ/ä¸å¤Ÿç²¾å‡†/æ— æ•ˆ/ç¼ºå¤±",
      "why":"ä¸€å¥è¯åŸå› ",
      "optimized_countermeasure":"ä¼˜åŒ–åçš„å¯¹ç­–ï¼ˆå¯è½åœ°ï¼‰",
      "alternatives":["å¤‡é€‰1","å¤‡é€‰2"]
    }
  ],
  "overall_suggestions":["å»ºè®®1","å»ºè®®2"]
}
`;

document.getElementById("btn-ai-s5").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s5-out");
  const statusEl = document.getElementById("ai-s5-status");
  if(!state.step5.items.length){
    alert("Step5 å½“å‰æ²¡æœ‰æœ«ç«¯åŸå› ã€‚è¯·å…ˆåœ¨ Step4 æ¨é€ã€‚");
    return;
  }
  const payload = {
    step1:{
      bigProblem: state.step1.bigProblem,
      scenario: state.step1.scenario
    },
    leafItems: state.step5.items.map(it=>({
      item_id: it.id,
      leafNodeId: it.leafNodeId,
      leafCause: it.leafText,
      userCountermeasure: it.countermeasure,
      note: it.note
    }))
  };
  const res = await callAI({systemPrompt:S5_PROMPT, payload, outEl, statusEl});
  state.ai.s5 = res.json;
  saveState();
});

document.getElementById("btn-ai-s5-apply").addEventListener("click", ()=>{
  const j = state.ai.s5;
  if(!j || !Array.isArray(j.items)){
    alert("æ²¡æœ‰å¯ç”¨çš„AIç»“æœï¼Œè¯·å…ˆç‚¹å‡»â€œAIæ•™ç»ƒè¯„ä»·å¯¹ç­–â€ã€‚");
    return;
  }
  j.items.forEach(x=>{
    const it = state.step5.items.find(i=>i.id===x.item_id);
    if(!it) return;
    if(x.optimized_countermeasure){
      it.aiCountermeasure = x.optimized_countermeasure;
      if(!(it.countermeasure||"").trim()){
        it.countermeasure = x.optimized_countermeasure;
      }
    }
  });
  saveState();
  renderStep5();
  alert("å·²å†™å…¥ AI ä¼˜åŒ–å¯¹ç­–ï¼ˆç©ºå¯¹ç­–è‡ªåŠ¨å¡«å…¥ï¼Œå…¶ä½™ä½œä¸ºAIä¼˜åŒ–æ˜¾ç¤ºï¼‰ã€‚");
});

function pushCountermeasuresToStep6(){
  const cms = state.step5.items.map(it=>{
    const text = (it.countermeasure||"").trim() || (it.aiCountermeasure||"").trim();
    return {
      id: "cm-" + it.id,
      sourceItemId: it.id,
      text
    };
  }).filter(x=>x.text);

  // keep existing tasks, but ensure countermeasures exist
  state.step6.countermeasures = cms;
  // remove tasks that reference missing countermeasures
  const cmIds = new Set(cms.map(c=>c.id));
  state.step6.tasks = state.step6.tasks.filter(t=> cmIds.has(t.countermeasureId));
  saveState();
  renderStep6();
}

document.getElementById("btn-s5-push-step6").addEventListener("click", ()=>{
  pushCountermeasuresToStep6();
  alert("å·²æ¨é€å¯¹ç­–åˆ° Step6ï¼ˆç¬¬ä¸€åˆ—å°†æ˜¾ç¤ºå¯¹ç­–ï¼‰ã€‚");
});

/* ===========================
   Step6 æ¸²æŸ“ & AIä»»åŠ¡ä¼˜åŒ–
=========================== */
const elS6Cm = document.getElementById("s6-cm");
const elS6Task = document.getElementById("s6-task");
const elS6Owner = document.getElementById("s6-owner");
const elS6Start = document.getElementById("s6-start");
const elS6End = document.getElementById("s6-end");
const elS6Mile = document.getElementById("s6-mile");
const elS6Tbody = document.getElementById("s6-tbody");

function renderStep6(){
  // countermeasure select
  elS6Cm.innerHTML = "";
  (state.step6.countermeasures || []).forEach(cm=>{
    const opt = document.createElement("option");
    opt.value = cm.id;
    opt.textContent = cm.text.slice(0, 80);
    elS6Cm.appendChild(opt);
  });

  // tasks table
  elS6Tbody.innerHTML = "";
  (state.step6.tasks || []).forEach((t, idx)=>{
    const cm = state.step6.countermeasures.find(c=>c.id===t.countermeasureId);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td><div style="font-weight:900;">${escapeHtml(cm?cm.text:"ï¼ˆç¼ºå¤±å¯¹ç­–ï¼‰")}</div></td>
      <td>
        <textarea data-id="${t.id}" data-f="task" placeholder="ä»»åŠ¡æè¿°ï¼ˆå¯éªŒæ”¶ï¼‰">${escapeHtml(t.task||"")}</textarea>
        ${t.aiTask ? `<div class="small"><span class="pill">AIå»ºè®®</span> ${escapeHtml(t.aiTask)}</div>` : ``}
      </td>
      <td><input data-id="${t.id}" data-f="owner" value="${escapeHtml(t.owner||"")}" /></td>
      <td><input data-id="${t.id}" data-f="start" type="date" value="${escapeHtml(t.start||"")}" /></td>
      <td><input data-id="${t.id}" data-f="end" type="date" value="${escapeHtml(t.end||"")}" /></td>
      <td>
        <select data-id="${t.id}" data-f="status">
          ${["æœªå¼€å§‹","è¿›è¡Œä¸­","å·²å®Œæˆ","é˜»å¡"].map(s=>`<option value="${s}" ${s===t.status?"selected":""}>${s}</option>`).join("")}
        </select>
      </td>
      <td class="center"><button class="btn2" data-del="${t.id}" title="åˆ é™¤">âœ•</button></td>
    `;
    elS6Tbody.appendChild(tr);
  });
}
renderStep6();

document.getElementById("btn-s6-add").addEventListener("click", ()=>{
  const cmId = elS6Cm.value;
  const task = (elS6Task.value||"").trim();
  if(!cmId){ alert("è¯·å…ˆæ¨é€å¯¹ç­–åˆ°Step6ï¼Œå¹¶é€‰æ‹©ä¸€æ¡å¯¹ç­–ã€‚"); return; }
  if(!task){ alert("è¯·å¡«å†™å…·ä½“ä»»åŠ¡ã€‚"); return; }
  state.step6.tasks.push({
    id: uuid(),
    countermeasureId: cmId,
    task,
    owner: (elS6Owner.value||"").trim(),
    start: elS6Start.value,
    end: elS6End.value,
    status: "æœªå¼€å§‹",
    milestone: (elS6Mile.value||"").trim(),
    aiTask: ""
  });
  elS6Task.value=""; elS6Mile.value="";
  saveState();
  renderStep6();
});

document.getElementById("btn-s6-sort").addEventListener("click", ()=>{
  state.step6.tasks.sort((a,b)=> (a.end||"").localeCompare(b.end||""));
  saveState(); renderStep6();
});

elS6Tbody.addEventListener("input", (e)=>{
  const t = e.target;
  const id = t.dataset.id;
  const f = t.dataset.f;
  if(!id || !f) return;
  const row = state.step6.tasks.find(x=>x.id===id);
  if(!row) return;
  row[f] = t.value;
  saveState();
});

elS6Tbody.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-del]");
  if(!btn) return;
  const id = btn.dataset.del;
  state.step6.tasks = state.step6.tasks.filter(x=>x.id!==id);
  saveState(); renderStep6();
});

document.getElementById("btn-s6-to-step7").addEventListener("click", ()=> setActiveTab("step7"));

const S6_PROMPT = `
ä½ æ˜¯ä¸€åâ€œæ‰§è¡Œè½åœ°/é¡¹ç›®ç®¡ç†â€ä¸“å®¶ã€‚
ä½ ä¼šæ”¶åˆ°ï¼šå¯¹ç­–æ¸…å•ï¼Œä»¥åŠå›´ç»•å¯¹ç­–æ‹†è§£çš„ä»»åŠ¡æ¸…å•ï¼ˆå«è´£ä»»äººã€æ—¶é—´ã€çŠ¶æ€ï¼‰ã€‚
è¦æ±‚ä½ åªåšï¼šä»»åŠ¡æ˜¯å¦æœ‰æ•ˆæ”¯æŒå¯¹ç­–è½åœ°çš„æ£€æ ¸ä¸æ”¹å†™å»ºè®®ã€‚

ä»»åŠ¡ï¼š
1) é€æ¡åˆ¤æ–­æ¯ä¸ªä»»åŠ¡æ˜¯å¦çœŸæ­£æ”¯æ’‘å…¶å¯¹ç­–ï¼ˆæ”¯æ’‘/éƒ¨åˆ†æ”¯æ’‘/ä¸æ”¯æ’‘ï¼‰
2) å¦‚æœä¸æ”¯æ’‘æˆ–å¤ªç©ºæ³›ï¼Œç»™å‡ºæ›´æœ‰æ•ˆã€æ›´å¯éªŒæ”¶çš„ä»»åŠ¡æ”¹å†™å»ºè®®ï¼ˆai_taskï¼‰
3) è¾“å‡ºä¸¥æ ¼JSONï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—

è¾“å‡ºæ ¼å¼ï¼š
{
  "coach_comment":"æ€»ä½“è¯„ä»·ï¼ˆä¸€å¥è¯ï¼‰",
  "items":[
    {
      "task_id":"ä»»åŠ¡id",
      "judgement":"æ”¯æ’‘/éƒ¨åˆ†æ”¯æ’‘/ä¸æ”¯æ’‘/ç¼ºå¤±",
      "ai_task":"æ”¹å†™åçš„ä»»åŠ¡ï¼ˆå¯éªŒæ”¶ï¼ŒåŠ¨è¯å¼€å¤´ï¼‰"
    }
  ],
  "missing_tasks_suggestions":[
    {"countermeasure":"å¯¹ç­–æ–‡æœ¬","suggested_tasks":["ä»»åŠ¡1","ä»»åŠ¡2"]}
  ]
}
`;

document.getElementById("btn-ai-s6").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s6-out");
  const statusEl = document.getElementById("ai-s6-status");
  if(!state.step6.countermeasures.length){
    alert("Step6 æ²¡æœ‰å¯¹ç­–ã€‚è¯·å…ˆåœ¨ Step5 æ¨é€å¯¹ç­–åˆ° Step6ã€‚");
    return;
  }
  const payload = {
    scenario: state.step1.scenario,
    countermeasures: state.step6.countermeasures,
    tasks: state.step6.tasks
  };
  const res = await callAI({systemPrompt:S6_PROMPT, payload, outEl, statusEl});
  state.ai.s6 = res.json;
  saveState();
});

document.getElementById("btn-ai-s6-apply").addEventListener("click", ()=>{
  const j = state.ai.s6;
  if(!j || !Array.isArray(j.items)){
    alert("æ²¡æœ‰å¯ç”¨çš„AIç»“æœï¼Œè¯·å…ˆç‚¹å‡»â€œAIæ•™ç»ƒè¯„ä»·ä»»åŠ¡â€ã€‚");
    return;
  }
  j.items.forEach(x=>{
    const t = state.step6.tasks.find(r=>r.id===x.task_id);
    if(!t) return;
    if(x.ai_task){
      // ä¿ç•™åŸä»»åŠ¡ï¼Œä¾¿äºè¿½æº¯
      if(t.originalTask===undefined) t.originalTask = t.task || "";
      t.aiTask = x.ai_task;
      // âœ… æŒ‰ç”¨æˆ·è¦æ±‚ï¼šæŠŠä¼˜åŒ–åçš„ä»»åŠ¡ç›´æ¥å†™å›ä»»åŠ¡å­—æ®µï¼Œè‡ªåŠ¨ä½“ç°åœ¨â€œè¡ŒåŠ¨è®¡åˆ’çœ‹æ¿â€é‡Œ
      t.task = x.ai_task;
    }
  });
  saveState();
  renderStep6();
  alert("å·²å°† AI ä¼˜åŒ–åçš„ä»»åŠ¡å†…å®¹å†™å…¥è¡ŒåŠ¨è®¡åˆ’çœ‹æ¿ã€‚");
});


/* ===========================
   Step7 æ¸²æŸ“/ç¼–è¾‘/AI
=========================== */
const elS7Tbody = document.getElementById("s7-tbody");
const elS7Notes = document.getElementById("s7-notes");

function renderStep7(){
  elS7Tbody.innerHTML = "";
  (state.step7.rows||[]).forEach((r, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td><textarea data-id="${r.id}" data-f="label" placeholder="ä¾‹å¦‚ï¼šå‡†æ—¶ç‡/é”™è¯¯ç‡/å®¢æˆ·æ»¡æ„åº¦ç­‰">${escapeHtml(r.label||"")}</textarea></td>
      <td><input data-id="${r.id}" data-f="before" value="${escapeHtml(r.before||"")}" /></td>
      <td><input data-id="${r.id}" data-f="target" value="${escapeHtml(r.target||"")}" /></td>
      <td><input data-id="${r.id}" data-f="after" value="${escapeHtml(r.after||"")}" /></td>
      <td class="center"><span class="pill" style="background:#f3f4f6;border-color:#e5e7eb;color:#111827;">${escapeHtml(r.improve||"")}</span></td>
      <td class="center"><button class="btn2" data-del="${r.id}">âœ•</button></td>
    `;
    elS7Tbody.appendChild(tr);
  });
  elS7Notes.value = state.step7.notes || "";
}
renderStep7();

document.getElementById("btn-s7-add").addEventListener("click", ()=>{
  state.step7.rows.push({id:uuid(), label:"", before:"", target:"", after:"", improve:""});
  saveState(); renderStep7();
});

document.getElementById("btn-s7-calc").addEventListener("click", ()=>{
  state.step7.rows.forEach(r=>{
    const b = Number(r.before); const a = Number(r.after);
    if(!isNaN(b) && !isNaN(a) && b!==0){
      r.improve = (((a-b)/Math.abs(b))*100).toFixed(1) + "%";
    }
  });
  saveState(); renderStep7();
});

elS7Tbody.addEventListener("input", (e)=>{
  const t=e.target;
  const id=t.dataset.id; const f=t.dataset.f;
  if(!id||!f) return;
  const row = state.step7.rows.find(x=>x.id===id);
  if(!row) return;
  row[f]=t.value;
  saveState();
});

elS7Tbody.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-del]");
  if(!btn) return;
  const id=btn.dataset.del;
  state.step7.rows = state.step7.rows.filter(x=>x.id!==id);
  saveState(); renderStep7();
});

elS7Notes.addEventListener("input", ()=>{
  state.step7.notes = elS7Notes.value;
  saveState();
});

document.getElementById("btn-s7-to-step8").addEventListener("click", ()=> setActiveTab("step8"));

const S7_PROMPT = `
ä½ æ˜¯ä¸€åâ€œé¡¹ç›®è¯„ä¼°ä¸å¤ç›˜â€ä¸“å®¶ã€‚
ä½ ä¼šæ”¶åˆ°ï¼šå…³é”®é—®é¢˜ç›®æ ‡/å¯¹ç­–/ä»»åŠ¡æ¦‚è¦ï¼Œä»¥åŠ Step7 çš„è¯„ä¼°è¡¨å’Œè¿‡ç¨‹è®°å½•ã€‚
è¯·è¾“å‡ºï¼š
1) äº®ç‚¹ highlightsï¼ˆ2~4æ¡ï¼‰
2) ä¸è¶³ shortcomingsï¼ˆ2~4æ¡ï¼‰
3) å¯å¤åˆ¶è¦ç‚¹ replicable_pointsï¼ˆ3~6æ¡ï¼‰
4) æ¨èæ ‡å‡†åŒ–æ¡ç›® standardization_pointsï¼ˆ2~6æ¡ï¼Œé€‚åˆå†™å…¥Step8æ ‡å‡†åŒ–æ¸…å•ï¼‰

è¾“å‡ºä¸¥æ ¼JSONï¼š
{
  "coach_comment":"æ€»ä½“è¯„ä»·ï¼ˆä¸€å¥è¯ï¼‰",
  "highlights":["..."],
  "shortcomings":["..."],
  "replicable_points":["..."],
  "standardization_points":["..."]
}
`;

document.getElementById("btn-ai-s7").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s7-out");
  const statusEl = document.getElementById("ai-s7-status");
  const payload = {
    step1:{bigProblem: state.step1.bigProblem, scenario: state.step1.scenario},
    step3:{keyProblems: state.step3.keyProblems.map(k=>({text:k.text, goal:k.goal||k.aiGoal||""}))},
    step5:{countermeasures: state.step5.items.map(it=>({leafCause: it.leafText, countermeasure: it.countermeasure||it.aiCountermeasure||""}))},
    step6:{tasks: state.step6.tasks},
    step7:{rows: state.step7.rows, notes: state.step7.notes}
  };
  const res = await callAI({systemPrompt:S7_PROMPT, payload, outEl, statusEl});
  state.ai.s7 = res.json;
  saveState();
});

document.getElementById("btn-ai-s7-apply").addEventListener("click", ()=>{
  const j = state.ai.s7;
  if(!j || !Array.isArray(j.standardization_points)){
    alert("æ²¡æœ‰å¯ç”¨çš„AIç»“æœï¼Œè¯·å…ˆç‚¹å‡»â€œAIæ•™ç»ƒè¯„ä»·æœ¬æ­¥â€ã€‚");
    return;
  }
  state.step7.aiStdPoints = j.standardization_points;
  // push into step8 standards
  j.standardization_points.forEach(p=>{
    state.step8.standards.push({id:uuid(), title:p, owner:"", due:"", progress:""});
  });
  saveState();
  renderStep8();
  alert("å·²å°† AI æ¨èçš„æ ‡å‡†åŒ–æ¡ç›®å†™å…¥ Step8ã€‚");
});

/* ===========================
   Step8 æ¸²æŸ“/ç¼–è¾‘/AI
=========================== */
const elS8Tbody = document.getElementById("s8-tbody");
const elS8Retro = document.getElementById("s8-retro");

function renderStep8(){
  elS8Tbody.innerHTML = "";
  (state.step8.standards||[]).forEach((s, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td><textarea data-id="${s.id}" data-f="title" placeholder="æ ‡å‡†åŒ–å†…å®¹">${escapeHtml(s.title||"")}</textarea></td>
      <td><input data-id="${s.id}" data-f="owner" value="${escapeHtml(s.owner||"")}" /></td>
      <td><input data-id="${s.id}" data-f="due" type="date" value="${escapeHtml(s.due||"")}" /></td>
      <td><input data-id="${s.id}" data-f="progress" type="number" min="0" max="100" value="${escapeHtml(s.progress||"")}" /></td>
      <td class="center"><button class="btn2" data-del="${s.id}">âœ•</button></td>
    `;
    elS8Tbody.appendChild(tr);
  });
  elS8Retro.value = state.step8.retro || "";
}
renderStep8();

document.getElementById("btn-s8-add").addEventListener("click", ()=>{
  state.step8.standards.push({id:uuid(), title:"", owner:"", due:"", progress:""});
  saveState(); renderStep8();
});

elS8Tbody.addEventListener("input", (e)=>{
  const t=e.target;
  const id=t.dataset.id; const f=t.dataset.f;
  if(!id||!f) return;
  const row = state.step8.standards.find(x=>x.id===id);
  if(!row) return;
  row[f]=t.value;
  saveState();
});

elS8Tbody.addEventListener("click", (e)=>{
  const btn=e.target.closest("button[data-del]");
  if(!btn) return;
  const id=btn.dataset.del;
  state.step8.standards = state.step8.standards.filter(x=>x.id!==id);
  saveState(); renderStep8();
});

elS8Retro.addEventListener("input", ()=>{
  state.step8.retro = elS8Retro.value;
  saveState();
});

const S8_PROMPT = `
ä½ æ˜¯ä¸€åâ€œç»„ç»‡å­¦ä¹ ä¸ä¸ªäººæˆé•¿â€æ•™ç»ƒã€‚
ä½ ä¼šæ”¶åˆ°ï¼šä» Step1~Step7 çš„å…³é”®å†…å®¹æ‘˜è¦ã€æ ‡å‡†åŒ–æ¸…å•ã€ä¸ªäººå¤ç›˜æ–‡æœ¬ã€‚
è¾“å‡ºï¼š
1) ç»„ç»‡å±‚é¢å¯å¤åˆ¶åšæ³•ï¼ˆ3~6æ¡ï¼‰
2) ä¸ªäººèƒ½åŠ›æ´å¯Ÿï¼ˆ3~6æ¡ï¼‰
3) ä¸‹ä¸€è½®ä¼˜å…ˆæ”¹è¿›æ–¹å‘ï¼ˆ3~6æ¡ï¼‰
è¾“å‡ºä¸¥æ ¼JSONï¼š
{
  "coach_comment":"æ€»ä½“è¯„ä»·ï¼ˆä¸€å¥è¯ï¼‰",
  "org_reusable":["..."],
  "capability_insights":["..."],
  "next_cycle_focus":["..."]
}
`;

document.getElementById("btn-ai-s8").addEventListener("click", async ()=>{
  const outEl = document.getElementById("ai-s8-out");
  const statusEl = document.getElementById("ai-s8-status");
  const payload = {
    step1: state.step1,
    step3: state.step3,
    step4: {leafs: state.step4.nodes.filter(n=>n.id!=="root" && isLeaf(n.id)).map(n=>n.text)},
    step5: state.step5,
    step6: state.step6,
    step7: state.step7,
    step8: state.step8
  };
  const res = await callAI({systemPrompt:S8_PROMPT, payload, outEl, statusEl});
  state.ai.s8 = res.json;
  saveState();
});

/* ===========================
   Step4 -> Step5 / Step5 -> Step6 / Step6 -> Step7 triggers
=========================== */
document.getElementById("btn-s5-to-step6").addEventListener("click", ()=>{
  setActiveTab("step6");
});
document.getElementById("btn-s4-to-step5").addEventListener("click", ()=> setActiveTab("step5"));

/* ===========================
   Report
=========================== */
document.getElementById("btn-report-refresh").addEventListener("click", buildReport);

function buildReport(){
  const box = document.getElementById("report-content");
  const s1 = state.step1 || {};
  const hypos = (state.step2 && state.step2.hypotheses) ? state.step2.hypotheses : [];
  const keyProblems = (state.step3 && state.step3.keyProblems) ? state.step3.keyProblems : [];
  const nodes = (state.step4 && state.step4.nodes) ? state.step4.nodes : [];
  const cms = (state.step6 && state.step6.countermeasures) ? state.step6.countermeasures : [];
  const tasks = (state.step6 && state.step6.tasks) ? state.step6.tasks : [];
  const now = new Date();

  const kpMap = new Map(keyProblems.map(k=>[k.id,k]));
  const cmMap = new Map(cms.map(c=>[c.id,c]));

  function pathToRoot(id){
    const path = [];
    let cur = nodeById(id);
    while(cur){
      path.push(cur);
      if(!cur.parentId) break;
      cur = nodeById(cur.parentId);
    }
    return path.reverse();
  }

  const leafNodes = nodes.filter(n=>n.id!=="root" && isLeaf(n.id));
  const leafRows = leafNodes.map((n, i)=> {
    const path = pathToRoot(n.id);
    const kpId = n.keyProblemId || ((path.find(p=>p.type==="key")||{}).keyProblemId || "");
    const kpText = (kpMap.get(kpId)||{}).text || ((path.find(p=>p.type==="key")||{}).text || "");
    return {
      idx:i+1,
      kpId,
      kpText,
      leafId:n.id,
      leafText:n.text || "",
      evidence:n.evidence || "",
      depth: Math.max(0, path.length-1),
      pathText: path.map(x=>x.text || "").join(" â†’ ")
    };
  });

  const s2Rows = hypos.map((h,i)=> {
    const p = computePriority(h);
    const hasEvi = !!(h.evidence||"").trim();
    return {
      i:i+1,
      text:h.text || "",
      dimension:h.dimension || "",
      evidence:h.evidence || "",
      importance:h.importance || "",
      urgency:h.urgency || "",
      priority:p,
      hasEvi
    };
  });

  const s3Rows = keyProblems.map((k,i)=>({i:i+1,text:k.text||"",goal:k.goal||"",aiGoal:k.aiGoal||""}));

  const s5Rows = ((state.step5 && state.step5.items) ? state.step5.items : []).map((it,i)=> {
    const kpText = (kpMap.get(it.keyProblemId)||{}).text || "";
    const leafText = it.leafText || (leafRows.find(r=>r.leafId===it.leafNodeId)||{}).leafText || "";
    const finalCm = (it.aiCountermeasure && it.aiCountermeasure.trim()) ? it.aiCountermeasure : (it.countermeasure||"");
    return {i:i+1,kpText,leafText,countermeasure:finalCm,note:it.note||""};
  });

  const s6Rows = tasks.map((t,i)=>{
    const cmText = (cmMap.get(t.countermeasureId)||{}).text || "";
    return {i:i+1, cmText, task:t.task||"", owner:t.owner||"", start:t.start||"", end:t.end||"", status:t.status||"", milestone:t.milestone||""};
  });

  const s7Rows = ((state.step7 && state.step7.rows) ? state.step7.rows : []).map((r,i)=>({i:i+1,label:r.label||"",before:r.before||"",target:r.target||"",after:r.after||"",improve:r.improve||""}));

  const s8Rows = ((state.step8 && state.step8.standards) ? state.step8.standards : []).map((r,i)=>({i:i+1,title:r.title||"",owner:r.owner||"",due:r.due||"",progress:r.progress||""}));

  const html = `
    <div class="report">
      <div class="report-head">
        <div>
          <h2 style="margin:0">é—®é¢˜åˆ†æä¸è§£å†³æŠ¥å‘Š</h2>
          <div class="small">ç”Ÿæˆæ—¶é—´ï¼š${escapeHtml(now.toLocaleString())}</div>
        </div>
      </div>

      <div class="report-card">
        <h3>1ï¼‰å¤§é—®é¢˜ä¸åœºæ™¯</h3>
        <table class="rpt-table">
          <tbody>
            <tr><th style="width:200px">å¤§è€Œæ¨¡ç³Šçš„é—®é¢˜</th><td>${escapeHtml(s1.bigProblem||"")}</td></tr>
            <tr><th>é—®é¢˜åœºæ™¯æè¿°</th><td>${escapeHtml(s1.context||"")}</td></tr>
          </tbody>
        </table>
      </div>

      <div class="report-card">
        <h3>2ï¼‰å‡è®¾é—®é¢˜ã€è¯æ®ä¸ä¼˜å…ˆçº§</h3>
        ${s2Rows.length ? `
        <table class="rpt-table">
          <thead>
            <tr>
              <th style="width:48px">#</th>
              <th>å‡è®¾é—®é¢˜</th>
              <th style="width:110px">ç»´åº¦</th>
              <th>ä¾æ®/è¯æ®</th>
              <th style="width:80px">é‡è¦åº¦</th>
              <th style="width:80px">ç´§æ€¥åº¦</th>
              <th style="width:90px">ä¼˜å…ˆçº§</th>
              <th style="width:90px">è¯æ®çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody>
            ${s2Rows.map(r=>`
              <tr>
                <td class="center">${r.i}</td>
                <td>${escapeHtml(r.text)}</td>
                <td>${escapeHtml(r.dimension)}</td>
                <td>${escapeHtml(r.evidence)}</td>
                <td class="center">${escapeHtml(String(r.importance))}</td>
                <td class="center">${escapeHtml(String(r.urgency))}</td>
                <td class="center"><span class="${prioClass(r.priority)}">${r.priority}</span></td>
                <td class="center"><span class="pill ${r.hasEvi?"evi-ok":"evi-miss"}">${r.hasEvi?"å·²æä¾›":"ç¼ºè¯æ®"}</span></td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— ï¼‰</div>`}
        <div class="small mt8">è¯´æ˜ï¼šå…³é”®é—®é¢˜ä»¥â€œå·²æä¾›è¯æ® + ä¼˜å…ˆçº§æœ€é«˜â€æ’åºæ¨é€è‡³Step3ã€‚</div>
      </div>

      <div class="report-card">
        <h3>3ï¼‰å…³é”®é—®é¢˜ç›®æ ‡</h3>
        ${s3Rows.length ? `
        <table class="rpt-table">
          <thead><tr><th style="width:48px">#</th><th>å…³é”®é—®é¢˜</th><th>ç›®æ ‡æè¿°</th></tr></thead>
          <tbody>
            ${s3Rows.map(r=>`
              <tr>
                <td class="center">${r.i}</td>
                <td>${escapeHtml(r.text)}</td>
                <td>
                  ${escapeHtml(r.goal)}
                  ${r.aiGoal ? `<div class="small mt6"><b>AIå»ºè®®ï¼š</b>${escapeHtml(r.aiGoal)}</div>`:""}
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— å…³é”®é—®é¢˜ç›®æ ‡ï¼‰</div>`}
      </div>

      <div class="report-card">
        <h3>4ï¼‰åŸå› é€»è¾‘æ ‘</h3>
        <div class="tree-wrap">
          ${buildTreeHtml("root")}
        </div>
        <h4 class="mt12" style="margin-bottom:8px">æœ«ç«¯åŸå› ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰æ±‡æ€»</h4>
        ${leafRows.length ? `
        <table class="rpt-table">
          <thead><tr><th style="width:48px">#</th><th>å…³é”®é—®é¢˜</th><th>æœ«ç«¯åŸå› </th><th style="width:80px">æ·±åº¦</th><th>è·¯å¾„</th></tr></thead>
          <tbody>
            ${leafRows.map(r=>`
              <tr>
                <td class="center">${r.idx}</td>
                <td>${escapeHtml(r.kpText||"")}</td>
                <td>${escapeHtml(r.leafText||"")}</td>
                <td class="center">${r.depth}</td>
                <td class="small">${escapeHtml(r.pathText)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— æœ«ç«¯åŸå› ï¼‰</div>`}
      </div>

      <div class="report-card">
        <h3>5ï¼‰æœ«ç«¯åŸå›  â†’ å¯¹ç­–</h3>
        ${s5Rows.length ? `
        <table class="rpt-table">
          <thead>
            <tr><th style="width:48px">#</th><th>å…³é”®é—®é¢˜</th><th>æœ«ç«¯åŸå› </th><th>å¯¹ç­–ï¼ˆæœ€ç»ˆï¼‰</th><th style="width:160px">å¤‡æ³¨</th></tr>
          </thead>
          <tbody>
            ${s5Rows.map(r=>`
              <tr>
                <td class="center">${r.i}</td>
                <td>${escapeHtml(r.kpText)}</td>
                <td>${escapeHtml(r.leafText)}</td>
                <td>${escapeHtml(r.countermeasure||"")}</td>
                <td>${escapeHtml(r.note||"")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— å¯¹ç­–ï¼‰</div>`}
      </div>

      <div class="report-card">
        <h3>6ï¼‰è¡ŒåŠ¨è®¡åˆ’çœ‹æ¿</h3>
        ${s6Rows.length ? `
        <table class="rpt-table">
          <thead>
            <tr>
              <th style="width:48px">#</th>
              <th>å¯¹ç­–</th>
              <th>ä»»åŠ¡</th>
              <th style="width:110px">è´£ä»»äºº</th>
              <th style="width:110px">å¼€å§‹</th>
              <th style="width:110px">æˆªæ­¢</th>
              <th style="width:90px">çŠ¶æ€</th>
              <th style="width:160px">é‡Œç¨‹ç¢‘/éªŒæ”¶</th>
            </tr>
          </thead>
          <tbody>
            ${s6Rows.map(r=>`
              <tr>
                <td class="center">${r.i}</td>
                <td>${escapeHtml(r.cmText)}</td>
                <td>${escapeHtml(r.task)}</td>
                <td>${escapeHtml(r.owner)}</td>
                <td>${escapeHtml(r.start)}</td>
                <td>${escapeHtml(r.end)}</td>
                <td>${escapeHtml(r.status)}</td>
                <td>${escapeHtml(r.milestone)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— è¡ŒåŠ¨è®¡åˆ’ï¼‰</div>`}
      </div>

      <div class="report-card">
        <h3>7ï¼‰è¿‡ç¨‹ä¸ç»“æœè¯„ä¼°</h3>
        ${s7Rows.length ? `
        <table class="rpt-table">
          <thead><tr><th style="width:48px">#</th><th>æŒ‡æ ‡</th><th style="width:120px">æ”¹å–„å‰</th><th style="width:120px">ç›®æ ‡</th><th style="width:120px">æ”¹å–„å</th><th style="width:120px">æ”¹å–„%</th></tr></thead>
          <tbody>
            ${s7Rows.map(r=>`
              <tr>
                <td class="center">${r.i}</td>
                <td>${escapeHtml(r.label)}</td>
                <td class="center">${escapeHtml(r.before)}</td>
                <td class="center">${escapeHtml(r.target)}</td>
                <td class="center">${escapeHtml(r.after)}</td>
                <td class="center">${escapeHtml(r.improve)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— è¯„ä¼°æŒ‡æ ‡ï¼‰</div>`}
        ${state.step7 && state.step7.notes ? `<div class="mt8"><b>è¯´æ˜ï¼š</b>${escapeHtml(state.step7.notes)}</div>`:""}
      </div>

      <div class="report-card">
        <h3>8ï¼‰æ ‡å‡†åŒ–ä¸å¤ç›˜</h3>
        ${s8Rows.length ? `
        <table class="rpt-table">
          <thead><tr><th style="width:48px">#</th><th>æ ‡å‡†åŒ–å†…å®¹</th><th style="width:120px">è´Ÿè´£äºº</th><th style="width:120px">å®Œæˆæ—¶é—´</th><th style="width:120px">è¿›åº¦</th></tr></thead>
          <tbody>
            ${s8Rows.map(r=>`
              <tr>
                <td class="center">${r.i}</td>
                <td>${escapeHtml(r.title)}</td>
                <td>${escapeHtml(r.owner)}</td>
                <td>${escapeHtml(r.due)}</td>
                <td>${escapeHtml(r.progress)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>` : `<div class="small">ï¼ˆæš‚æ— æ ‡å‡†åŒ–è®¡åˆ’ï¼‰</div>`}
        ${state.step8 && state.step8.retro ? `<div class="mt8"><b>å¤ç›˜åæ€ï¼š</b>${escapeHtml(state.step8.retro)}</div>`:""}
      </div>
    </div>
  `;
  box.innerHTML = html;
}

/* ===========================
   é¡¶éƒ¨æŒ‰é’®ï¼šæŠ¥å‘Š/å¯¼å‡º/æ¸…ç©º
=========================== */
document.getElementById("btn-report").addEventListener("click", ()=>{
  setActiveTab("report");
  buildReport();
});

document.getElementById("btn-download-report").addEventListener("click", ()=>{
  setActiveTab("report");
  buildReport();
  const content = document.getElementById("report-content").innerHTML;
  const style = document.querySelector("style") ? document.querySelector("style").innerHTML : "";
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>é—®é¢˜åˆ†æä¸è§£å†³æŠ¥å‘Š</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
  ${style}

  /* ===== Export Tweaks ===== */
  body{background:#ffffff !important; margin:16px;}
  .wrap{max-width:1100px;margin:0 auto;}
  .actions,.tabs,.tab-btns,.toast{display:none !important;}
  .tree-wrap{overflow:visible;}
  .report-card{break-inside:avoid;}
  @media print{
    body{margin:0;}
    .wrap{max-width:none;}
    .report-card{page-break-inside:avoid;}
  }
  </style></head><body><div class="wrap">${content}</div></body></html>`;
  const blob = new Blob([html], {type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "é—®é¢˜åˆ†æä¸è§£å†³æŠ¥å‘Š.html";
  a.click();
  URL.revokeObjectURL(a.href);
});


document.getElementById("btn-export-json").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "PAS8_é¡¹ç›®æ•°æ®.json";
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("btn-clear").addEventListener("click", ()=>{
  if(!confirm("ç¡®å®šæ¸…ç©ºå…¨éƒ¨æ•°æ®å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = structuredClone(defaultState);
  saveState();
  location.reload();
});

/* ===========================
   Step6/Step5/Step4 quick navigation
=========================== */
document.getElementById("btn-s5-to-step6").addEventListener("click", ()=> setActiveTab("step6"));
document.getElementById("btn-s6-to-step7").addEventListener("click", ()=> setActiveTab("step7"));
document.getElementById("btn-s7-to-step8").addEventListener("click", ()=> setActiveTab("step8"));

/* ===========================
   åˆå§‹åŒ–ï¼šå½“Step3å·²æœ‰æ•°æ®æ—¶ï¼ŒåŒæ­¥Step4å¹¶æ¸²æŸ“
=========================== */
(function bootstrap(){
  // Step2 big problem
  elS2Big.value = state.step1.bigProblem || "";
  // if step6 countermeasures empty but step5 has items, allow user to push manually.
  // ensure report exists
  buildReport();
})();
</script>

</body>
</html>
