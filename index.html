<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é—®é¢˜åˆ†æä¸è§£å†³ Â· 8æ­¥æ³•ï¼ˆAIæ•™ç»ƒç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue-dark: #1e3a8a;
      --blue: #2563eb;
      --blue-soft: #eff6ff;
      --blue-border: #bfdbfe;
      --gray-bg: #f9fafb;
      --gray-border: #d1d5db;
      --danger: #b91c1c;
      --success: #15803d;
      --text-main: #111827;
      --text-sub: #4b5563;
      --radius-lg: 12px;
      --radius-md: 8px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC",
        "Microsoft YaHei", sans-serif;
      background: #f3f4f6;
      color: var(--text-main);
    }

    header {
      background: linear-gradient(90deg, #0f172a, var(--blue-dark));
      color: white;
      padding: 16px 24px;
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(191, 219, 254, 0.8);
    }

    header .sub {
      margin-top: 6px;
      font-size: 13px;
      opacity: 0.9;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    header .sub-left {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
      background: rgba(15, 23, 42, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .pill-dot.warn {
      background: #f97316;
    }

    .pill-dot.danger {
      background: #ef4444;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button,
    .btn {
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: white;
      color: var(--blue-dark);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }

    button.primary,
    .btn.primary {
      background: var(--blue);
      color: white;
      border-color: #1d4ed8;
    }

    button.primary:hover,
    .btn.primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    button.outline,
    .btn.outline {
      background: transparent;
      color: white;
      border-color: rgba(191, 219, 254, 0.8);
    }

    button.outline:hover,
    .btn.outline:hover {
      background: rgba(15, 23, 42, 0.4);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .container {
      max-width: 1200px;
      margin: 16px auto 32px;
      padding: 0 16px;
    }

    .tab-container {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    .tab-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0;
      background: var(--blue-soft);
      border-bottom: 1px solid var(--blue-border);
    }

    .tab-header button {
      flex: 1 0 120px;
      border-radius: 0;
      border: none;
      border-right: 1px solid var(--blue-border);
      background: transparent;
      color: var(--blue-dark);
      padding: 10px 8px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tab-header button:last-child {
      border-right: none;
    }

    .tab-header button.active {
      background: white;
      color: var(--blue-dark);
      border-bottom: 2px solid var(--blue);
      box-shadow: 0 -2px 0 white inset;
    }

    .tab-content {
      padding: 18px 20px 20px;
      background: white;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    h2.step-title {
      margin: 0 0 12px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--blue-dark);
    }

    h2.step-title span.step-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--blue-border);
      background: var(--blue-soft);
      color: var(--blue-dark);
    }

    p.step-desc {
      margin: 0 0 16px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 960px) {
      .grid-2 {
        grid-template-columns: 3fr 2fr;
      }

      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .card {
      background: var(--gray-bg);
      border-radius: var(--radius-md);
      padding: 12px 12px 10px;
      border: 1px solid #e5e7eb;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 4px;
      display: block;
    }

    textarea,
    input,
    select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--gray-border);
      padding: 6px 8px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
      background: white;
    }

    input,
    select {
      min-height: auto;
      height: 32px;
    }

    textarea:focus,
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
    }

    .hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      vertical-align: top;
      text-align: left;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      white-space: nowrap;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .badge {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #cbd5f5;
      background: #e0ecff;
      color: #1e3a8a;
    }

    .badge.red {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .badge.green {
      background: #dcfce7;
      border-color: #bbf7d0;
      color: #166534;
    }

    .ai-panel {
      border-radius: var(--radius-md);
      border: 1px dashed var(--blue-border);
      padding: 10px 10px 8px;
      background: #eff6ff;
      margin-top: 8px;
      font-size: 12px;
    }

    .ai-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .ai-title {
      font-weight: 600;
      color: var(--blue-dark);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-title span {
      font-size: 14px;
    }

    .ai-output {
      background: white;
      border-radius: 6px;
      border: 1px solid var(--blue-border);
      padding: 6px 8px;
      max-height: 180px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .ai-status {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .flex {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .mt-8 {
      margin-top: 8px;
    }

    .mt-12 {
      margin-top: 12px;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .mb-4 {
      margin-bottom: 4px;
    }

    .tag-list {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: white;
      font-size: 11px;
      color: #6b7280;
      cursor: default;
    }

    .priority-high {
      color: #b91c1c;
      font-weight: 600;
    }

    .priority-medium {
      color: #d97706;
      font-weight: 500;
    }

    .priority-low {
      color: #15803d;
      font-weight: 500;
    }

    .kpi-gap {
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 999px;
      background: #fef3c7;
      border: 1px solid #facc15;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
    }

    .report-block {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 12px 12px 10px;
      margin-bottom: 10px;
      background: #f9fafb;
    }

    .report-block h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--blue-dark);
    }

    .report-block p {
      margin: 2px 0;
      font-size: 13px;
    }

    .small {
      font-size: 11px;
      color: var(--text-sub);
    }

    .text-right {
      text-align: right;
    }

    .danger-text {
      color: var(--danger);
    }

    .success-text {
      color: var(--success);
    }

    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 12px 0;
    }
  </style>
</head>

<body>
<header>
  <h1>
    é—®é¢˜åˆ†æä¸è§£å†³ Â· 8æ­¥æ³•
    <span class="badge">AI æ•™ç»ƒç‰ˆ Â· å•†åŠ¡è“</span>
  </h1>
  <div class="sub">
    <div class="sub-left">
      <span class="pill">
        <span class="pill-dot"></span> çŠ¶æ€ï¼šè¿›è¡Œä¸­
      </span>
      <span class="pill">
        <span class="pill-dot warn"></span> å»ºè®®ï¼šæ¯ä¸€æ­¥å®Œæˆåå†ç‚¹å‡» AI æ•™ç»ƒ
      </span>
      <span class="pill">
        <span class="pill-dot danger"></span> æé†’ï¼šé¡¹ç›®æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰
      </span>
    </div>
    <div class="header-actions">
      <button class="outline" id="btn-clear-all">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
      <button class="outline" id="btn-generate-report">ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š</button>
      <button class="primary" id="btn-download-report">å¯¼å‡ºæŠ¥å‘Š HTML</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="tab-container">
    <div class="tab-header">
      <button class="active" data-tab="step1">Step1 æ˜ç¡®é—®é¢˜ä¸ç›®æ ‡</button>
      <button data-tab="step2">Step2 åˆ†è§£é—®é¢˜ï¼ˆå‡è®¾ & è¯æ®ï¼‰</button>
      <button data-tab="step3">Step3 å…³é”®é—®é¢˜ç›®æ ‡è®¾å®š</button>
      <button data-tab="step4">Step4 åŸå› åˆ†æï¼ˆé€»è¾‘æ ‘ï¼‰</button>
      <button data-tab="step5">Step5 å¯¹ç­–é€‰æ‹©ä¸è¯„ä¼°</button>
      <button data-tab="step6">Step6 è¡ŒåŠ¨è®¡åˆ’ & çœ‹æ¿</button>
      <button data-tab="step7">Step7 è¿‡ç¨‹ & ç»“æœè¯„ä¼°</button>
      <button data-tab="step8">Step8 æ ‡å‡†åŒ– & å¤ç›˜</button>
      <button data-tab="report">æœ€ç»ˆæŠ¥å‘Šé¢„è§ˆ</button>
    </div>

    <div class="tab-content">

      <!-- Step1 -->
      <section id="step1" class="tab-panel active">
        <h2 class="step-title">
          <span class="step-badge">Step1</span> æ˜ç¡®é—®é¢˜ä¸ç›®æ ‡ï¼ˆå« 5W2Hï¼‰
        </h2>
        <p class="step-desc">
          å…ˆä»ã€Œç†æƒ³çŠ¶æ€ â†’ ç°çŠ¶ â†’ KPI å·®è· â†’ å¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ã€æŠŠé—®é¢˜æ¡†ä½ï¼Œå†ç”¨ 5W2H å¯¹ç°çŠ¶åšç»“æ„åŒ–æè¿°ï¼Œä¸ºåç»­åˆ†è§£é—®é¢˜æä¾›ä¾æ®ã€‚
        </p>

        <div class="grid grid-2">
          <!-- left: ideal & current -->
          <div class="grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">æ›´é«˜çš„ç†æƒ³çŠ¶æ€ï¼ˆé•¿æœŸç›®æ ‡ï¼‰</div>
                  <div class="card-sub">ç«™åœ¨ 1~3 å¹´åçš„è§†è§’ï¼Œç”¨ä¸šåŠ¡è¯­è¨€æè¿°å¸Œæœ›è¾¾åˆ°çš„çŠ¶æ€</div>
                </div>
              </div>
              <textarea id="s1-ideal"></textarea>
              <div class="hint">ä¾‹å¦‚ï¼šé—¨åº—äººå‡é”€å”®é¢ â‰¥ XX ä¸‡ï¼æœˆï¼ŒæŠ•è¯‰ç‡ &lt; 0.3% ç­‰ã€‚</div>
            </div>

            <div class="grid grid-2">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">ç†æƒ³çŠ¶æ€ Â· å…³é”® KPIs</div>
                </div>
                <textarea id="s1-ideal-kpi" placeholder="åˆ—å‡ºä¸æœ¬é¡¹ç›®ç›¸å…³çš„ 2~4 ä¸ªé‡åŒ–æŒ‡æ ‡åŠç›®æ ‡å€¼"></textarea>
              </div>
              <div class="card">
                <div class="card-header">
                  <div class="card-title">ç°çŠ¶ Â· å…³é”® KPIs</div>
                </div>
                <textarea id="s1-current-kpi" placeholder="å¯¹åº”ä¸Šæ–¹æŒ‡æ ‡çš„å½“å‰æ•°å€¼ï¼ˆå«æ—¶é—´ã€èŒƒå›´è¯´æ˜ï¼‰"></textarea>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">KPI å·®è· & å¤§è€Œæ¨¡ç³Šçš„é—®é¢˜</div>
              </div>
              <textarea id="s1-gap" placeholder="ç”¨ä¸€ä¸¤å¥è¯æè¿° KPI å·®è·ï¼Œä¾‹å¦‚ï¼šäººå‡é”€å”®é¢æ¯”ç›®æ ‡ä½ 15%ï¼Œé€€è´§ç‡æ¯”ç›®æ ‡é«˜ 2.3 ä¸ªç™¾åˆ†ç‚¹ã€‚"></textarea>
              <div class="kpi-gap" id="s1-gap-pill">
                <span>å½“å‰å·®è·ï¼š</span>
                <strong id="s1-gap-short">å¾… AI å¸®ä½ æç‚¼</strong>
              </div>
              <label class="mt-8">æˆ‘ä»¬è¦è§£å†³çš„é‚£ä¸ªâ€œå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜â€ï¼ˆä¸€å¥è¯ï¼‰</label>
              <textarea id="s1-big-problem" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨ä¸å¢åŠ äººæ‰‹çš„æƒ…å†µä¸‹ï¼ŒæŠŠé—¨åº—äººå‡é”€å”®é¢æå‡åˆ° XX ä¸‡ï¼æœˆï¼Ÿ"></textarea>
            </div>
          </div>

          <!-- right: 5W2H -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">ç°çŠ¶ 5W2H æè¿°</div>
                <div class="card-sub">æ£€æŸ¥è‡ªå·±æ˜¯å¦çœŸæ­£çœ‹æ¸…äº†â€œé—®é¢˜é•¿ä»€ä¹ˆæ ·â€</div>
              </div>
            </div>
            <table>
              <tbody>
                <tr>
                  <th>What - ä»€ä¹ˆé—®é¢˜ï¼Ÿ</th>
                  <td><textarea id="s1-5w-what" placeholder="æ ¸å¿ƒç°è±¡æ˜¯ä»€ä¹ˆï¼Ÿç”¨ 1~2 å¥å¯é‡åŒ–çš„æè¿°ã€‚"></textarea></td>
                </tr>
                <tr>
                  <th>Where - åœ¨å“ªé‡Œå‘ç”Ÿï¼Ÿ</th>
                  <td><textarea id="s1-5w-where" placeholder="å‘ç”Ÿçš„åœ°ç‚¹ã€åŒºåŸŸã€é—¨åº—ã€ä¸šåŠ¡å•å…ƒç­‰ã€‚"></textarea></td>
                </tr>
                <tr>
                  <th>When - ä½•æ—¶å‘ç”Ÿ/å‘ç°ï¼Ÿ</th>
                  <td><textarea id="s1-5w-when" placeholder="æ—¶é—´æ®µã€ç­æ¬¡ã€å­£èŠ‚ç­‰ã€‚"></textarea></td>
                </tr>
                <tr>
                  <th>Who - ç”±è°å‘ç°/æ¶‰åŠè°ï¼Ÿ</th>
                  <td><textarea id="s1-5w-who" placeholder="æ¶‰åŠçš„è§’è‰²ã€å²—ä½ã€å®¢æˆ·ç¾¤ä½“ç­‰ã€‚"></textarea></td>
                </tr>
                <tr>
                  <th>Why - ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜ï¼Ÿ</th>
                  <td><textarea id="s1-5w-why" placeholder="å¦‚æœä¸è§£å†³ï¼Œä¼šå¯¼è‡´ä»€ä¹ˆå½±å“ï¼ˆæˆæœ¬ã€å®¢æˆ·ã€æ•ˆç‡ã€é£é™©ç­‰ï¼‰ã€‚"></textarea></td>
                </tr>
                <tr>
                  <th>How - å¦‚ä½•å‘ç°ï¼Ÿ</th>
                  <td><textarea id="s1-5w-how" placeholder="é€šè¿‡ä»€ä¹ˆæ¸ é“ã€æŠ¥è¡¨ã€å®¢æˆ·åé¦ˆã€ç°åœºè§‚å¯Ÿå‘ç°çš„ï¼Ÿ"></textarea></td>
                </tr>
                <tr>
                  <th>How much - æœ‰å¤šä¸¥é‡ï¼Ÿ</th>
                  <td><textarea id="s1-5w-howmuch" placeholder="å‘ç”Ÿé¢‘æ¬¡ã€é‡‘é¢ã€æ¯”ç‡ã€è¶‹åŠ¿ç­‰ã€‚"></textarea></td>
                </tr>
              </tbody>
            </table>
            <div class="hint mt-8">5W2H å†™å¾—è¶Šå…·ä½“ï¼Œåé¢åˆ†è§£é—®é¢˜æ—¶è¶Šå®¹æ˜“æ‰¾åˆ°åˆ‡å…¥ç‚¹ã€‚</div>

            <div class="ai-panel mt-12">
              <div class="ai-panel-header">
                <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step1 è¯Šæ–­</div>
                <div class="flex">
                  <button class="btn primary" id="btn-ai-step1">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                  <button class="btn" id="btn-ai-step1-apply">å°† AI å»ºè®®æ¨é€åˆ° Step2</button>
                </div>
              </div>
              <div class="ai-output" id="ai-step1-output">å®Œæˆ Step1 å¡«å†™åç‚¹å‡»â€œAI æ•™ç»ƒè¯„ä»·æœ¬æ­¥â€ï¼Œæˆ‘ä¼šå¸®ä½ æ£€æŸ¥ 5W2H çš„å®Œæ•´æ€§ã€é—®é¢˜æè¿°æ˜¯å¦èšç„¦ï¼Œå¹¶æç‚¼å‡ºä¸€æ¡é€‚åˆåœ¨ Step2 ä½¿ç”¨çš„æ€»é—®é¢˜å¥ã€‚</div>
              <div class="ai-status" id="ai-step1-status"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Step2 -->
      <section id="step2" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step2</span> åˆ†è§£é—®é¢˜ï¼ˆå‡è®¾é—®é¢˜ Â· é€»è¾‘æ ‘ Â· è¯æ®éªŒè¯ï¼‰
        </h2>
        <p class="step-desc">
          å›´ç»• Step1 çš„â€œå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜â€ï¼Œä»¥â€œæ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜â€çš„æ ¼å¼æå‡ºå¤šä¸ªå‡è®¾é—®é¢˜ï¼Œç”¨ç»“æ„/æµç¨‹/æ—¶é—´ç­‰ç»´åº¦åšé€»è¾‘åˆ†è§£ï¼Œå¹¶ä¸ºæ¯ä¸ªå‡è®¾å‡†å¤‡è¯æ®ä¸éªŒè¯æ•°æ®ï¼ŒåŒæ—¶ç»™å‡ºé‡è¦åº¦ä¸ç´§æ€¥åº¦ï¼Œç”¨æ¥ç­›é€‰å…³é”®æ€§é—®é¢˜ã€‚
        </p>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Step1 ä¼ å…¥çš„å¤§é—®é¢˜</div>
              <div class="card-sub">å¦‚æœä¸ºç©ºï¼Œå¯å›åˆ° Step1 å®Œå–„åå†åŒæ­¥</div>
            </div>
            <button class="btn" id="btn-s2-sync-from-step1">ä» Step1 åŒæ­¥</button>
          </div>
          <textarea id="s2-root-problem" readonly style="min-height:60px;background:#f3f4f6;"></textarea>
        </div>

        <div class="grid grid-2 mt-12">
          <!-- å·¦ä¾§ï¼šæ–°å¢å‡è®¾é—®é¢˜ -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">æ–°å¢å‡è®¾é—®é¢˜</div>
                <div class="card-sub">å»ºè®®æ¯ä¸€æ¡éƒ½ç”¨â€œæ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜â€æ¥è¡¨è¿°</div>
              </div>
            </div>

            <label>å‡è®¾é—®é¢˜æè¿°</label>
            <textarea id="s2-new-text" placeholder="ä¾‹å¦‚ï¼šæ˜¯å¦å­˜åœ¨æ–°å“ä¸Šæ¶ä¿¡æ¯æœªåŠæ—¶åŒæ­¥åˆ°é—¨åº—ä¸€çº¿çš„é—®é¢˜ï¼Ÿ"></textarea>

            <label class="mt-8">é€»è¾‘åˆ†è§£ç»´åº¦</label>
            <select id="s2-new-dimension">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="ç»“æ„/ç»„æˆ">æŒ‰ç»“æ„/ç»„æˆè¦ç´ åˆ†è§£ï¼ˆäºº/æœº/æ–™/æ³•/ç¯/æµ‹ï¼‰</option>
              <option value="æµç¨‹/æ—¶é—´">æŒ‰æµç¨‹é˜¶æ®µæˆ–æ—¶é—´é¡ºåºåˆ†è§£</option>
              <option value="ç©ºé—´/åŒºåŸŸ">æŒ‰åŒºåŸŸ/æ¸ é“/é—¨åº—ç±»å‹åˆ†è§£</option>
              <option value="å®¢æˆ·/å¯¹è±¡">æŒ‰å®¢æˆ·ç±»å‹/å¯¹è±¡åˆ†è§£</option>
              <option value="å…¶å®ƒ">å…¶å®ƒåˆé€‚çš„é€»è¾‘ç»´åº¦</option>
            </select>

            <label class="mt-8">ä¸Šçº§é—®é¢˜ï¼ˆå¯é€‰ï¼Œç”¨äºå½¢æˆé—®é¢˜é€»è¾‘æ ‘ï¼‰</label>
            <select id="s2-new-parent">
              <option value="">æ— ï¼ˆä½œä¸ºä¸€çº§å‡è®¾ï¼‰</option>
            </select>

            <label class="mt-8">ä¾æ®/è¯æ®è¯´æ˜</label>
            <textarea id="s2-new-evidence" placeholder="åˆ—å‡ºæ”¯æŒè¯¥å‡è®¾çš„ç°è±¡ã€æ•°æ®ã€æŠ¥è¡¨æˆ–é™„ä»¶è¯´æ˜ã€‚"></textarea>

            <div class="grid grid-3 mt-8">
              <div>
                <label>é‡è¦åº¦ï¼ˆ1~5ï¼‰</label>
                <input id="s2-new-importance" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <label>ç´§æ€¥åº¦ï¼ˆ1~5ï¼‰</label>
                <input id="s2-new-urgency" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <label>æ½œåœ¨å…³é”®é—®é¢˜ï¼Ÿ</label>
                <select id="s2-new-key">
                  <option value="no">å¦</option>
                  <option value="yes">æ˜¯</option>
                </select>
              </div>
            </div>

            <button class="btn primary mt-8" id="btn-s2-add-hypo">æ·»åŠ å‡è®¾é—®é¢˜</button>
            <div class="hint mt-4">å»ºè®®ä» 3~7 ä¸ªå‡è®¾å¼€å§‹ï¼Œåç»­å¯åœ¨ AI æ•™ç»ƒçš„å»ºè®®ä¸‹ç»§ç»­è¡¥å……ã€‚</div>
          </div>

          <!-- å³ä¾§ï¼šå‡è®¾é—®é¢˜åˆ—è¡¨ -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">å‡è®¾é—®é¢˜åˆ—è¡¨ï¼ˆå«ä¼˜å…ˆçº§å’Œå…³é”®æ€§æ ‡è®°ï¼‰</div>
              <div class="flex">
                <span class="small">ä¼˜å…ˆçº§ = é‡è¦åº¦ Ã— ç´§æ€¥åº¦</span>
                <button class="btn" id="btn-s2-sort">æŒ‰ä¼˜å…ˆçº§æ’åº</button>
              </div>
            </div>

            <div style="max-height:320px;overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>å‡è®¾é—®é¢˜</th>
                    <th>ç»´åº¦</th>
                    <th>ä¸Šçº§</th>
                    <th>ä¾æ®/è¯æ®</th>
                    <th>é‡</th>
                    <th>æ€¥</th>
                    <th>å…³é”®?</th>
                    <th>åˆ </th>
                  </tr>
                </thead>
                <tbody id="s2-hypo-tbody"></tbody>
              </table>
            </div>

            <div class="tag-list mt-8" id="s2-key-tags"></div>

            <div class="ai-panel mt-12">
              <div class="ai-panel-header">
                <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step2 è¯Šæ–­</div>
                <div class="flex">
                  <button class="btn primary" id="btn-ai-step2">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                  <button class="btn" id="btn-ai-step2-apply">å°† AI å»ºè®®æ¨é€åˆ° Step3</button>
                </div>
              </div>
              <div class="ai-output" id="ai-step2-output">
                æˆ‘ä¼šå¸®ä½ æ£€æŸ¥ï¼šâ‘  å‡è®¾é—®é¢˜æ˜¯å¦çœŸçš„æ˜¯â€œé—®é¢˜â€è€Œä¸æ˜¯è§£å†³æ–¹æ¡ˆï¼›â‘¡ åˆ†è§£ç»´åº¦æ˜¯å¦å…·æœ‰é€»è¾‘æ€§ï¼ˆç»“æ„/æµç¨‹/æ—¶é—´ç­‰ï¼‰ï¼›â‘¢ æ˜¯å¦æœ‰æ˜æ˜¾ç¼ºå¤±çš„å‡è®¾ï¼›â‘£ æ ¹æ®é‡è¦åº¦&ç´§æ€¥åº¦ï¼Œå“ªäº›æ›´å¯èƒ½æ˜¯å…³é”®é—®é¢˜ï¼›â‘¤ å»ºè®®éªŒè¯æ¯ä¸ªå‡è®¾éœ€è¦æ”¶é›†å“ªäº›æ•°æ®ã€‚
              </div>
              <div class="ai-status" id="ai-step2-status"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Step3 -->
      <section id="step3" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step3</span> å…³é”®æ€§é—®é¢˜çš„ç›®æ ‡è®¾å®š
        </h2>
        <p class="step-desc">
          ä» Step2 ä¸­ç­›å‡ºçš„å…³é”®æ€§é—®é¢˜å‡ºå‘ï¼Œä¸ºæ¯ä¸ªå…³é”®é—®é¢˜è®¾å®šæ¸…æ™°ã€å¯é‡åŒ–ã€å¯åœ¨é¡¹ç›®å‘¨æœŸå†…å®ç°çš„ç›®æ ‡ï¼Œå¹¶å¯¹åº” KPI æŒ‡æ ‡ï¼Œä¸ºåé¢çš„åŸå› åˆ†æå’Œå¯¹ç­–åˆ¶å®šæŒ‡æ˜æ–¹å‘ã€‚
        </p>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ä» Step2 å¯¼å…¥å…³é”®æ€§é—®é¢˜</div>
            <button class="btn" id="btn-s3-import">å¯¼å…¥/åˆ·æ–°</button>
          </div>
          <div class="hint">å¯¼å…¥è§„åˆ™ï¼šä¼šè‡ªåŠ¨æŠ“å– Step2 ä¸­æ ‡è®°ä¸ºâ€œå…³é”®?â€ = æ˜¯çš„å‡è®¾é—®é¢˜ï¼›ä½ ä¹Ÿå¯ä»¥åœ¨ä¸‹è¡¨ä¸­æ‰‹å·¥è°ƒæ•´ç›®æ ‡ã€‚</div>
        </div>

        <div class="card mt-12">
          <div class="card-header">
            <div class="card-title">å…³é”®æ€§é—®é¢˜æ¸…å• & ç›®æ ‡</div>
          </div>
          <div style="max-height:360px;overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>å…³é”®æ€§é—®é¢˜ï¼ˆæ¥è‡ª Step2 çš„å‡è®¾ï¼‰</th>
                  <th>ç›®æ ‡æè¿°ï¼ˆå†…éƒ¨å¯æ§è¡¨è¿°ï¼‰</th>
                  <th>KPI åç§°</th>
                  <th>å½“å‰å€¼</th>
                  <th>ç›®æ ‡å€¼</th>
                  <th>è¾¾æˆæ—¶é—´</th>
                </tr>
              </thead>
              <tbody id="s3-key-tbody"></tbody>
            </table>
          </div>

          <div class="ai-panel mt-12">
            <div class="ai-panel-header">
              <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step3 è¯Šæ–­</div>
              <div class="flex">
                <button class="btn primary" id="btn-ai-step3">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                <button class="btn" id="btn-ai-step3-apply">å°† AI å»ºè®®æ¨é€åˆ° Step4</button>
              </div>
            </div>
            <div class="ai-output" id="ai-step3-output">
              æˆ‘ä¼šä» SMART åŸåˆ™å‡ºå‘ï¼Œæ£€æŸ¥ç›®æ ‡æ˜¯å¦å…·ä½“ï¼ˆSpecificï¼‰ã€å¯åº¦é‡ï¼ˆMeasurableï¼‰ã€å¯è¾¾æˆï¼ˆAchievableï¼‰ã€ä¸ä¸Šä½ç›®æ ‡ä¸€è‡´ï¼ˆRelevantï¼‰ã€æœ‰æ˜ç¡®æœŸé™ï¼ˆTime-boundï¼‰ï¼Œå¹¶å¸®åŠ©ä½ æç‚¼é€‚åˆä½œä¸º Step4 æ ¹é—®é¢˜çš„è¡¨è¿°ã€‚
            </div>
            <div class="ai-status" id="ai-step3-status"></div>
          </div>
        </div>
      </section>

      <!-- Step4 -->
      <section id="step4" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step4</span> åŸå› åˆ†æï¼ˆé’ˆå¯¹æ¯ä¸ªå…³é”®é—®é¢˜çš„åŸå› é€»è¾‘æ ‘ï¼‰
        </h2>
        <p class="step-desc">
          é€‰æ‹©ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œæ„å»ºå¯¹åº”çš„â€œä¸ºä»€ä¹ˆâ€å¤šå±‚åŸå› é€»è¾‘æ ‘ã€‚è¦æ±‚ï¼šåŸå› æ˜¯å¯éªŒè¯ã€å¯è¢«å¯¹ç­–ç›´æ¥ä½œç”¨çš„â€œå¯æ§å› ç´ â€ï¼Œé¿å…åªé‡å¤æè¿°ç°è±¡ã€‚
        </p>

        <div class="card">
          <div class="card-header">
            <div class="card-title">é€‰æ‹©è¦åˆ†æçš„å…³é”®é—®é¢˜</div>
            <select id="s4-key-select" style="max-width:420px;"></select>
          </div>
          <div class="hint">è¯´æ˜ï¼šæ¯ä¸ªå…³é”®é—®é¢˜éƒ½ä¼šå¯¹åº”ä¸€æ£µç‹¬ç«‹çš„åŸå› æ ‘ã€‚åˆ‡æ¢ä¸‹æ‹‰æ¡†å³å¯åœ¨ä¸åŒåŸå› æ ‘ä¹‹é—´åˆ‡æ¢ã€‚</div>
        </div>

        <div class="grid grid-2 mt-12">
          <div class="card">
            <div class="card-header">
              <div class="card-title">æ–°å¢åŸå› èŠ‚ç‚¹ï¼ˆ5WHY æ€è·¯ï¼‰</div>
            </div>
            <label>åŸå› å±‚çº§ï¼ˆWhy å‡ ï¼Ÿï¼‰</label>
            <select id="s4-new-level">
              <option value="1">Why1 Â· ç›´æ¥åŸå› ï¼ˆç´§è´´ç°è±¡ï¼‰</option>
              <option value="2">Why2 Â· ç›´æ¥åŸå› çš„ä¸Šæ¸¸åŸå› </option>
              <option value="3">Why3</option>
              <option value="4">Why4</option>
              <option value="5">Why5</option>
            </select>

            <label class="mt-8">ä¸Šçº§åŸå› ï¼ˆå¯é€‰ï¼‰</label>
            <select id="s4-new-parent">
              <option value="">æ— ï¼ˆä½œä¸ºè¯¥å…³é”®é—®é¢˜çš„ä¸€çº§åŸå› ï¼‰</option>
            </select>

            <label class="mt-8">åŸå› æè¿°</label>
            <textarea id="s4-new-text" placeholder="æ³¨æ„å†™æˆå¯è¢«éªŒè¯ã€å¯è¢«è¡ŒåŠ¨æ”¹å˜çš„â€œåŸå› â€ï¼Œè€Œä¸æ˜¯ç®€å•é‡å¤ç°è±¡ã€‚"></textarea>

            <label class="mt-8">éœ€è¦å“ªäº›æ•°æ®/äº‹å®æ¥éªŒè¯è¯¥åŸå› ï¼Ÿ</label>
            <textarea id="s4-new-data" placeholder="ä¾‹å¦‚ï¼šæŸæµç¨‹çš„æ—¶é—´æˆ³æ•°æ®ã€æŠ½æ ·æ£€æŸ¥ç»“æœã€è®°å½•è¡¨ã€ç°åœºç…§ç‰‡ç­‰ã€‚"></textarea>

            <label class="mt-8">ç›®å‰æŒæ¡çš„è¯æ®ï¼ˆå¦‚æœ‰ï¼‰</label>
            <textarea id="s4-new-evidence"></textarea>

            <button class="btn primary mt-8" id="btn-s4-add-cause">æ·»åŠ åŸå› </button>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">å½“å‰å…³é”®é—®é¢˜çš„åŸå› é€»è¾‘æ ‘ï¼ˆåˆ—è¡¨è§†å›¾ï¼‰</div>
            </div>
            <div style="max-height:340px;overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>å±‚çº§</th>
                    <th>ä¸Šçº§åŸå› </th>
                    <th>åŸå› æè¿°</th>
                    <th>éªŒè¯æ•°æ®/äº‹å®</th>
                    <th>è¯æ®</th>
                    <th>åˆ </th>
                  </tr>
                </thead>
                <tbody id="s4-cause-tbody"></tbody>
              </table>
            </div>

            <div class="ai-panel mt-12">
              <div class="ai-panel-header">
                <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step4 è¯Šæ–­</div>
                <div class="flex">
                  <button class="btn primary" id="btn-ai-step4">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                  <button class="btn" id="btn-ai-step4-apply">å°† AI å»ºè®®æ¨é€åˆ° Step5</button>
                </div>
              </div>
              <div class="ai-output" id="ai-step4-output">
                æˆ‘ä¼šæ£€æŸ¥ï¼š1ï¼‰åŸå› æ˜¯å¦çœŸæ­£è§£é‡Šäº†ç°è±¡ï¼Œè€Œä¸æ˜¯é‡å¤ç°è±¡ï¼›2ï¼‰ä¸åŒåŸå› ä¹‹é—´æ˜¯å¦å­˜åœ¨å› æœå…³ç³»ï¼›3ï¼‰æ˜¯å¦è¦†ç›–äº†äºº/æœº/æ–™/æ³•/ç¯/æµ‹ç­‰å¸¸è§ç»´åº¦ï¼›4ï¼‰å“ªäº›åŸå› æ›´å¯èƒ½æ˜¯â€œæ ¹æœ¬åŸå› â€ï¼Œé€‚åˆåœ¨ Step5 é’ˆå¯¹æ€§åˆ¶å®šå¯¹ç­–ã€‚
              </div>
              <div class="ai-status" id="ai-step4-status"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Step5 -->
      <section id="step5" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step5</span> å¯¹ç­–é€‰æ‹©ä¸è¯„ä¼°
        </h2>
        <p class="step-desc">
          é’ˆå¯¹æ¯ä¸ªå…³é”®é—®é¢˜ä¸‹çš„æ ¹æœ¬åŸå› ï¼Œè®¾è®¡ä¸å°‘äº 3 ä¸ªå€™é€‰å¯¹ç­–ï¼Œä»â€œå¯æ§æ€§ã€å¯è¡Œæ€§ã€æˆæ•ˆã€æˆæœ¬â€ç­‰ç»´åº¦è¿›è¡Œé‡åŒ–è¯„ä¼°ï¼Œé€‰å‡ºä¼˜å…ˆå®æ–½çš„å¯¹ç­–ã€‚
        </p>

        <div class="card">
          <div class="card-header">
            <div class="card-title">é€‰æ‹©å…³é”®é—®é¢˜ & å…³è”åŸå› </div>
          </div>
          <div class="grid grid-2">
            <div>
              <label>å…³é”®é—®é¢˜</label>
              <select id="s5-key-select"></select>
            </div>
            <div>
              <label>è¦é’ˆå¯¹çš„åŸå› </label>
              <select id="s5-cause-select"></select>
            </div>
          </div>
        </div>

        <div class="grid grid-2 mt-12">
          <div class="card">
            <div class="card-header">
              <div class="card-title">æ–°å¢å¯¹ç­–</div>
            </div>
            <label>å¯¹ç­–æè¿°</label>
            <textarea id="s5-new-plan" placeholder="å†™æ¸…æ¥šè¦æ”¹å˜ä»€ä¹ˆæµç¨‹/åˆ¶åº¦/è¡Œä¸ºï¼Œè€Œä¸æ˜¯æ¨¡ç³Šçš„â€œåŠ å¼ºç®¡ç†â€ã€‚"></textarea>

            <div class="grid grid-4 mt-8">
              <div>
                <label>å¯æ§æ€§ (1~5)</label>
                <input id="s5-new-controllable" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <label>å¯è¡Œæ€§ (1~5)</label>
                <input id="s5-new-feasible" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <label>æˆæ•ˆ (1~5)</label>
                <input id="s5-new-effect" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <label>æˆæœ¬ (1~5ï¼Œåˆ†æ•°è¶Šé«˜æˆæœ¬è¶Šä½)</label>
                <input id="s5-new-cost" type="number" min="1" max="5" value="3" />
              </div>
            </div>

            <button class="btn primary mt-8" id="btn-s5-add-plan">æ·»åŠ å¯¹ç­–</button>
            <div class="hint mt-4">æ€»åˆ† = å¯æ§æ€§ + å¯è¡Œæ€§ + æˆæ•ˆ + æˆæœ¬ã€‚å¯ä»¥ä¼˜å…ˆé€‰æ‹©å¾—åˆ†é«˜ä¸”ä¸æ ¹æœ¬åŸå› ç´§å¯†å¯¹åº”çš„å¯¹ç­–ã€‚</div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">å¯¹ç­–è¯„ä¼°è¡¨</div>
            </div>
            <div style="max-height:340px;overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>å…³é”®é—®é¢˜</th>
                    <th>å¯¹åº”åŸå› </th>
                    <th>å¯¹ç­–æè¿°</th>
                    <th>æ§</th>
                    <th>è¡Œ</th>
                    <th>æ•ˆ</th>
                    <th>æˆ</th>
                    <th>æ€»åˆ†</th>
                    <th>åˆ </th>
                  </tr>
                </thead>
                <tbody id="s5-plan-tbody"></tbody>
              </table>
            </div>

            <div class="ai-panel mt-12">
              <div class="ai-panel-header">
                <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step5 è¯Šæ–­</div>
                <div class="flex">
                  <button class="btn primary" id="btn-ai-step5">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                  <button class="btn" id="btn-ai-step5-apply">å°† AI å»ºè®®æ¨é€åˆ° Step6</button>
                </div>
              </div>
              <div class="ai-output" id="ai-step5-output">
                æˆ‘ä¼šæ£€æŸ¥ï¼šâ‘  å¯¹ç­–æ˜¯å¦ä¸€ä¸€å¯¹åº”åˆ°å…·ä½“åŸå› ï¼›â‘¡ æ˜¯å¦å­˜åœ¨â€œå¤šå¤´ç®¡ç†ã€é‡å¤å¯¹ç­–â€ï¼›â‘¢ æ˜¯å¦è€ƒè™‘äº†æ‰§è¡Œæˆæœ¬ä¸é£é™©ï¼›â‘£ å»ºè®®ä¼˜å…ˆå®æ–½çš„å¯¹ç­–ç»„åˆã€‚
              </div>
              <div class="ai-status" id="ai-step5-status"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Step6 -->
      <section id="step6" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step6</span> åˆ¶å®šè¡ŒåŠ¨è®¡åˆ’ & çœ‹æ¿ç®¡ç†
        </h2>
        <p class="step-desc">
          å°†é€‰å®šçš„å¯¹ç­–æ‹†è§£ä¸ºå¯æ‰§è¡Œçš„è¡ŒåŠ¨ä»»åŠ¡ï¼Œæ˜ç¡®è´£ä»»äººã€èµ·æ­¢æ—¶é—´ã€å…³é”®é‡Œç¨‹ç¢‘ä¸æ£€æŸ¥ç‚¹ï¼Œä»¥å°æ­¥å¿«è·‘ã€å¯è§†åŒ–è·Ÿè¸ªçš„æ–¹å¼æ¨è¿›è½åœ°ã€‚
        </p>

        <div class="card">
          <div class="card-header">
            <div class="card-title">é€‰æ‹©æ¥æºå¯¹ç­–</div>
          </div>
          <div class="grid grid-2">
            <div>
              <label>å…³é”®é—®é¢˜</label>
              <select id="s6-key-select"></select>
            </div>
            <div>
              <label>å¯¹ç­–</label>
              <select id="s6-plan-select"></select>
            </div>
          </div>
        </div>

        <div class="grid grid-2 mt-12">
          <div class="card">
            <div class="card-header">
              <div class="card-title">æ–°å¢è¡ŒåŠ¨ä»»åŠ¡</div>
            </div>
            <label>è¡ŒåŠ¨ä»»åŠ¡å†…å®¹</label>
            <textarea id="s6-new-task" placeholder="ç”¨åŠ¨è¯å¼€å¤´æè¿°è¦åšçš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šåˆ¶å®šXXæµç¨‹ã€æ¢³ç†XXæ¸…å•ã€å¼€å‘XXçœ‹æ¿ç­‰ï¼‰ã€‚"></textarea>
            <div class="grid grid-3 mt-8">
              <div>
                <label>è´£ä»»äºº</label>
                <input id="s6-new-owner" type="text" />
              </div>
              <div>
                <label>è®¡åˆ’å¼€å§‹</label>
                <input id="s6-new-start" type="date" />
              </div>
              <div>
                <label>è®¡åˆ’å®Œæˆ</label>
                <input id="s6-new-end" type="date" />
              </div>
            </div>
            <label class="mt-8">é‡Œç¨‹ç¢‘/æ£€æŸ¥ç‚¹è¯´æ˜</label>
            <textarea id="s6-new-milestone"></textarea>
            <button class="btn primary mt-8" id="btn-s6-add-action">æ·»åŠ è¡ŒåŠ¨</button>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">è¡ŒåŠ¨è®¡åˆ’çœ‹æ¿ï¼ˆç®€ç‰ˆï¼‰</div>
            </div>
            <div style="max-height:340px;overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>å…³é”®é—®é¢˜</th>
                    <th>å¯¹ç­–</th>
                    <th>ä»»åŠ¡</th>
                    <th>è´£ä»»äºº</th>
                    <th>èµ·</th>
                    <th>æ­¢</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ </th>
                  </tr>
                </thead>
                <tbody id="s6-action-tbody"></tbody>
              </table>
            </div>

            <div class="ai-panel mt-12">
              <div class="ai-panel-header">
                <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step6 è¯Šæ–­</div>
                <div class="flex">
                  <button class="btn primary" id="btn-ai-step6">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                  <button class="btn" id="btn-ai-step6-apply">å°† AI å»ºè®®æ¨é€åˆ° Step7</button>
                </div>
              </div>
              <div class="ai-output" id="ai-step6-output">
                æˆ‘ä¼šå…³æ³¨ï¼šä»»åŠ¡æ˜¯å¦æ‹†å¾—è¶³å¤Ÿå…·ä½“ã€è´£ä»»æ˜¯å¦æ˜ç¡®ã€èŠ‚å¥æ˜¯å¦åˆç†ï¼Œå¹¶æé†’ä½ å¯èƒ½è¢«å¿½ç•¥çš„é£é™©æ§åˆ¶ç‚¹ã€‚
              </div>
              <div class="ai-status" id="ai-step6-status"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Step7 -->
      <section id="step7" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step7</span> è¿‡ç¨‹ & ç»“æœè¯„ä¼°
        </h2>
        <p class="step-desc">
          é€šè¿‡ç›®æ ‡æ€§æŒ‡æ ‡å’Œå…¶ä»–è¾…åŠ©æŒ‡æ ‡ï¼Œå¯¹æ”¹å–„å‰åè¿›è¡Œå¯¹æ¯”è¯„ä¼°ï¼ŒåŒæ—¶åæ€è¿‡ç¨‹ä¸­æœ‰å“ªäº›ç»éªŒå’Œæ•™è®­ï¼Œä¸ºåç»­æ ‡å‡†åŒ–ä¸å¤åˆ¶åšå‡†å¤‡ã€‚
        </p>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ä» Step3 å¯¼å…¥ç›®æ ‡æ€§æŒ‡æ ‡</div>
            <button class="btn" id="btn-s7-import">å¯¼å…¥/åˆ·æ–°</button>
          </div>
          <div class="hint">ä¼šæ ¹æ® Step3 ä¸­çš„å…³é”®é—®é¢˜ç›®æ ‡è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ KPI è¯„ä¼°è¡Œï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹è¡¥å……å…¶ä»–æŒ‡æ ‡ã€‚</div>
        </div>

        <div class="card mt-12">
          <div class="card-header">
            <div class="card-title">æŒ‡æ ‡å¯¹æ¯”è¡¨</div>
          </div>
          <div style="max-height:340px;overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>ç±»åˆ«</th>
                  <th>å…³é”®é—®é¢˜/æŒ‡æ ‡è¯´æ˜</th>
                  <th>æ”¹å–„å‰</th>
                  <th>ç›®æ ‡å€¼</th>
                  <th>æ”¹å–„å</th>
                  <th>% æ”¹å–„</th>
                  <th>åˆ </th>
                </tr>
              </thead>
              <tbody id="s7-kpi-tbody"></tbody>
            </table>
          </div>

          <label class="mt-8">è¿‡ç¨‹ä¸­çš„å…³é”®å‘ç°ä¸å­¦ä¹ </label>
          <textarea id="s7-process-notes" placeholder="è®°å½•è¿‡ç¨‹ä¸­è§‚å¯Ÿåˆ°çš„è§„å¾‹ã€å…³é”®æˆåŠŸè¦ç´ å’Œè¸©è¿‡çš„å‘ã€‚"></textarea>

          <div class="ai-panel mt-12">
            <div class="ai-panel-header">
              <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step7 è¯Šæ–­</div>
              <div class="flex">
                <button class="btn primary" id="btn-ai-step7">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                <button class="btn" id="btn-ai-step7-apply">å°† AI å»ºè®®æ¨é€åˆ° Step8</button>
              </div>
            </div>
            <div class="ai-output" id="ai-step7-output">
              æˆ‘ä¼šå¸®ä½ ï¼šâ‘  æ€»ç»“æœ¬æ¬¡æ”¹å–„é¡¹ç›®åœ¨ç»“æœä¸Šçš„äº®ç‚¹ä¸ä¸è¶³ï¼›â‘¡ æé†’ä½ è¯„ä¼°ç»“æœä¸­å¯èƒ½å­˜åœ¨çš„ç»Ÿè®¡åå·®ï¼›â‘¢ æç‚¼ 2~3 æ¡å¯ä»¥å¤åˆ¶æ¨å¹¿çš„ç»éªŒè¦ç‚¹ã€‚
            </div>
            <div class="ai-status" id="ai-step7-status"></div>
          </div>
        </div>
      </section>

      <!-- Step8 -->
      <section id="step8" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Step8</span> æ ‡å‡†åŒ– & å¤ç›˜
        </h2>
        <p class="step-desc">
          æŠŠæœ‰æ•ˆåšæ³•æ²‰æ·€ä¸ºå¯å¤åˆ¶çš„æ ‡å‡†å’Œèµ„æºï¼Œå½¢æˆæ ‡å‡†åŒ–æ”¯æŒè®¡åˆ’ï¼›åŒæ—¶å®Œæˆä¸ªäººä¸å›¢é˜Ÿçš„å¤ç›˜ï¼Œæ˜ç¡®ä¸‹ä¸€è½®æ”¹è¿›çš„ç€åŠ›ç‚¹ã€‚
        </p>

        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">æ ‡å‡†åŒ–æ”¯æŒè®¡åˆ’</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>æ ‡å‡†åŒ–å†…å®¹/æ–‡ä»¶</th>
                  <th>è´£ä»»äºº</th>
                  <th>å®Œæˆæ—¶é—´</th>
                  <th>å®Œæˆåº¦%</th>
                  <th>åˆ </th>
                </tr>
              </thead>
              <tbody id="s8-std-tbody"></tbody>
            </table>
            <button class="btn primary mt-8" id="btn-s8-add-std">æ–°å¢æ ‡å‡†åŒ–æ¡ç›®</button>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">ä¸ªäººå¤ç›˜ï¼ˆå·¥å…·å®è·µ / ç›®æ ‡ç»“æœ / ç»„ç»‡è´¡çŒ® / ä¸Šçº§æ²Ÿé€šç­‰ï¼‰</div>
            </div>
            <textarea id="s8-retro" style="min-height:220px;" placeholder="ä»â€œåšå¾—å¥½çš„åœ°æ–¹ / éœ€è¦æ”¹è¿›çš„èƒ½åŠ› / ä¸‹ä¸€ä¸ªé¡¹ç›®è¦é¿å…çš„å‘â€ä¸‰ä¸ªè§’åº¦åšç®€çŸ­å¤ç›˜ã€‚"></textarea>

            <div class="ai-panel mt-12">
              <div class="ai-panel-header">
                <div class="ai-title"><span>ğŸ¤–</span> AI æ•™ç»ƒ Â· Step8 è¯Šæ–­</div>
                <div class="flex">
                  <button class="btn primary" id="btn-ai-step8">AI æ•™ç»ƒè¯„ä»·æœ¬æ­¥</button>
                </div>
              </div>
              <div class="ai-output" id="ai-step8-output">
                æˆ‘ä¼šæ ¹æ®å‰ 7 æ­¥çš„ä¿¡æ¯ï¼Œå¸®ä½ æç‚¼ï¼š1ï¼‰å¯ä»¥åœ¨å›¢é˜Ÿ/ç»„ç»‡å±‚é¢æ¨å¹¿çš„åšæ³•ï¼›2ï¼‰ä¸ªäººåœ¨é—®é¢˜åˆ†æä¸è§£å†³èƒ½åŠ›ä¸Šçš„æå‡ç‚¹ï¼›3ï¼‰ä¸‹ä¸€è½® PDCA å¯ä»¥å…³æ³¨çš„æ–¹å‘ã€‚
              </div>
              <div class="ai-status" id="ai-step8-status"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Report -->
      <section id="report" class="tab-panel">
        <h2 class="step-title">
          <span class="step-badge">Report</span> é¡¹ç›®é—®é¢˜åˆ†æä¸è§£å†³æŠ¥å‘Šï¼ˆé¢„è§ˆï¼‰
        </h2>
        <p class="step-desc">
          è¿™é‡Œæ ¹æ®å‰ 1~8 æ­¥çš„æ•°æ®è‡ªåŠ¨ç”Ÿæˆä¸€ä»½ç»“æ„åŒ–çš„é¡¹ç›®æŠ¥å‘Šï¼Œä½ å¯ä»¥å¯¼å‡ºä¸ºç‹¬ç«‹ HTML æ–‡ä»¶è¿›è¡Œåˆ†äº«æˆ–æ‰“å°ã€‚
        </p>

        <div class="flex mb-4">
          <button class="btn primary" id="btn-report-refresh">åˆ·æ–°æŠ¥å‘Š</button>
        </div>

        <div id="report-content" style="font-size:13px;"></div>
      </section>
    </div>
  </div>
</div>

<script>
  // --------------- å…¨å±€çŠ¶æ€ & æœ¬åœ°å­˜å‚¨ -----------------
  const STORAGE_KEY = "pas8_ai_tool_state_v1";

  const defaultState = {
    step1: {
      ideal: "",
      idealKPI: "",
      currentKPI: "",
      gap: "",
      gapShort: "",
      bigProblem: "",
      w: {
        what: "",
        where: "",
        when: "",
        who: "",
        why: "",
        how: "",
        howmuch: "",
      },
    },
    step2: {
      hypotheses: [], // {id,text,dimension,parentId,evidence,importance,urgency,isKey}
      aiSuggestion: null,
    },
    step3: {
      keyProblems: [], // {id,sourceHypoId,sourceText,goal,kpiName,currentValue,targetValue,deadline}
      aiSuggestion: null,
    },
    step4: {
      causes: [], // {id,keyProblemId,level,parentId,text,dataNeeded,evidence}
      currentKeyProblemId: "",
      aiSuggestion: null,
    },
    step5: {
      plans: [], // {id,keyProblemId,causeId,desc,controllable,feasible,effect,cost}
      aiSuggestion: null,
    },
    step6: {
      actions: [], // {id,keyProblemId,planId,task,owner,start,end,status}
      aiSuggestion: null,
    },
    step7: {
      kpis: [], // {id,category,refKeyProblemId,label,before,target,after,improvePercent}
      processNotes: "",
      aiSuggestion: null,
    },
    step8: {
      standards: [], // {id,title,owner,due,progress}
      retro: "",
      aiSuggestion: null,
    },
    ai: {
      step1: null,
      step2: null,
      step3: null,
      step4: null,
      step5: null,
      step6: null,
      step7: null,
      step8: null,
    },
  };

  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return structuredClone(defaultState);
      const obj = JSON.parse(raw);
      return Object.assign(structuredClone(defaultState), obj);
    } catch (e) {
      console.warn("loadState error", e);
      return structuredClone(defaultState);
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function uuid() {
    return (
      Date.now().toString(36) +
      "-" +
      Math.random().toString(36).substring(2, 8)
    );
  }

  // --------------- Tab åˆ‡æ¢ -----------------
  document.querySelectorAll(".tab-header button").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      document
        .querySelectorAll(".tab-header button")
        .forEach((b) => b.classList.toggle("active", b === btn));
      document
        .querySelectorAll(".tab-panel")
        .forEach((p) => p.classList.toggle("active", p.id === tab));
      if (tab === "report") {
        buildReport();
      }
    });
  });

  // --------------- Step1 ç»‘å®š -----------------
  function initStep1() {
    const s = state.step1;
    document.getElementById("s1-ideal").value = s.ideal;
    document.getElementById("s1-ideal-kpi").value = s.idealKPI;
    document.getElementById("s1-current-kpi").value = s.currentKPI;
    document.getElementById("s1-gap").value = s.gap;
    document.getElementById("s1-gap-short").textContent =
      s.gapShort || "å°šæœªæç‚¼";
    document.getElementById("s1-big-problem").value = s.bigProblem;

    document.getElementById("s1-5w-what").value = s.w.what;
    document.getElementById("s1-5w-where").value = s.w.where;
    document.getElementById("s1-5w-when").value = s.w.when;
    document.getElementById("s1-5w-wwho");
    document.getElementById("s1-5w-who").value = s.w.who;
    document.getElementById("s1-5w-why").value = s.w.why;
    document.getElementById("s1-5w-how").value = s.w.how;
    document.getElementById("s1-5w-howmuch").value = s.w.howmuch;

    bindInput("s1-ideal", (v) => (state.step1.ideal = v));
    bindInput("s1-ideal-kpi", (v) => (state.step1.idealKPI = v));
    bindInput("s1-current-kpi", (v) => (state.step1.currentKPI = v));
    bindInput("s1-gap", (v) => (state.step1.gap = v));
    bindInput("s1-big-problem", (v) => (state.step1.bigProblem = v));

    bindInput("s1-5w-what", (v) => (state.step1.w.what = v));
    bindInput("s1-5w-where", (v) => (state.step1.w.where = v));
    bindInput("s1-5w-when", (v) => (state.step1.w.when = v));
    bindInput("s1-5w-who", (v) => (state.step1.w.who = v));
    bindInput("s1-5w-why", (v) => (state.step1.w.why = v));
    bindInput("s1-5w-how", (v) => (state.step1.w.how = v));
    bindInput("s1-5w-howmuch", (v) => (state.step1.w.howmuch = v));
  }

  function bindInput(id, updater) {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", () => {
      updater(el.value);
      saveState();
    });
  }

  // --------------- Step2 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep2() {
    document.getElementById("s2-root-problem").value =
      state.step1.bigProblem || "ï¼ˆå°šæœªä» Step1 åŒæ­¥ï¼Œè¯·åœ¨ Step1 ä¸­å¡«å†™â€œå¤§é—®é¢˜â€ï¼‰";

    const selectParent = document.getElementById("s2-new-parent");
    while (selectParent.options.length > 1) {
      selectParent.remove(1);
    }
    state.step2.hypotheses.forEach((h) => {
      const opt = document.createElement("option");
      opt.value = h.id;
      opt.textContent = h.text.slice(0, 30);
      selectParent.appendChild(opt);
    });

    // list
    const tbody = document.getElementById("s2-hypo-tbody");
    tbody.innerHTML = "";
    state.step2.hypotheses.forEach((h, idx) => {
      const tr = document.createElement("tr");
      const priority = (Number(h.importance) || 0) * (Number(h.urgency) || 0);
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td><textarea data-hypo-id="${h.id}" data-field="text">${h.text}</textarea></td>
        <td>
          <select data-hypo-id="${h.id}" data-field="dimension">
            ${renderOptions(
              ["", "ç»“æ„/ç»„æˆ", "æµç¨‹/æ—¶é—´", "ç©ºé—´/åŒºåŸŸ", "å®¢æˆ·/å¯¹è±¡", "å…¶å®ƒ"],
              h.dimension
            )}
          </select>
        </td>
        <td>
          <select data-hypo-id="${h.id}" data-field="parentId">
            <option value="">æ— </option>
            ${state.step2.hypotheses
              .map(
                (x) =>
                  `<option value="${x.id}" ${
                    x.id === h.parentId ? "selected" : ""
                  }>${x.text.slice(0, 12)}</option>`
              )
              .join("")}
          </select>
        </td>
        <td><textarea data-hypo-id="${h.id}" data-field="evidence">${h.evidence || ""}</textarea></td>
        <td><input type="number" min="1" max="5" data-hypo-id="${h.id}" data-field="importance" value="${
        h.importance || 3
      }"/></td>
        <td><input type="number" min="1" max="5" data-hypo-id="${h.id}" data-field="urgency" value="${
        h.urgency || 3
      }"/></td>
        <td>
          <select data-hypo-id="${h.id}" data-field="isKey">
            <option value="no" ${h.isKey ? "" : "selected"}>å¦</option>
            <option value="yes" ${h.isKey ? "selected" : ""}>æ˜¯</option>
          </select>
          <div class="small">${priority ? "ä¼˜å…ˆçº§ï¼š" + priority : ""}</div>
        </td>
        <td class="text-right"><button class="btn" data-delete-hypo="${h.id}">âœ•</button></td>
      `;
      tbody.appendChild(tr);
    });

    // key tags
    const tagBox = document.getElementById("s2-key-tags");
    tagBox.innerHTML = "";
    state.step2.hypotheses
      .filter((h) => h.isKey)
      .forEach((h) => {
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = "å…³é”®å€™é€‰ï¼š" + h.text.slice(0, 18);
        tagBox.appendChild(span);
      });
  }

  function renderOptions(arr, value) {
    return arr
      .map((x) => {
        if (!x) return `<option value=""></option>`;
        return `<option value="${x}" ${
          x === value ? "selected" : ""
        }>${x}</option>`;
      })
      .join("");
  }

  document
    .getElementById("s2-hypo-tbody")
    .addEventListener("input", (e) => {
      const target = e.target;
      const id = target.dataset.hypoId;
      const field = target.dataset.field;
      if (!id || !field) return;
      const h = state.step2.hypotheses.find((x) => x.id === id);
      if (!h) return;
      h[field] = target.value;
      saveState();
    });

  document
    .getElementById("s2-hypo-tbody")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-delete-hypo]");
      if (!btn) return;
      const id = btn.dataset.deleteHypo;
      state.step2.hypotheses = state.step2.hypotheses.filter(
        (x) => x.id !== id
      );
      saveState();
      renderStep2();
    });

  document.getElementById("btn-s2-add-hypo").addEventListener("click", () => {
    const text = document.getElementById("s2-new-text").value.trim();
    if (!text) {
      alert("è¯·å…ˆå¡«å†™å‡è®¾é—®é¢˜æè¿°ã€‚");
      return;
    }
    const h = {
      id: uuid(),
      text,
      dimension: document.getElementById("s2-new-dimension").value,
      parentId: document.getElementById("s2-new-parent").value || "",
      evidence: document.getElementById("s2-new-evidence").value.trim(),
      importance: Number(
        document.getElementById("s2-new-importance").value || 3
      ),
      urgency: Number(document.getElementById("s2-new-urgency").value || 3),
      isKey: document.getElementById("s2-new-key").value === "yes",
    };
    state.step2.hypotheses.push(h);
    saveState();
    document.getElementById("s2-new-text").value = "";
    document.getElementById("s2-new-evidence").value = "";
    renderStep2();
  });

  document.getElementById("btn-s2-sort").addEventListener("click", () => {
    state.step2.hypotheses.sort((a, b) => {
      const pa = (a.importance || 0) * (a.urgency || 0);
      const pb = (b.importance || 0) * (b.urgency || 0);
      return pb - pa;
    });
    saveState();
    renderStep2();
  });

  document
    .getElementById("btn-s2-sync-from-step1")
    .addEventListener("click", () => {
      document.getElementById("s2-root-problem").value =
        state.step1.bigProblem || "";
    });

  // --------------- Step3 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep3() {
    const tbody = document.getElementById("s3-key-tbody");
    tbody.innerHTML = "";
    state.step3.keyProblems.forEach((kp, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${kp.sourceText}</td>
        <td><textarea data-kp-id="${kp.id}" data-kp-field="goal">${
        kp.goal || ""
      }</textarea></td>
        <td><input data-kp-id="${kp.id}" data-kp-field="kpiName" value="${
        kp.kpiName || ""
      }"/></td>
        <td><input data-kp-id="${kp.id}" data-kp-field="currentValue" value="${
        kp.currentValue || ""
      }"/></td>
        <td><input data-kp-id="${kp.id}" data-kp-field="targetValue" value="${
        kp.targetValue || ""
      }"/></td>
        <td><input type="date" data-kp-id="${kp.id}" data-kp-field="deadline" value="${
        kp.deadline || ""
      }"/></td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("btn-s3-import").addEventListener("click", () => {
    const keyHypos = state.step2.hypotheses.filter((h) => h.isKey);
    keyHypos.forEach((h) => {
      if (!state.step3.keyProblems.find((kp) => kp.sourceHypoId === h.id)) {
        state.step3.keyProblems.push({
          id: uuid(),
          sourceHypoId: h.id,
          sourceText: h.text,
          goal: "",
          kpiName: "",
          currentValue: "",
          targetValue: "",
          deadline: "",
        });
      }
    });
    saveState();
    renderStep3();
  });

  document
    .getElementById("s3-key-tbody")
    .addEventListener("input", (e) => {
      const id = e.target.dataset.kpId;
      const field = e.target.dataset.kpField;
      if (!id || !field) return;
      const kp = state.step3.keyProblems.find((x) => x.id === id);
      if (!kp) return;
      kp[field] = e.target.value;
      saveState();
    });

  // --------------- Step4 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep4KeySelect() {
    const sel = document.getElementById("s4-key-select");
    sel.innerHTML = "";
    const def = document.createElement("option");
    def.value = "";
    def.textContent = "è¯·é€‰æ‹©å…³é”®é—®é¢˜";
    sel.appendChild(def);
    state.step3.keyProblems.forEach((kp) => {
      const opt = document.createElement("option");
      opt.value = kp.id;
      opt.textContent = kp.sourceText.slice(0, 40);
      sel.appendChild(opt);
    });
    if (state.step4.currentKeyProblemId) {
      sel.value = state.step4.currentKeyProblemId;
    }
  }

  function renderStep4() {
    renderStep4KeySelect();

    const keyId = state.step4.currentKeyProblemId;
    const causeTbody = document.getElementById("s4-cause-tbody");
    causeTbody.innerHTML = "";

    const parentSelect = document.getElementById("s4-new-parent");
    while (parentSelect.options.length > 1) parentSelect.remove(1);

    if (!keyId) return;

    const causes = state.step4.causes.filter((c) => c.keyProblemId === keyId);
    causes.forEach((c, idx) => {
      const tr = document.createElement("tr");
      const parent =
        causes.find((x) => x.id === c.parentId)?.text.slice(0, 24) || "";
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>Why${c.level}</td>
        <td>${parent}</td>
        <td><textarea data-cause-id="${c.id}" data-cause-field="text">${
        c.text || ""
      }</textarea></td>
        <td><textarea data-cause-id="${c.id}" data-cause-field="dataNeeded">${
        c.dataNeeded || ""
      }</textarea></td>
        <td><textarea data-cause-id="${c.id}" data-cause-field="evidence">${
        c.evidence || ""
      }</textarea></td>
        <td class="text-right"><button class="btn" data-delete-cause="${
          c.id
        }">âœ•</button></td>
      `;
      causeTbody.appendChild(tr);
    });

    causes.forEach((c) => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `Why${c.level}-${c.text.slice(0, 24)}`;
      parentSelect.appendChild(opt);
    });
  }

  document.getElementById("s4-key-select").addEventListener("change", (e) => {
    state.step4.currentKeyProblemId = e.target.value;
    saveState();
    renderStep4();
    renderStep5Selects();
    renderStep6Selects();
  });

  document.getElementById("btn-s4-add-cause").addEventListener("click", () => {
    const keyId = state.step4.currentKeyProblemId;
    if (!keyId) {
      alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚");
      return;
    }
    const text = document.getElementById("s4-new-text").value.trim();
    if (!text) {
      alert("è¯·å¡«å†™åŸå› æè¿°ã€‚");
      return;
    }
    const cause = {
      id: uuid(),
      keyProblemId: keyId,
      level: Number(document.getElementById("s4-new-level").value || 1),
      parentId: document.getElementById("s4-new-parent").value || "",
      text,
      dataNeeded: document.getElementById("s4-new-data").value.trim(),
      evidence: document.getElementById("s4-new-evidence").value.trim(),
    };
    state.step4.causes.push(cause);
    saveState();
    document.getElementById("s4-new-text").value = "";
    document.getElementById("s4-new-data").value = "";
    document.getElementById("s4-new-evidence").value = "";
    renderStep4();
    renderStep5Selects();
  });

  document
    .getElementById("s4-cause-tbody")
    .addEventListener("input", (e) => {
      const id = e.target.dataset.causeId;
      const field = e.target.dataset.causeField;
      if (!id || !field) return;
      const c = state.step4.causes.find((x) => x.id === id);
      if (!c) return;
      c[field] = e.target.value;
      saveState();
    });

  document
    .getElementById("s4-cause-tbody")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-delete-cause]");
      if (!btn) return;
      const id = btn.dataset.deleteCause;
      state.step4.causes = state.step4.causes.filter((x) => x.id !== id);
      saveState();
      renderStep4();
      renderStep5Selects();
    });

  // --------------- Step5 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep5Selects() {
    const keySel = document.getElementById("s5-key-select");
    keySel.innerHTML = "";
    state.step3.keyProblems.forEach((kp) => {
      const opt = document.createElement("option");
      opt.value = kp.id;
      opt.textContent = kp.sourceText.slice(0, 40);
      keySel.appendChild(opt);
    });

    const causeSel = document.getElementById("s5-cause-select");
    causeSel.innerHTML = "";
    const keyId = keySel.value || (state.step3.keyProblems[0] || {}).id;
    if (keyId) keySel.value = keyId;
    const causes = state.step4.causes.filter((c) => c.keyProblemId === keyId);
    causes.forEach((c) => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `Why${c.level}-${c.text.slice(0, 30)}`;
      causeSel.appendChild(opt);
    });

    renderStep5Plans();
  }

  function renderStep5Plans() {
    const tbody = document.getElementById("s5-plan-tbody");
    tbody.innerHTML = "";
    state.step5.plans.forEach((p, idx) => {
      const kp =
        state.step3.keyProblems.find((k) => k.id === p.keyProblemId) || {};
      const cause =
        state.step4.causes.find((c) => c.id === p.causeId) || {};
      const total =
        (Number(p.controllable) || 0) +
        (Number(p.feasible) || 0) +
        (Number(p.effect) || 0) +
        (Number(p.cost) || 0);
      const cls =
        total >= 16 ? "priority-high" : total >= 12 ? "priority-medium" : "priority-low";
      tbody.innerHTML += `
        <tr>
          <td>${idx + 1}</td>
          <td>${kp.sourceText ? kp.sourceText.slice(0, 20) : ""}</td>
          <td>${cause.text ? cause.text.slice(0, 20) : ""}</td>
          <td><textarea data-plan-id="${p.id}" data-plan-field="desc">${
        p.desc || ""
      }</textarea></td>
          <td><input type="number" min="1" max="5" data-plan-id="${
            p.id
          }" data-plan-field="controllable" value="${p.controllable || 0}"/></td>
          <td><input type="number" min="1" max="5" data-plan-id="${
            p.id
          }" data-plan-field="feasible" value="${p.feasible || 0}"/></td>
          <td><input type="number" min="1" max="5" data-plan-id="${
            p.id
          }" data-plan-field="effect" value="${p.effect || 0}"/></td>
          <td><input type="number" min="1" max="5" data-plan-id="${
            p.id
          }" data-plan-field="cost" value="${p.cost || 0}"/></td>
          <td class="${cls}">${total}</td>
          <td class="text-right"><button class="btn" data-delete-plan="${
            p.id
          }">âœ•</button></td>
        </tr>
      `;
    });
  }

  document.getElementById("btn-s5-add-plan").addEventListener("click", () => {
    const keyId = document.getElementById("s5-key-select").value;
    const causeId = document.getElementById("s5-cause-select").value;
    if (!keyId || !causeId) {
      alert("è¯·å…ˆé€‰æ‹©å…³é”®é—®é¢˜å’ŒåŸå› ã€‚");
      return;
    }
    const desc = document.getElementById("s5-new-plan").value.trim();
    if (!desc) {
      alert("è¯·å¡«å†™å¯¹ç­–æè¿°ã€‚");
      return;
    }
    const p = {
      id: uuid(),
      keyProblemId: keyId,
      causeId,
      desc,
      controllable: Number(
        document.getElementById("s5-new-controllable").value || 0
      ),
      feasible: Number(
        document.getElementById("s5-new-feasible").value || 0
      ),
      effect: Number(document.getElementById("s5-new-effect").value || 0),
      cost: Number(document.getElementById("s5-new-cost").value || 0),
    };
    state.step5.plans.push(p);
    saveState();
    document.getElementById("s5-new-plan").value = "";
    renderStep5Plans();
    renderStep6Selects();
  });

  document
    .getElementById("s5-plan-tbody")
    .addEventListener("input", (e) => {
      const id = e.target.dataset.planId;
      const field = e.target.dataset.planField;
      if (!id || !field) return;
      const p = state.step5.plans.find((x) => x.id === id);
      if (!p) return;
      p[field] = e.target.value;
      saveState();
      renderStep5Plans();
    });

  document
    .getElementById("s5-plan-tbody")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-delete-plan]");
      if (!btn) return;
      const id = btn.dataset.deletePlan;
      state.step5.plans = state.step5.plans.filter((x) => x.id !== id);
      saveState();
      renderStep5Plans();
      renderStep6Selects();
    });

  // --------------- Step6 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep6Selects() {
    const keySel = document.getElementById("s6-key-select");
    keySel.innerHTML = "";
    state.step3.keyProblems.forEach((kp) => {
      const opt = document.createElement("option");
      opt.value = kp.id;
      opt.textContent = kp.sourceText.slice(0, 40);
      keySel.appendChild(opt);
    });

    const planSel = document.getElementById("s6-plan-select");
    planSel.innerHTML = "";
    const keyId = keySel.value || (state.step3.keyProblems[0] || {}).id;
    if (keyId) keySel.value = keyId;
    state.step5.plans
      .filter((p) => p.keyProblemId === keyId)
      .forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.desc.slice(0, 40);
        planSel.appendChild(opt);
      });
    renderStep6Actions();
  }

  function renderStep6Actions() {
    const tbody = document.getElementById("s6-action-tbody");
    tbody.innerHTML = "";
    state.step6.actions.forEach((a, idx) => {
      const kp =
        state.step3.keyProblems.find((k) => k.id === a.keyProblemId) || {};
      const plan = state.step5.plans.find((p) => p.id === a.planId) || {};
      tbody.innerHTML += `
        <tr>
          <td>${idx + 1}</td>
          <td>${kp.sourceText ? kp.sourceText.slice(0, 16) : ""}</td>
          <td>${plan.desc ? plan.desc.slice(0, 16) : ""}</td>
          <td><textarea data-act-id="${a.id}" data-act-field="task">${
        a.task || ""
      }</textarea></td>
          <td><input data-act-id="${a.id}" data-act-field="owner" value="${
        a.owner || ""
      }"/></td>
          <td><input type="date" data-act-id="${a.id}" data-act-field="start" value="${
        a.start || ""
      }"/></td>
          <td><input type="date" data-act-id="${a.id}" data-act-field="end" value="${
        a.end || ""
      }"/></td>
          <td>
            <select data-act-id="${a.id}" data-act-field="status">
              ${renderOptions(["æœªå¼€å§‹", "è¿›è¡Œä¸­", "å·²å®Œæˆ", "é˜»å¡"], a.status || "")}
            </select>
          </td>
          <td class="text-right"><button class="btn" data-delete-act="${
            a.id
          }">âœ•</button></td>
        </tr>
      `;
    });
  }

  document.getElementById("btn-s6-add-action").addEventListener("click", () => {
    const keyId = document.getElementById("s6-key-select").value;
    const planId = document.getElementById("s6-plan-select").value;
    if (!keyId || !planId) {
      alert("è¯·å…ˆé€‰æ‹©å…³é”®é—®é¢˜å’Œå¯¹ç­–ã€‚");
      return;
    }
    const task = document.getElementById("s6-new-task").value.trim();
    if (!task) {
      alert("è¯·å¡«å†™è¡ŒåŠ¨ä»»åŠ¡å†…å®¹ã€‚");
      return;
    }
    const a = {
      id: uuid(),
      keyProblemId: keyId,
      planId,
      task,
      owner: document.getElementById("s6-new-owner").value.trim(),
      start: document.getElementById("s6-new-start").value,
      end: document.getElementById("s6-new-end").value,
      status: "æœªå¼€å§‹",
      milestone: document.getElementById("s6-new-milestone").value.trim(),
    };
    state.step6.actions.push(a);
    saveState();
    document.getElementById("s6-new-task").value = "";
    document.getElementById("s6-new-milestone").value = "";
    renderStep6Actions();
  });

  document
    .getElementById("s6-action-tbody")
    .addEventListener("input", (e) => {
      const id = e.target.dataset.actId;
      const field = e.target.dataset.actField;
      if (!id || !field) return;
      const a = state.step6.actions.find((x) => x.id === id);
      if (!a) return;
      a[field] = e.target.value;
      saveState();
      renderStep6Actions();
    });

  document
    .getElementById("s6-action-tbody")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-delete-act]");
      if (!btn) return;
      const id = btn.dataset.deleteAct;
      state.step6.actions = state.step6.actions.filter((x) => x.id !== id);
      saveState();
      renderStep6Actions();
    });

  // --------------- Step7 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep7() {
    document.getElementById("s7-process-notes").value =
      state.step7.processNotes || "";
    const tbody = document.getElementById("s7-kpi-tbody");
    tbody.innerHTML = "";
    state.step7.kpis.forEach((k, idx) => {
      const before = Number(k.before);
      const after = Number(k.after);
      let pct = "";
      if (!isNaN(before) && !isNaN(after) && before !== 0) {
        pct = (((after - before) / Math.abs(before)) * 100).toFixed(1);
        k.improvePercent = pct;
      }
      tbody.innerHTML += `
        <tr>
          <td>${idx + 1}</td>
          <td>${k.category || ""}</td>
          <td><textarea data-kpi-id="${k.id}" data-kpi-field="label">${
        k.label || ""
      }</textarea></td>
          <td><input data-kpi-id="${k.id}" data-kpi-field="before" value="${
        k.before || ""
      }"/></td>
          <td><input data-kpi-id="${k.id}" data-kpi-field="target" value="${
        k.target || ""
      }"/></td>
          <td><input data-kpi-id="${k.id}" data-kpi-field="after" value="${
        k.after || ""
      }"/></td>
          <td>${pct ? pct + "%" : ""}</td>
          <td class="text-right"><button class="btn" data-delete-kpi="${
            k.id
          }">âœ•</button></td>
        </tr>
      `;
    });
  }

  document
    .getElementById("s7-kpi-tbody")
    .addEventListener("input", (e) => {
      const id = e.target.dataset.kpiId;
      const field = e.target.dataset.kpiField;
      if (!id || !field) return;
      const k = state.step7.kpis.find((x) => x.id === id);
      if (!k) return;
      k[field] = e.target.value;
      saveState();
      renderStep7();
    });

  document
    .getElementById("s7-kpi-tbody")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-delete-kpi]");
      if (!btn) return;
      const id = btn.dataset.deleteKpi;
      state.step7.kpis = state.step7.kpis.filter((x) => x.id !== id);
      saveState();
      renderStep7();
    });

  document
    .getElementById("s7-process-notes")
    .addEventListener("input", (e) => {
      state.step7.processNotes = e.target.value;
      saveState();
    });

  document.getElementById("btn-s7-import").addEventListener("click", () => {
    state.step7.kpis = state.step7.kpis.filter(
      (k) => k.category !== "ç›®æ ‡æ€§æŒ‡æ ‡"
    );
    state.step3.keyProblems.forEach((kp) => {
      state.step7.kpis.push({
        id: uuid(),
        category: "ç›®æ ‡æ€§æŒ‡æ ‡",
        refKeyProblemId: kp.id,
        label: kp.sourceText + " / " + (kp.kpiName || ""),
        before: kp.currentValue || "",
        target: kp.targetValue || "",
        after: "",
        improvePercent: "",
      });
    });
    saveState();
    renderStep7();
  });

  // --------------- Step8 æ¸²æŸ“ & äº‹ä»¶ -----------------
  function renderStep8() {
    const tbody = document.getElementById("s8-std-tbody");
    tbody.innerHTML = "";
    state.step8.standards.forEach((s, idx) => {
      tbody.innerHTML += `
        <tr>
          <td>${idx + 1}</td>
          <td><textarea data-std-id="${s.id}" data-std-field="title">${
        s.title || ""
      }</textarea></td>
          <td><input data-std-id="${s.id}" data-std-field="owner" value="${
        s.owner || ""
      }"/></td>
          <td><input type="date" data-std-id="${s.id}" data-std-field="due" value="${
        s.due || ""
      }"/></td>
          <td><input type="number" min="0" max="100" data-std-id="${
            s.id
          }" data-std-field="progress" value="${s.progress || ""}"/></td>
          <td class="text-right"><button class="btn" data-delete-std="${
            s.id
          }">âœ•</button></td>
        </tr>
      `;
    });

    document.getElementById("s8-retro").value = state.step8.retro || "";
  }

  document.getElementById("btn-s8-add-std").addEventListener("click", () => {
    state.step8.standards.push({
      id: uuid(),
      title: "",
      owner: "",
      due: "",
      progress: "",
    });
    saveState();
    renderStep8();
  });

  document
    .getElementById("s8-std-tbody")
    .addEventListener("input", (e) => {
      const id = e.target.dataset.stdId;
      const field = e.target.dataset.stdField;
      if (!id || !field) return;
      const s = state.step8.standards.find((x) => x.id === id);
      if (!s) return;
      s[field] = e.target.value;
      saveState();
    });

  document
    .getElementById("s8-std-tbody")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-delete-std]");
      if (!btn) return;
      const id = btn.dataset.deleteStd;
      state.step8.standards = state.step8.standards.filter(
        (x) => x.id !== id
      );
      saveState();
      renderStep8();
    });

  document.getElementById("s8-retro").addEventListener("input", (e) => {
    state.step8.retro = e.target.value;
    saveState();
  });

  // --------------- AI æ•™ç»ƒé€»è¾‘ -----------------
  const AI_ENDPOINT = "/api/deepseek-chat"; // ç”± Vercel ä»£ç†å®ç°
  const AI_MODEL = "deepseek-chat";

  const AI_PROMPTS = {
    step1: `
ä½ æ˜¯ä¸€åèµ„æ·±â€œé—®é¢˜åˆ†æä¸è§£å†³ï¼ˆ8æ­¥æ³•ï¼‰â€æ•™ç»ƒï¼Œç°åœ¨è¦ç‚¹è¯„å­¦å‘˜åœ¨ã€Step1 æ˜ç¡®é—®é¢˜ä¸ç›®æ ‡ã€‘ä¸­çš„å¡«å†™è´¨é‡ã€‚
æˆ‘ä¼šç»™ä½ ä¸€ä¸ª JSONï¼ŒåŒ…å«ï¼šç†æƒ³çŠ¶æ€ã€KPI ç›®æ ‡ã€å½“å‰ KPIã€KPI å·®è·æè¿°ã€å¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ã€ä»¥åŠ 5W2H ç°çŠ¶æè¿°ã€‚

è¯·å®Œæˆï¼š
1ï¼‰æ£€æŸ¥ 5W2H æ˜¯å¦å®Œæ•´ã€å…·ä½“ã€å¯åº¦é‡ï¼ŒæŒ‡å‡ºå“ªäº›é¡¹è¿‡äºæ¨¡ç³Šæˆ–ç¼ºå¤±ï¼›
2ï¼‰åˆ¤æ–­â€œå¤§è€Œæ¨¡ç³Šçš„é—®é¢˜â€ä¸ KPI å·®è·ã€5W2H ç°çŠ¶æ˜¯å¦é€»è¾‘ä¸€è‡´ï¼Œæ˜¯å¦çœŸçš„èšç„¦åœ¨ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ä¸Šï¼›
3ï¼‰ç»™å‡º 3~5 æ¡æ”¹è¿›å»ºè®®ï¼Œå¸®åŠ©å­¦å‘˜æŠŠé—®é¢˜é™ˆè¿°å¾—æ›´æ¸…æ™°ã€æ›´èšç„¦ï¼›
4ï¼‰ä¸ºä¸‹ä¸€æ­¥ã€åˆ†è§£é—®é¢˜ã€‘æç‚¼ä¸€æ¡æ¨èä½¿ç”¨çš„â€œæ€»é—®é¢˜å¥â€å’Œä¸€å¥â€œç®€çŸ­çš„ KPI å·®è·æè¿°â€ã€‚

è¯·ä¸¥æ ¼ç”¨ä¸‹é¢çš„ JSON è¿”å›ï¼Œä¸è¦åŠ è§£é‡Šæ–‡å­—ï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·ä¸å…³é”®æé†’",
  "checklist": ["è¦ç‚¹1","è¦ç‚¹2","è¦ç‚¹3"],
  "next_step": {
    "big_problem": "æ¨èçš„æ€»é—®é¢˜å¥",
    "kpi_gap_short": "ä¸€å¥è¯çš„ KPI å·®è·æ€»ç»“"
  }
}
    `,
    step2: `
ä½ æ˜¯â€œé—®é¢˜é€»è¾‘æ ‘åˆ†è§£â€ä¸“å®¶ï¼Œè¦ç‚¹è¯„å­¦å‘˜åœ¨ã€Step2 åˆ†è§£é—®é¢˜ã€‘ä¸­çš„è¡¨ç°ã€‚
æˆ‘ä¼šç»™ä½ ä¸€ä¸ª JSONï¼ŒåŒ…å«ï¼šStep1 çš„ç®€è¦ä¿¡æ¯ã€æ€»é—®é¢˜å¥ã€ä»¥åŠè‹¥å¹²å‡è®¾é—®é¢˜ï¼ˆå­—æ®µå«ï¼štextã€dimensionã€parentIdã€evidenceã€importanceã€urgencyã€isKeyï¼‰ã€‚

è¯·å®Œæˆï¼š
1ï¼‰åˆ¤æ–­è¿™äº›å‡è®¾é—®é¢˜æ˜¯å¦çœŸæ­£ä»¥â€œæ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜â€çš„å½¢å¼è¡¨è¾¾ï¼Œå¹¶ä¸”æ˜¯é—®é¢˜è€Œéè§£å†³æ–¹æ¡ˆï¼›
2ï¼‰è¯„ä¼°åˆ†è§£ç»´åº¦æ˜¯å¦æœ‰é€»è¾‘ï¼šæ˜¯å¦ä½“ç°ç»“æ„/æµç¨‹/æ—¶é—´/åŒºåŸŸ/å¯¹è±¡ç­‰æ¸…æ™°çš„åˆ’åˆ†ï¼Œæ˜¯å¦å­˜åœ¨é—æ¼æˆ–äº¤å‰ï¼›
3ï¼‰æ ¹æ®é‡è¦åº¦å’Œç´§æ€¥åº¦ï¼Œç»“åˆä½ çš„åˆ¤æ–­ï¼Œæ¨è 1~3 ä¸ªâ€œæ›´å€¼å¾—æ·±å…¥ç ”ç©¶çš„å…³é”®æ€§é—®é¢˜â€ï¼ˆå¼•ç”¨å…¶ idï¼‰ï¼›
4ï¼‰åŸºäº Step1 çš„ä¿¡æ¯ï¼Œè¡¥å…… 1~3 æ¡ä½ è®¤ä¸ºå¯èƒ½è¢«é—æ¼çš„é‡è¦å‡è®¾é—®é¢˜ï¼Œå¹¶è¯´æ˜è¦éªŒè¯è¿™äº›å‡è®¾éœ€è¦æ”¶é›†å“ªäº›æ•°æ®ã€‚

è¯·ä¸¥æ ¼ç”¨ä¸‹é¢çš„ JSON è¿”å›ï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·ä¸æé†’",
  "improvement_suggestions": ["å»ºè®®1","å»ºè®®2"],
  "suggested_key_hypothesis_ids": ["hypo-id-1","hypo-id-2"],
  "new_hypotheses": [
    {
      "text": "å»ºè®®æ–°å¢çš„å‡è®¾é—®é¢˜ï¼ˆæ˜¯å¦å­˜åœ¨â€¦â€¦é—®é¢˜ï¼‰",
      "dimension": "æ¨èçš„åˆ†è§£ç»´åº¦",
      "data_to_collect": "éœ€è¦æ”¶é›†å“ªäº›æ•°æ®æ¥éªŒè¯è¿™ä¸ªå‡è®¾"
    }
  ]
}
    `,
    step3: `
ä½ æ˜¯â€œç›®æ ‡è®¾å®šä¸ KPI è®¾è®¡â€ä¸“å®¶ï¼Œè¦ç‚¹è¯„ã€Step3 å…³é”®é—®é¢˜ç›®æ ‡è®¾å®šã€‘ã€‚
JSON ä¸­åŒ…å«å¤šä¸ª keyProblemsï¼šsourceTextï¼ˆå…³é”®é—®é¢˜ï¼‰ã€goalï¼ˆç›®æ ‡ï¼‰ã€kpiNameã€currentValueã€targetValueã€deadlineã€‚

ä»»åŠ¡ï¼š
1ï¼‰ç”¨ SMART åŸåˆ™æ£€æŸ¥æ¯ä¸€è¡Œç›®æ ‡æ˜¯å¦ï¼šå…·ä½“ã€å¯åº¦é‡ã€å¯è¾¾æˆã€ä¸ä¸Šä½ç›®æ ‡ä¸€è‡´ã€æœ‰æ—¶é—´è¾¹ç•Œï¼›
2ï¼‰æŒ‡å‡ºå“ªäº›ç›®æ ‡å­˜åœ¨ï¼šè¿‡äºæ¨¡ç³Šã€ä¸å¯æ§ã€ç›®æ ‡å€¼æˆ–æœŸé™ä¸åˆç†ç­‰é—®é¢˜ï¼›
3ï¼‰ç»™å‡º 3~5 æ¡æ•´ä½“æ”¹è¿›å»ºè®®ï¼›
4ï¼‰ä¸ºä¸‹ä¸€æ­¥åŸå› åˆ†ææä¾›ä¸€ä¸ªç®€æ´ç‰ˆâ€œæ ¹é—®é¢˜è¡¨è¿°åˆ—è¡¨â€ï¼Œæ¯æ¡åŒ…å« keyProblemId å’Œæ¨èè¡¨è¿°ã€‚

è¾“å‡º JSONï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·",
  "problem_items": [
    {
      "key_problem_id": "xxx",
      "issue": "è¯¥ç›®æ ‡å­˜åœ¨çš„é—®é¢˜è¯´æ˜"
    }
  ],
  "next_step": {
    "root_problems": [
      {
        "key_problem_id": "xxx",
        "statement": "æ¨èåœ¨åŸå› åˆ†æä¸­ä½¿ç”¨çš„æ ¹é—®é¢˜è¡¨è¿°"
      }
    ]
  }
}
    `,
    step4: `
ä½ æ˜¯â€œæ ¹æœ¬åŸå› åˆ†æï¼ˆ5WHY/é€»è¾‘æ ‘ï¼‰â€ä¸“å®¶ï¼Œè¦ç‚¹è¯„ã€Step4 åŸå› åˆ†æã€‘ã€‚
JSON ä¸­åŒ…å«ï¼šæ‰€é€‰å…³é”®é—®é¢˜ä¿¡æ¯ï¼Œä»¥åŠè¯¥é—®é¢˜ä¸‹çš„å¤šä¸ªåŸå› èŠ‚ç‚¹ causesï¼šå­—æ®µå« level(1-5)ã€parentIdã€textã€dataNeededã€evidenceã€‚

è¯·å®Œæˆï¼š
1ï¼‰æ£€æŸ¥åŸå› æ˜¯å¦çœŸæ­£è§£é‡Šäº†å…³é”®é—®é¢˜ï¼Œè€Œéç®€å•é‡å¤ç°è±¡æˆ–æŠŠå¯¹ç­–å½“åŸå› ï¼›
2ï¼‰åˆ¤æ–­åŸå› ä¹‹é—´çš„å› æœé“¾æ˜¯å¦åˆç†ï¼Œæœ‰æ— â€œè·³çº§â€æˆ–é€»è¾‘æ–­å±‚ï¼›
3ï¼‰ä»äºº/æœº/æ–™/æ³•/ç¯/æµ‹ç­‰ç»´åº¦çœ‹ï¼Œæ˜¯å¦æœ‰æ˜æ˜¾é—æ¼ï¼›
4ï¼‰æŒ‡å‡ºä½ è®¤ä¸ºæœ€å¯èƒ½çš„ 1~3 ä¸ªâ€œæ ¹æœ¬åŸå› â€ï¼ˆç»™å‡ºåŸå›  idï¼‰ï¼›
5ï¼‰ä¸ºä¸‹ä¸€æ­¥å¯¹ç­–åˆ¶å®šï¼Œç»™å‡ºé’ˆå¯¹æ¯ä¸ªæ ¹æœ¬åŸå› çš„å¯¹ç­–æ€è·¯æ–¹å‘ï¼ˆä¸æ˜¯å…·ä½“æ–¹æ¡ˆï¼Œè€Œæ˜¯æ–¹å‘ï¼‰ã€‚

è¾“å‡º JSONï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·",
  "root_cause_ids": ["cause-id-1","cause-id-2"],
  "dimension_gaps": ["å¯èƒ½ç¼ºå¤±çš„ç»´åº¦1","ç»´åº¦2"],
  "next_step": {
    "countermeasure_directions": [
      {
        "cause_id": "cause-id-1",
        "direction": "å¯¹ç­–æ–¹å‘æ–‡å­—"
      }
    ]
  }
}
    `,
    step5: `
ä½ æ˜¯â€œå¯¹ç­–è®¾è®¡ä¸è¯„ä¼°â€ä¸“å®¶ï¼Œè¦ç‚¹è¯„ã€Step5 å¯¹ç­–é€‰æ‹©ä¸è¯„ä¼°ã€‘ã€‚
JSON ä¸­åŒ…å«ï¼šå…³é”®é—®é¢˜ã€å¯¹åº”åŸå› ï¼Œä»¥åŠ plansï¼šdescã€controllableã€feasibleã€effectã€costã€‚

ä»»åŠ¡ï¼š
1ï¼‰æ£€æŸ¥å¯¹ç­–æ˜¯å¦ä¸€ä¸€å¯¹åº”åˆ°å…·ä½“åŸå› ï¼Œæ˜¯å¦æœ‰â€œå¤šå¤´ç®¡ç†â€â€œä¸€åˆ€åˆ‡â€ç­‰å…¸å‹é—®é¢˜ï¼›
2ï¼‰æ ¹æ®å››ä¸ªè¯„åˆ†åˆ¤æ–­å“ªäº›å¯¹ç­–æ›´å€¼å¾—ä¼˜å…ˆå®æ–½ï¼›
3ï¼‰æŒ‡å‡ºè¯„åˆ†å­˜åœ¨æ˜æ˜¾ä¸åˆç†æˆ–ç¼ºä¹ä¾æ®çš„åœ°æ–¹ï¼›
4ï¼‰ä¸º Step6 è¡ŒåŠ¨è®¡åˆ’æ¨èâ€œä¼˜å…ˆå®æ–½å¯¹ç­–åˆ—è¡¨â€ã€‚

è¾“å‡º JSONï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·",
  "priority_plans": [
    {
      "plan_id": "xxx",
      "reason": "æ¨èä¼˜å…ˆå®æ–½çš„åŸå› "
    }
  ],
  "risk_notes": ["é£é™©æç¤º1","é£é™©æç¤º2"]
}
    `,
    step6: `
ä½ æ˜¯â€œé¡¹ç›®æ‰§è¡Œä¸è¿›åº¦ç®¡ç†â€ä¸“å®¶ï¼Œè¦ç‚¹è¯„ã€Step6 è¡ŒåŠ¨è®¡åˆ’ & çœ‹æ¿ã€‘ã€‚
JSON ä¸­åŒ…å«å¤šä¸ª actionsï¼štaskã€ownerã€startã€endã€statusã€ä»¥åŠå…¶å¯¹åº”çš„å…³é”®é—®é¢˜å’Œå¯¹ç­–ä¿¡æ¯ã€‚

ä»»åŠ¡ï¼š
1ï¼‰æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ‹†åˆ†åˆ°è¶³å¤Ÿå…·ä½“ã€æ˜¯å¦å­˜åœ¨è´£ä»»æ¨¡ç³Šæˆ–æ—¶é—´å®‰æ’ä¸åˆç†çš„é—®é¢˜ï¼›
2ï¼‰æŒ‡å‡ºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„èµ„æºç“¶é¢ˆæˆ–ä¾èµ–å…³ç³»é£é™©ï¼›
3ï¼‰ç»™å‡º 3~5 æ¡æå‡æ‰§è¡ŒåŠ›çš„å»ºè®®ï¼Œç”¨äº Step7 è¿‡ç¨‹è¯„ä¼°çš„æç¤ºã€‚

è¾“å‡º JSONï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·",
  "risk_items": ["é£é™©1","é£é™©2"],
  "execution_tips": ["å»ºè®®1","å»ºè®®2","å»ºè®®3"]
}
    `,
    step7: `
ä½ æ˜¯â€œé¡¹ç›®ç»“æœè¯„ä¼°â€ä¸“å®¶ï¼Œè¦ç‚¹è¯„ã€Step7 è¿‡ç¨‹ & ç»“æœè¯„ä¼°ã€‘ã€‚
JSON ä¸­åŒ…å«å¤šæ¡ kpisï¼šcategoryã€labelã€beforeã€targetã€afterã€improvePercentï¼Œä»¥åŠè¿‡ç¨‹è®°å½• processNotesã€‚

ä»»åŠ¡ï¼š
1ï¼‰æ£€æŸ¥æ”¹å–„å‰/å/ç›®æ ‡ä¹‹é—´çš„å…³ç³»æ˜¯å¦åˆç†ï¼Œæ˜¯å¦å­˜åœ¨æ˜æ˜¾ç»Ÿè®¡åå·®æˆ–æ ·æœ¬åå·®é£é™©ï¼›
2ï¼‰æ€»ç»“é¡¹ç›®åœ¨ç»“æœä¸Šçš„äº®ç‚¹ä¸ä¸è¶³ï¼›
3ï¼‰æç‚¼ 3~5 æ¡å¯ä»¥å¤åˆ¶æ¨å¹¿çš„ç»éªŒï¼›
4ï¼‰ä¸º Step8 æ ‡å‡†åŒ–ç»™å‡ºâ€œæ¨èæ ‡å‡†åŒ–è¦ç‚¹åˆ—è¡¨â€ã€‚

è¾“å‡º JSONï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·",
  "highlights": ["äº®ç‚¹1","äº®ç‚¹2"],
  "shortcomings": ["ä¸è¶³1","ä¸è¶³2"],
  "replicable_points": ["å¯å¤åˆ¶è¦ç‚¹1","å¯å¤åˆ¶è¦ç‚¹2"],
  "next_step": {
    "standardization_points": ["å»ºè®®åˆ¶å®šæ ‡å‡†çš„ç‚¹1","ç‚¹2"]
  }
}
    `,
    step8: `
ä½ æ˜¯â€œç»„ç»‡å­¦ä¹ ä¸ä¸ªäººæˆé•¿â€æ•™ç»ƒï¼Œè¦ç‚¹è¯„ã€Step8 æ ‡å‡†åŒ– & å¤ç›˜ã€‘ã€‚
JSON ä¸­åŒ…å«ï¼šæ ‡å‡†åŒ–æ¡ç›®åˆ—è¡¨ standardsï¼ˆtitleã€ownerã€dueã€progressï¼‰ä»¥åŠä¸ªäººå¤ç›˜ retroï¼Œå¦å¤–ä¹Ÿä¼šé™„å¸¦å‰å‡ æ­¥çš„ç®€è¦æ‘˜è¦ã€‚

ä»»åŠ¡ï¼š
1ï¼‰åˆ¤æ–­æ ‡å‡†åŒ–æ¡ç›®æ˜¯å¦è¦†ç›–äº†æœ¬æ¬¡é¡¹ç›®ä¸­æœ€å…³é”®çš„åšæ³•å’Œç»éªŒï¼›
2ï¼‰ä»ä¸ªäººèƒ½åŠ›çš„è§’åº¦ï¼Œæ€»ç»“å­¦å‘˜åœ¨æœ¬æ¬¡é¡¹ç›®ä¸­çš„ä¼˜åŠ¿å’Œéœ€è¦æŒç»­æ‰“ç£¨çš„èƒ½åŠ›ç‚¹ï¼›
3ï¼‰ç»™å‡º 3~5 æ¡ä¸‹ä¸€è½®é¡¹ç›®å¯ä¼˜å…ˆå°è¯•çš„æ”¹è¿›æ–¹å‘ã€‚

è¾“å‡º JSONï¼š
{
  "coach_comment": "æ•´ä½“è¯„ä»·",
  "capability_insights": ["èƒ½åŠ›æ´å¯Ÿ1","èƒ½åŠ›æ´å¯Ÿ2"],
  "next_cycle_focus": ["ä¸‹è½®é¡¹ç›®å…³æ³¨ç‚¹1","å…³æ³¨ç‚¹2"]
}
    `,
  };

  async function callAI(stepKey, payload) {
    const statusEl = document.getElementById(`ai-${stepKey}-status`);
    const outputEl = document.getElementById(`ai-${stepKey}-output`);
    statusEl.textContent = "AI æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨ç­‰...";
    try {
      const body = {
        model: AI_MODEL,
        messages: [
          { role: "system", content: AI_PROMPTS[stepKey] },
          {
            role: "user",
            content:
              "ä¸‹é¢æ˜¯æœ¬æ­¥ä»¥åŠå‰åæ­¥éª¤çš„ç»“æ„åŒ–æ•°æ®ï¼ˆJSONï¼‰ï¼š\n" +
              JSON.stringify(payload, null, 2),
          },
        ],
        temperature: 0.2,
      };

      const res = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      const data = await res.json();
      const rawText =
        data.choices?.[0]?.message?.content || "AI è¿”å›ä¸ºç©ºï¼Œè¯·ç¨åé‡è¯•ã€‚";

      outputEl.textContent = rawText;
      statusEl.textContent = "AI åé¦ˆå·²ç”Ÿæˆã€‚";
      // å°è¯•è§£æ JSON ä¾›â€œæ¨é€åˆ°ä¸‹ä¸€æ­¥â€ä½¿ç”¨
      const parsed = parseJsonFromText(rawText);
      state.ai[stepKey] = parsed;
      saveState();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "è°ƒç”¨ AI å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç†æ¥å£æˆ–ç½‘ç»œã€‚";
    }
  }

  function parseJsonFromText(text) {
    if (!text) return null;
    let jsonStr = text.trim();
    const match = jsonStr.match(/```json([\s\S]*?)```/i);
    if (match) {
      jsonStr = match[1];
    }
    try {
      return JSON.parse(jsonStr);
    } catch (e) {
      return null;
    }
  }

  // Step1 AI
  document.getElementById("btn-ai-step1").addEventListener("click", () => {
    const payload = {
      step1: state.step1,
    };
    callAI("step1", payload);
  });

  document.getElementById("btn-ai-step1-apply").addEventListener("click", () => {
    const j = state.ai.step1;
    if (!j || !j.next_step) {
      alert("å°šæœªè·å¾—å¯è§£æçš„ AI JSON ç»“æœï¼Œè¯·å…ˆç‚¹å‡»â€œAI æ•™ç»ƒè¯„ä»·æœ¬æ­¥â€ã€‚");
      return;
    }
    if (j.next_step.big_problem) {
      state.step1.bigProblem = j.next_step.big_problem;
      document.getElementById("s1-big-problem").value = j.next_step.big_problem;
    }
    if (j.next_step.kpi_gap_short) {
      state.step1.gapShort = j.next_step.kpi_gap_short;
      document.getElementById("s1-gap-short").textContent =
        j.next_step.kpi_gap_short;
    }
    saveState();
    renderStep2();
    alert("å·²å°† AI æç‚¼çš„å¤§é—®é¢˜å’Œ KPI å·®è·æ›´æ–°åˆ° Step1ï¼Œå¹¶åŒæ­¥ç»™ Step2ã€‚");
  });

  // Step2 AI
  document.getElementById("btn-ai-step2").addEventListener("click", () => {
    const payload = {
      step1: state.step1,
      step2: state.step2,
    };
    callAI("step2", payload);
  });

  document.getElementById("btn-ai-step2-apply").addEventListener("click", () => {
    const j = state.ai.step2;
    if (!j) {
      alert("å°šæœªè·å¾—å¯è§£æçš„ AI JSON ç»“æœã€‚");
      return;
    }
    // æ ‡è®°æ¨èçš„å…³é”®é—®é¢˜
    if (Array.isArray(j.suggested_key_hypothesis_ids)) {
      state.step2.hypotheses.forEach((h) => {
        if (j.suggested_key_hypothesis_ids.includes(h.id)) {
          h.isKey = true;
        }
      });
    }
    // æ–°å¢ AI å»ºè®®çš„å‡è®¾é—®é¢˜
    if (Array.isArray(j.new_hypotheses)) {
      j.new_hypotheses.forEach((nh) => {
        if (!nh.text) return;
        state.step2.hypotheses.push({
          id: uuid(),
          text: nh.text,
          dimension: nh.dimension || "",
          parentId: "",
          evidence: "",
          importance: 3,
          urgency: 3,
          isKey: false,
        });
      });
    }
    saveState();
    renderStep2();
    alert("å·²æŒ‰ AI å»ºè®®æ›´æ–°å…³é”®æ€§é—®é¢˜æ ‡è®°ï¼Œå¹¶è¡¥å……æ–°çš„å‡è®¾é—®é¢˜ã€‚");
  });

  // Step3 AI
  document.getElementById("btn-ai-step3").addEventListener("click", () => {
    const payload = {
      step1: state.step1,
      step2: state.step2,
      step3: state.step3,
    };
    callAI("step3", payload);
  });

  document.getElementById("btn-ai-step3-apply").addEventListener("click", () => {
    const j = state.ai.step3;
    if (!j || !j.next_step || !Array.isArray(j.next_step.root_problems)) {
      alert("AI ç»“æœä¸­æ²¡æœ‰å¯ç”¨çš„ root_problemsã€‚");
      return;
    }
    // æš‚æ—¶åªå°† root_problems ä¿¡æ¯è®°å½•åˆ° keyProblems.goal ä¸­ï¼ˆä¸è¦†ç›–å·²æœ‰å†…å®¹ï¼‰
    j.next_step.root_problems.forEach((rp) => {
      const kp = state.step3.keyProblems.find(
        (k) => k.id === rp.key_problem_id
      );
      if (kp && !kp.goal && rp.statement) {
        kp.goal = rp.statement;
      }
    });
    saveState();
    renderStep3();
    alert("å·²å°† AI æ¨èçš„æ ¹é—®é¢˜è¡¨è¿°å†™å…¥å¯¹åº”å…³é”®é—®é¢˜çš„ç›®æ ‡æè¿°ä¸­ã€‚");
  });

  // Step4 AI
  document.getElementById("btn-ai-step4").addEventListener("click", () => {
    const payload = {
      step3: state.step3,
      step4: state.step4,
    };
    callAI("step4", payload);
  });

  document.getElementById("btn-ai-step4-apply").addEventListener("click", () => {
    const j = state.ai.step4;
    if (!j || !j.next_step) {
      alert("AI ç»“æœä¸­æ²¡æœ‰å¯ç”¨çš„ countermeasure_directionsã€‚");
      return;
    }
    // å°†å¯¹ç­–æ–¹å‘ä¿å­˜åˆ° step5.aiSuggestion ä¸­ï¼Œä¾›äººå·¥å‚è€ƒ
    state.step5.aiSuggestion = j.next_step.countermeasure_directions || [];
    saveState();
    alert("å·²å°† AI æ¨èçš„å¯¹ç­–æ–¹å‘è®°å½•åˆ° Step5ï¼Œå¯ç”¨äºè®¾è®¡å…·ä½“å¯¹ç­–ã€‚");
  });

  // Step5 AI
  document.getElementById("btn-ai-step5").addEventListener("click", () => {
    const payload = {
      step3: state.step3,
      step4: state.step4,
      step5: state.step5,
    };
    callAI("step5", payload);
  });

  document.getElementById("btn-ai-step5-apply").addEventListener("click", () => {
    const j = state.ai.step5;
    if (!j || !Array.isArray(j.priority_plans)) {
      alert("AI ç»“æœä¸­æ²¡æœ‰ priority_plansã€‚");
      return;
    }
    // ç›®å‰ä»…åœ¨æ§åˆ¶å°æç¤ºä¼˜å…ˆå¯¹ç­– idï¼Œå®é™…æ’åºä»ç”±ç”¨æˆ·å†³å®š
    console.log("AI æ¨èä¼˜å…ˆå¯¹ç­–ï¼š", j.priority_plans);
    alert("å·²è·å– AI å¯¹ä¼˜å…ˆå¯¹ç­–çš„å»ºè®®ï¼Œå¯ç»“åˆè¯„åˆ†åœ¨è¡¨æ ¼ä¸­è°ƒæ•´ã€‚");
  });

  // Step6 AI
  document.getElementById("btn-ai-step6").addEventListener("click", () => {
    const payload = {
      step5: state.step5,
      step6: state.step6,
    };
    callAI("step6", payload);
  });

  document.getElementById("btn-ai-step6-apply").addEventListener("click", () => {
    alert("AI å¯¹æ‰§è¡Œé£é™©ä¸èŠ‚å¥çš„å»ºè®®ä¸»è¦ç”¨äº Step7 è¿‡ç¨‹è¯„ä¼°ï¼Œå¯åœ¨ Step7 å¤ç›˜æ—¶å‚è€ƒã€‚");
  });

  // Step7 AI
  document.getElementById("btn-ai-step7").addEventListener("click", () => {
    const payload = {
      step3: state.step3,
      step6: state.step6,
      step7: state.step7,
    };
    callAI("step7", payload);
  });

  document.getElementById("btn-ai-step7-apply").addEventListener("click", () => {
    const j = state.ai.step7;
    if (!j || !j.next_step) {
      alert("AI ç»“æœä¸­æ²¡æœ‰ standardization_pointsã€‚");
      return;
    }
    if (Array.isArray(j.next_step.standardization_points)) {
      j.next_step.standardization_points.forEach((p) => {
        state.step8.standards.push({
          id: uuid(),
          title: p,
          owner: "",
          due: "",
          progress: "",
        });
      });
      saveState();
      renderStep8();
      alert("å·²æ ¹æ® AI å»ºè®®æ–°å¢è‹¥å¹²æ ‡å‡†åŒ–æ¡ç›®åˆ° Step8ã€‚");
    }
  });

  // Step8 AI
  document.getElementById("btn-ai-step8").addEventListener("click", () => {
    const payload = {
      step7: state.step7,
      step8: state.step8,
    };
    callAI("step8", payload);
  });

  // --------------- æŠ¥å‘Šç”Ÿæˆ & å¯¼å‡º -----------------
  function buildReport() {
    const box = document.getElementById("report-content");
    const s1 = state.step1;
    const s2 = state.step2;
    const s3 = state.step3;
    const s4 = state.step4;
    const s5 = state.step5;
    const s6 = state.step6;
    const s7 = state.step7;
    const s8 = state.step8;

    let html = "";

    html += `<div class="report-block">
      <h3>1. é—®é¢˜èƒŒæ™¯ä¸ç›®æ ‡</h3>
      <p><strong>ç†æƒ³çŠ¶æ€ï¼š</strong>${escapeHtml(s1.ideal || "")}</p>
      <p><strong>ç†æƒ³ KPIsï¼š</strong>${escapeHtml(s1.idealKPI || "")}</p>
      <p><strong>å½“å‰ KPIsï¼š</strong>${escapeHtml(s1.currentKPI || "")}</p>
      <p><strong>å·®è·è¯´æ˜ï¼š</strong>${escapeHtml(s1.gap || "")}</p>
      <p><strong>AI æç‚¼å·®è·ï¼š</strong>${escapeHtml(
        s1.gapShort || ""
      )}</p>
      <p><strong>å¤§è€Œæ¨¡ç³Šçš„é—®é¢˜ï¼š</strong>${escapeHtml(
        s1.bigProblem || ""
      )}</p>
    </div>`;

    html += `<div class="report-block">
      <h3>2. ç°çŠ¶ 5W2H æ‘˜è¦</h3>
      <p><strong>Whatï¼š</strong>${escapeHtml(s1.w.what || "")}</p>
      <p><strong>Whereï¼š</strong>${escapeHtml(s1.w.where || "")}</p>
      <p><strong>Whenï¼š</strong>${escapeHtml(s1.w.when || "")}</p>
      <p><strong>Whoï¼š</strong>${escapeHtml(s1.w.who || "")}</p>
      <p><strong>Whyï¼š</strong>${escapeHtml(s1.w.why || "")}</p>
      <p><strong>Howï¼š</strong>${escapeHtml(s1.w.how || "")}</p>
      <p><strong>How muchï¼š</strong>${escapeHtml(s1.w.howmuch || "")}</p>
    </div>`;

    html += `<div class="report-block">
      <h3>3. å‡è®¾é—®é¢˜åˆ†è§£ & å…³é”®é—®é¢˜</h3>
      <p>å…±æå‡ºå‡è®¾é—®é¢˜ ${s2.hypotheses.length} ä¸ªï¼Œå…¶ä¸­æ ‡è®°ä¸ºå…³é”®å€™é€‰çš„ ${
      s2.hypotheses.filter((h) => h.isKey).length
    } ä¸ªã€‚</p>
    </div>`;

    html += `<div class="report-block">
      <h3>4. å…³é”®æ€§é—®é¢˜ä¸ç›®æ ‡</h3>`;
    s3.keyProblems.forEach((kp, idx) => {
      html += `<p><strong>${idx + 1}. å…³é”®é—®é¢˜ï¼š</strong>${escapeHtml(
        kp.sourceText
      )}</p>
      <p class="small">ç›®æ ‡ï¼š${escapeHtml(
        kp.goal || ""
      )}ï¼›KPIï¼š${escapeHtml(kp.kpiName || "")}ï¼›å½“å‰å€¼ï¼š${escapeHtml(
        kp.currentValue || ""
      )}ï¼Œç›®æ ‡å€¼ï¼š${escapeHtml(kp.targetValue || "")}</p>`;
    });
    html += `</div>`;

    html += `<div class="report-block">
      <h3>5. åŸå› åˆ†ææ‘˜è¦</h3>`;
    state.step3.keyProblems.forEach((kp, idx) => {
      html += `<p><strong>${idx + 1}. å…³é”®é—®é¢˜ï¼š</strong>${escapeHtml(
        kp.sourceText
      )}</p>`;
      const causes = s4.causes.filter((c) => c.keyProblemId === kp.id);
      if (!causes.length) {
        html += `<p class="small danger-text">è¯¥å…³é”®é—®é¢˜æš‚æœªå¡«å†™åŸå› ã€‚</p>`;
      } else {
        causes
          .sort((a, b) => a.level - b.level)
          .forEach((c) => {
            html += `<p class="small">- Why${c.level}ï¼š${escapeHtml(
              c.text
            )}</p>`;
          });
      }
    });
    html += `</div>`;

    html += `<div class="report-block">
      <h3>6. å¯¹ç­–ä¸è¡ŒåŠ¨è®¡åˆ’æ¦‚è§ˆ</h3>
      <p>å¯¹ç­–æ•°ï¼š${s5.plans.length}ï¼›è¡ŒåŠ¨ä»»åŠ¡æ•°ï¼š${s6.actions.length}</p>
    </div>`;

    html += `<div class="report-block">
      <h3>7. ç»“æœè¯„ä¼°æ‘˜è¦</h3>`;
    s7.kpis.forEach((k, idx) => {
      html += `<p><strong>${idx + 1}. ${escapeHtml(
        k.label || ""
      )}</strong></p>
      <p class="small">æ”¹å–„å‰ï¼š${escapeHtml(k.before || "")}ï¼›ç›®æ ‡ï¼š${escapeHtml(
        k.target || ""
      )}ï¼›æ”¹å–„åï¼š${escapeHtml(k.after || "")}ï¼›æ”¹å–„ç‡ï¼š${escapeHtml(
        k.improvePercent ? k.improvePercent + "%" : ""
      )}</p>`;
    });
    html += `<p><strong>è¿‡ç¨‹å…³é”®å‘ç°ï¼š</strong>${escapeHtml(
      s7.processNotes || ""
    )}</p></div>`;

    html += `<div class="report-block">
      <h3>8. æ ‡å‡†åŒ–è¦ç‚¹ä¸ä¸ªäººå¤ç›˜</h3>`;
    s8.standards.forEach((s, idx) => {
      html += `<p><strong>${idx + 1}. æ ‡å‡†åŒ–å†…å®¹ï¼š</strong>${escapeHtml(
        s.title || ""
      )}ï¼ˆè´£ä»»äººï¼š${escapeHtml(s.owner || "")}ï¼Œè®¡åˆ’å®Œæˆï¼š${escapeHtml(
        s.due || ""
      )}ï¼‰</p>`;
    });
    html += `<p><strong>ä¸ªäººå¤ç›˜ï¼š</strong>${escapeHtml(
      s8.retro || ""
    )}</p></div>`;

    box.innerHTML = html;
  }

  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  document
    .getElementById("btn-report-refresh")
    .addEventListener("click", buildReport);

  document
    .getElementById("btn-generate-report")
    .addEventListener("click", () => {
      buildReport();
      document
        .querySelectorAll(".tab-header button")
        .forEach((b) =>
          b.classList.toggle("active", b.dataset.tab === "report")
        );
      document
        .querySelectorAll(".tab-panel")
        .forEach((p) => p.classList.toggle("active", p.id === "report"));
    });

  document
    .getElementById("btn-download-report")
    .addEventListener("click", () => {
      buildReport();
      const html =
        "<!DOCTYPE html><html><head><meta charset='utf-8'><title>é—®é¢˜åˆ†æä¸è§£å†³æŠ¥å‘Š</title></head><body>" +
        document.getElementById("report-content").innerHTML +
        "</body></html>";
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "é—®é¢˜åˆ†æä¸è§£å†³æŠ¥å‘Š.html";
      a.click();
      URL.revokeObjectURL(url);
    });

  // æ¸…ç©ºå…¨éƒ¨
  document.getElementById("btn-clear-all").addEventListener("click", () => {
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºæœ¬å·¥å…·ä¸­çš„å…¨éƒ¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
    state = structuredClone(defaultState);
    saveState();
    location.reload();
  });

  // åˆå§‹æ¸²æŸ“
  initStep1();
  renderStep2();
  renderStep3();
  renderStep4();
  renderStep5Selects();
  renderStep6Selects();
  renderStep7();
  renderStep8();
  buildReport();
</script>
</body>
</html>
